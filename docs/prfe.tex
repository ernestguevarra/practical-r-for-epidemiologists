% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  12pt,
  a4paper]{book}
\title{Practical R for Epidemiologists}
\author{Mark Myatt}
\date{2022-02-15}

\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={Practical R for Epidemiologists},
  pdfauthor={Mark Myatt},
  colorlinks=true,
  linkcolor={Maroon},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage[margin=2cm]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{booktabs}
\usepackage{color}
\usepackage{tcolorbox}
\usepackage{float}
\usepackage{setspace}

\onehalfspacing

\graphicspath{ {images/} }

\newenvironment{rmdremind}
  {\begin{tcolorbox}[width=\textwidth, 
                     colback = {white}, 
                     title = {\textbf{Remember}}, 
                     colbacktitle = lightgray,
                     coltitle = black]
  \begin{includegraphics}[scale = 1]{remind.png}
  \begin{itemize}}
  {\end{itemize}
  \end{includegraphics}
  \end{tcolorbox}}

\newenvironment{rmdnote}
  {\begin{tcolorbox}[width=\textwidth, 
                     colback = {white}, 
                     title = {\textbf{Note}}, 
                     colbacktitle = lightgray,
                     coltitle = black]
  \begin{includegraphics}[scale = 1]{pencil.png}}
  {\end{includegraphics}
  \end{tcolorbox}}
  
\newenvironment{rmdexercise}
  {\begin{tcolorbox}[width=\textwidth, 
                     colback = {white}, 
                     title = {\textbf{Exercise}}, 
                     colbacktitle = lightgray,
                     coltitle = black]
  \begin{includegraphics}[scale = 1]{exercise.png}}
  {\end{includegraphics}
  \end{tcolorbox}}
  
\newenvironment{rmdinfo}
  {\begin{tcolorbox}[width=\textwidth, 
                     colback = {white}, 
                     title = {\textbf{Info}}, 
                     colbacktitle = lightgray,
                     coltitle = black]
  \begin{includegraphics}[scale = 1]{info.png}}
  {\end{includegraphics}
  \end{tcolorbox}}  
  
\newenvironment{rmdwarning}
  {\begin{tcolorbox}[width=\textwidth, 
                     colback = {white}, 
                     title = {\textbf{Warning}}, 
                     colbacktitle = lightgray,
                     coltitle = black]
  \begin{includegraphics}[scale = 1]{warning.png}}
  {\end{includegraphics}
  \end{tcolorbox}}

\newenvironment{rmddownload}
  {\begin{tcolorbox}[width=\textwidth, 
                     colback = {white}, 
                     title = {\textbf{Download}}, 
                     colbacktitle = lightgray,
                     coltitle = black]
  \begin{includegraphics}[scale = 1]{download.png}}
  {\end{includegraphics}
  \end{tcolorbox}}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage[]{natbib}
\bibliographystyle{apalike}

\begin{document}
\maketitle

{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{1}
\tableofcontents
}
\hypertarget{welcome}{%
\chapter*{Welcome}\label{welcome}}
\addcontentsline{toc}{chapter}{Welcome}

\includegraphics{images/bookcover.jpg}

This is the website for \emph{Practical R for Epidemiologists}. Visit the \href{https://github.com/ernestguevarra/practical-r-for-epidemiologists}{GitHub repository for this site} or buy it as a \href{https://www.amazon.co.uk/Practical-R-Epidemiologists-Mark-Myatt-ebook/dp/B00DQATKIE/ref=sr_1_1?ie=UTF8\&qid=1524423427\&sr=8-1\&keywords=practical+r+for+epidemiologists}{Kindle ebook on Amazon}.

\hypertarget{introduction}{%
\chapter*{Introduction}\label{introduction}}
\addcontentsline{toc}{chapter}{Introduction}

These notes are intended as a practical introduction to using the \texttt{R} environment for data analysis and graphics to work with epidemiological data. Topics covered include univariate statistics, simple statistical inference, charting data, two-by-two tables, stratified analysis, chi-square test for trend, logistic regression, survival analysis, computer-intensive methods, and extending \texttt{R} using user-provided functions. You should be able to follow the material if you are reasonably familiar with the mechanics of statistical estimation (e.g.~calculation of odds ratios and confidence intervals) and require a system that can perform simple or complex analyses to your exact specifications.

These notes are split into ten sections:

~

\textbf{Introduction}: You are reading this section now!

~

\textbf{Introducing R}: Some information about the \texttt{R} system, the way the \texttt{R} system works, how to get a copy of \texttt{R}, and how to start \texttt{R}.

~

\textbf{Exercise 1}: Read a dataset, producing descriptive statistics, charts, and perform simple statistical inference. The aim of the exercise is for you to become familiar with \texttt{R} and some basic \texttt{R} functions and objects.

~

\textbf{Exercise 2}: In this exercise we explore how to manipulate \texttt{R} objects and how to write functions that can manipulate and extract data and information from \texttt{R} objects and produce useful analyses.

~

\textbf{Exercise 3}: In this exercise we explore how \texttt{R} handles generalised linear models using the example of logistic regression as well as seeing how \texttt{R} can perform stratified (i.e.~Mantel-Haenszel) analysis as well as analysing data arising from matched case-control studies.

~

\textbf{Exercise 4}: In this exercise we use \texttt{R} to analyse a small dataset using the methods introduced in the previous exercises.

~

\textbf{Exercise 5}: In this exercise we explore how \texttt{R} can be extended using add-in packages. Specifically, we will use an add-in package to perform a survival analysis.

~

\textbf{Exercise 6}: In this exercise we explore how to make your own \texttt{R} functions behave like \texttt{R} objects so that they return a data-structure that can be manipulated or interrogated by other \texttt{R} functions.

~

\textbf{Exercise 7}: In this exercise we explore how you can use \texttt{R} to produce custom graphical functions.

~

\textbf{Exercise 8}: In this exercise we explore some more graphical functions and create custom graphical functions that produce two variable plots, pyramid charts, Pareto charts, charts with error bars, and simple mesh-maps.

~

\textbf{Exercise 9}: In this exercise we explore ways of implementing computer-intensive methods, such as the bootstrap and computer based simulation, using standard \texttt{R} functions.

~

If you are interested in a system that is flexible, can be tailored to produce exactly the analysis you want, provides modern analytical facilities, and have a basic understanding of the mechanics of hypothesis testing and estimation then you should consider following this material.

\hypertarget{introducing-r}{%
\chapter*{Introducing R}\label{introducing-r}}
\addcontentsline{toc}{chapter}{Introducing R}

\texttt{R} is a system for data manipulation, calculation, and graphics. It provides:

\begin{itemize}
\item
  Facilities for data handling and storage
\item
  A large collection of tools for data analysis
\item
  Graphical facilities for data analysis and display
\item
  A simple but powerful programming language
\end{itemize}

\texttt{R} is often described as an environment for working with data. This is in contrast to a \emph{package} which is a collection of very specific tools. \texttt{R} is not strictly a statistics system but a system that provides many classical and modern statistical procedures as part of a broader data-analysis tool. This is an important difference between \texttt{R} and other statistical systems. In \texttt{R} a statistical analysis is usually performed as a series of steps with intermediate results being stored in objects. Systems such as \texttt{SPSS} and \texttt{SAS} provide copious output from (e.g.) a regression analysis whereas \texttt{R} will give minimal output and store the results of a fit for subsequent interrogation or use with other \texttt{R} functions. This means that \texttt{R} can be tailored to produce exactly the analysis and results that you want rather than produce an analysis designed to fit all situations.

\texttt{R} is a language based product. This means that you interact with \texttt{R} by typing commands such as:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(SEX, LIFE)}
\end{Highlighting}
\end{Shaded}

~

rather than by using menus, dialog boxes, selection lists, and buttons. This may seem to be a drawback but it means that the system is considerably more flexible than one that relies on menus, buttons, and boxes. It also means that every stage of your data management and analysis can be recorded and edited and re-run at a later date. It also provides an audit trail for quality control purposes.

\texttt{R} is available under UNIX (including Linux), the Macintosh operating system OS X, and Microsoft Windows. The method used for starting \texttt{R} will vary from system to system. On UNIX systems you may need to issue the \texttt{R} command in a terminal session or click on an icon or menu option if your system has a windowing system. On Macintosh systems \texttt{R} will be available as an application but can also be run in a terminal session. On Microsoft Windows systems there will usually be an icon on the Start menu or the desktop.

\texttt{R} is an open source system and is available under the \emph{GNU general public license} (GPL) which means that it is available for free but that there are some restrictions on how you are allowed to distribute the system and how you may charge for bespoke data analysis solutions written using the \texttt{R} system. Details of the general public license are available from \url{http://www.gnu.org/copyleft/gpl.html}.

\texttt{R} is available for download from \url{http://www.r-project.org/}.

This is also the best place to get extension packages and documentation. You may also subscribe to the \texttt{R} mailing lists from this site. \texttt{R} is supported through mailing lists. The level of support is at least as good as for commercial packages. It is typical to have queries answered in a matter of a few hours.

Even though \texttt{R} is a free package it is more powerful than most commercial packages. Many of the modern procedures found in commercial packages were first developed and tested using \texttt{R} or \textbf{S-Plus} (the commercial equivalent of \texttt{R}).

When you start \texttt{R} it will issue a prompt when it expects user input. The default prompt is:

~

\begin{Shaded}
\begin{Highlighting}[]
\SpecialCharTok{\textgreater{}}
\end{Highlighting}
\end{Shaded}

~

This is where you type commands that call functions that instruct \texttt{R} to (e.g.) read a data file, recode data, produce a table, or fit a regression. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\SpecialCharTok{\textgreater{}} \FunctionTok{table}\NormalTok{(SEX, LIFE)}
\end{Highlighting}
\end{Shaded}

~

If a command you type is not complete then the prompt will change to:

~

\begin{Shaded}
\begin{Highlighting}[]
\SpecialCharTok{+}
\end{Highlighting}
\end{Shaded}

\newpage

on subsequent lines until the command is complete:

~

\begin{Shaded}
\begin{Highlighting}[]
\SpecialCharTok{\textgreater{}} \FunctionTok{table}\NormalTok{(}
\SpecialCharTok{+}\NormalTok{ SEX, LIFE }\SpecialCharTok{+}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

The \texttt{\textgreater{}} and \texttt{+} prompts are not shown in the example commands in the rest of this material.

The example commands in this material are often broken into shorter lines and indented for ease of understanding. The code still works as lines are split in places where \texttt{R} knows that a line is not complete. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(SEX,}
\NormalTok{      LIFE)}
\end{Highlighting}
\end{Shaded}

~

could be entered on a single line as:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(SEX, LIFE)}
\end{Highlighting}
\end{Shaded}

~

In this example \texttt{R} knows that the command is not complete until the brackets are closed. The following example could also be written on one line:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex.lreg.coeffs }\OtherTok{\textless{}{-}}
  \FunctionTok{coef}\NormalTok{(}\FunctionTok{summary}\NormalTok{(salex.lreg))}
\end{Highlighting}
\end{Shaded}

~

In this case \texttt{R} knows that the \texttt{\textless{}-} operator at the end of the first line needs further input.

\texttt{R} maintains a history of previous commands. These can be recalled and edited using the up and down arrow
keys.

Output that has scrolled off the top of the output / command window can be recalled using the window or terminal scroll bars.

Output can be saved using the \texttt{sink()} function with a file name: \texttt{sink("results.out")} to start recording output. Use the \texttt{sink()} function without a file name to stop recording output: \texttt{sink()}

You can also use clipboard functions such as copy and paste to (e.g.) copy and then paste selected chunks of output into an editor or word processor running alongside \texttt{R}.

All the sample data files used in the exercises in this manual are space delimited text files using the general
format:

~

\begin{verbatim}
   ID AGE IQ
   1 39 94
   2 41 89
   3 42 83
   4 30 99
   5 35 94
   6 44 90
   7 31 94
   8 39 87
\end{verbatim}

~

\texttt{R} has facilities for working with files in different formats including (through the use of extension packages) \textbf{ODBC} (open database connectivity) and \textbf{SQL} data sources, \textbf{EpiInfo}, \textbf{EpiData}, \textbf{Minitab}, \textbf{SPSS}, \textbf{SAS}, \textbf{S-Plus}, and \textbf{Stata} format files.

\newpage

\hypertarget{retrieving-data}{%
\section*{Retrieving data}\label{retrieving-data}}
\addcontentsline{toc}{section}{Retrieving data}

All of the exercises in this manual assume that the necessary data files are located in the current working directory.
All of the data files that you require to follow this material are in a ZIP archive that can be downloaded from \url{https://github.com/ernestguevarra/practical-r-for-epidemiologists/raw/master/data/prfe.zip}.

A command such as:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{read.table}\NormalTok{(}\StringTok{"data/fem.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

retrieves the data stored in the file named \texttt{fem.dat} which is stored in the current working directory.

To retrieve data that is stored in files outside a different directory you need to specify the full path to the file. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{read.table}\NormalTok{(}\StringTok{"\textasciitilde{}/prfe/fem.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

will retrieve the data stored in the file named \texttt{fem.dat} stored in the \texttt{prfe} directory under the user's home directory on UNIX, Linux, and OS X systems.

\texttt{R} follows many UNIX operating and naming conventions including the use of the backslash (\texttt{\textbackslash{}}) character to specify special characters in strings (e.g.~using \texttt{\textbackslash{}n} to specify a new line in printed output). Windows uses the backslash (\texttt{\textbackslash{}}) character to separate directory and file names in paths. This means that Windows users need to escape any backslashes in file paths using an additional backslash character. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{read.table}\NormalTok{(}\StringTok{"c:}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{prfe}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{fem.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

will retrieve the data that is stored in the file named \texttt{fem.dat} which is stored in the \texttt{prfe} directory off the root directory of the \texttt{C:} drive. The Windows version of \texttt{R} also allows you to specify UNIX-style path names (i.e.~using the forward slash (\texttt{/}) character as a separator in file paths). For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{read.table}\NormalTok{(}\StringTok{"c:/prfe/fem.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

Path names may include shortcut characters such as:

~

\begin{longtable}[]{@{}cl@{}}
\toprule
\endhead
\texttt{.} & The current working directory \\
\texttt{..} & Up one level in the directory tree \\
\texttt{\textasciitilde{}} & The user's home directory (on UNIX-based systems) \\
\bottomrule
\end{longtable}

~

\texttt{R} also allows you to retrieve files from any location that may be represented by a standard \texttt{uniform\ resource\ locator\ (URL)} string. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{read.table}\NormalTok{(}\StringTok{"file://\textasciitilde{}/prfe/fem.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

will retrieve the data stored in the file named \texttt{fem.dat} stored in the \texttt{prfe} directory under the users home directory on UNIX-based systems.

All of the data files used in this section are stored in the \texttt{/prfe} directory Brixton Health's website. This means, for example, that you can use the \texttt{read.table()} function specifying \emph{``\url{https://github.com/ernestguevarra/practical-r-for-epidemiologists/blob/master/data/fem.dat}''} as the \texttt{URL} to retrieve the data that is stored in the file named \texttt{fem.dat} which is stored in the \texttt{data/} directory of this guide's GitHub repository.

\hypertarget{exercise1}{%
\chapter{Getting acquainted with R}\label{exercise1}}

In this exercise we will use \texttt{R} to read a dataset and produce some descriptive statistics, produce some charts, and perform some simple statistical inference. The aim of the exercise is for you to become familiar with \texttt{R} and some basic \texttt{R} functions and objects.

The first thing we will do, after starting \texttt{R}, is issue a command to retrieve an example dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"fem.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

This command illustrates some key things about the way \texttt{R} works.

We are instructing \texttt{R} to assign (using the \texttt{\textless{}-} operator) the output of the \texttt{read.table()} function to an object
called \texttt{fem}.

The \texttt{fem} object will contain the data held in the file \texttt{fem.dat} as an \texttt{R} data.frame object:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(fem)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "data.frame"
\end{verbatim}

\newpage

You can inspect the contents of the \texttt{fem} data.frame (or any other \texttt{R} object) just by typing its name:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   ID AGE IQ ANX DEP SLP SEX LIFE    WT
## 1  1  39 94   2   2   2   1    1  2.23
## 2  2  41 89   2   2   2   1    1  1.00
## 3  3  42 83   3   3   2   1    1  1.82
## 4  4  30 99   2   2   2   1    1 -1.18
## 5  5  35 94   2   1   1   1    2 -0.14
## 6  6  44 90  NA   1   2   2    2  0.41
\end{verbatim}

~

Note that the \texttt{fem} object is built from other objects. These are the named vectors (columns) in the dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(fem)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "ID"   "AGE"  "IQ"   "ANX"  "DEP"  "SLP"  "SEX"  "LIFE" "WT"
\end{verbatim}

~

The \texttt{{[}1{]}} displayed before the column names refers to the numbered position of the first name in the output. These positions are known as indexes and can be used to refer to individual items. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(fem)[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "ID"
\end{verbatim}

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(fem)[}\DecValTok{8}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "LIFE"
\end{verbatim}

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(fem)[}\DecValTok{2}\SpecialCharTok{:}\DecValTok{4}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "AGE" "IQ"  "ANX"
\end{verbatim}

\newpage

The data consist of 118 records:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nrow}\NormalTok{(fem)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 118
\end{verbatim}

~

each with nine variables:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ncol}\NormalTok{(fem)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 9
\end{verbatim}

~

for female psychiatric patients.

~

The columns in the dataset are:

~

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.15}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.74}}@{}}
\toprule
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{ID}
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Patient ID
\end{minipage} \\
\midrule
\endhead
\textbf{AGE} & Age in years \\
\textbf{IQ} & IQ score \\
\textbf{ANX} & Anxiety (1=none, 2=mild, 3=moderate, 4=severe) \\
\textbf{DEP} & Depression (1=none, 2=mild, 3=moderate or severe) \\
\textbf{SLP} & Sleeping normally (1=yes, 2=no) \\
\textbf{SEX} & Lost interest in sex (1=yes, 2=no) \\
\textbf{LIFE} & Considered suicide (1=yes, 2=no) \\
\textbf{WT} & Weight change (kg) in previous 6 months \\
\bottomrule
\end{longtable}

\newpage

The first ten records of the \texttt{fem} data.frame are:

~

\begin{verbatim}
##    ID AGE  IQ ANX DEP SLP SEX LIFE    WT
## 1   1  39  94   2   2   2   1    1  2.23
## 2   2  41  89   2   2   2   1    1  1.00
## 3   3  42  83   3   3   2   1    1  1.82
## 4   4  30  99   2   2   2   1    1 -1.18
## 5   5  35  94   2   1   1   1    2 -0.14
## 6   6  44  90  NA   1   2   2    2  0.41
## 7   7  31  94   2   2  NA   1    1 -0.68
## 8   8  39  87   3   2   2   1    2  1.59
## 9   9  35 -99   3   2   2   1    1 -0.55
## 10 10  33  92   2   2   2   1    1  0.36
\end{verbatim}

~

You may check this by asking \texttt{R} to display all columns of the first ten records in the \texttt{fem} data.frame:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    ID AGE  IQ ANX DEP SLP SEX LIFE    WT
## 1   1  39  94   2   2   2   1    1  2.23
## 2   2  41  89   2   2   2   1    1  1.00
## 3   3  42  83   3   3   2   1    1  1.82
## 4   4  30  99   2   2   2   1    1 -1.18
## 5   5  35  94   2   1   1   1    2 -0.14
## 6   6  44  90  NA   1   2   2    2  0.41
## 7   7  31  94   2   2  NA   1    1 -0.68
## 8   8  39  87   3   2   2   1    2  1.59
## 9   9  35 -99   3   2   2   1    1 -0.55
## 10 10  33  92   2   2   2   1    1  0.36
\end{verbatim}

\newpage

The space after the comma is optional. You can think of it as a \emph{placeholder} for where you would specify the indexes for columns you wanted to display. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{,}\DecValTok{2}\SpecialCharTok{:}\DecValTok{4}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

~

displays the first ten rows and the second, third and fourth columns of the \texttt{fem} data.frame:

~

\begin{verbatim}
##    AGE  IQ ANX
## 1   39  94   2
## 2   41  89   2
## 3   42  83   3
## 4   30  99   2
## 5   35  94   2
## 6   44  90  NA
## 7   31  94   2
## 8   39  87   3
## 9   35 -99   3
## 10  33  92   2
\end{verbatim}

~

\texttt{NA} is a special value meaning \emph{not available} or \emph{missing}.

You can access the contents of a single column by name:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem}\SpecialCharTok{$}\NormalTok{IQ}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1]  94  89  83  99  94  90  94  87 -99  92  92  94  91  86  90 -99  91  82
##  [19]  86  88  97  96  95  87 103 -99  91  87  91  89  92  84  94  92  96  96
##  [37]  86  92 102  82  92  90  92  88  98  93  90  91 -99  92  92  91  91  86
##  [55]  95  91  96 100  99  89  89  98  98 103  91  91  94  91  85  92  96  90
##  [73]  87  95  95  87  95  88  94 -99 -99  87  92  86  93  92 106  93  95  95
##  [91]  92  98  92  88  85  92  84  92  91  86  92  89 -99  96  97  92  92  98
## [109]  91  91  89  94  90  96  87  86  89 -99
\end{verbatim}

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem}\SpecialCharTok{$}\NormalTok{IQ[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  94  89  83  99  94  90  94  87 -99  92
\end{verbatim}

\newpage

The \texttt{\$} sign is used to separate the name of the data.frame and the name of the column of interest. Note that \texttt{R} is case-sensitive so that \texttt{IQ} and \texttt{iq} are \textbf{\emph{not}} the same.

You can also access rows, columns, and individual cells by specifying row and column positions. For example, the \texttt{IQ} column is the third column in the \texttt{fem} data.frame:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem[ ,}\DecValTok{3}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1]  94  89  83  99  94  90  94  87 -99  92  92  94  91  86  90 -99  91  82
##  [19]  86  88  97  96  95  87 103 -99  91  87  91  89  92  84  94  92  96  96
##  [37]  86  92 102  82  92  90  92  88  98  93  90  91 -99  92  92  91  91  86
##  [55]  95  91  96 100  99  89  89  98  98 103  91  91  94  91  85  92  96  90
##  [73]  87  95  95  87  95  88  94 -99 -99  87  92  86  93  92 106  93  95  95
##  [91]  92  98  92  88  85  92  84  92  91  86  92  89 -99  96  97  92  92  98
## [109]  91  91  89  94  90  96  87  86  89 -99
\end{verbatim}

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem[}\DecValTok{9}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   ID AGE  IQ ANX DEP SLP SEX LIFE    WT
## 9  9  35 -99   3   2   2   1    1 -0.55
\end{verbatim}

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem[}\DecValTok{9}\NormalTok{,}\DecValTok{3}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -99
\end{verbatim}

~

There are missing values in the \texttt{IQ} column which are all coded as \textbf{-99}. Before proceeding we must set these to
the special \texttt{NA} value:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem}\SpecialCharTok{$}\NormalTok{IQ[fem}\SpecialCharTok{$}\NormalTok{IQ }\SpecialCharTok{==} \SpecialCharTok{{-}}\DecValTok{99}\NormalTok{] }\OtherTok{\textless{}{-}} \ConstantTok{NA}
\end{Highlighting}
\end{Shaded}

~

The term inside the square brackets is also an index. This type of index is used to refer to subsets of data held in an object that meet a particular condition. In this case we are instructing \texttt{R} to set the contents of the \texttt{IQ} variable to \texttt{NA} if the contents of the \texttt{IQ} variable is \textbf{-99}.

\newpage

Check that this has worked:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem}\SpecialCharTok{$}\NormalTok{IQ}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   [1]  94  89  83  99  94  90  94  87  NA  92  92  94  91  86  90  NA  91  82
##  [19]  86  88  97  96  95  87 103  NA  91  87  91  89  92  84  94  92  96  96
##  [37]  86  92 102  82  92  90  92  88  98  93  90  91  NA  92  92  91  91  86
##  [55]  95  91  96 100  99  89  89  98  98 103  91  91  94  91  85  92  96  90
##  [73]  87  95  95  87  95  88  94  NA  NA  87  92  86  93  92 106  93  95  95
##  [91]  92  98  92  88  85  92  84  92  91  86  92  89  NA  96  97  92  92  98
## [109]  91  91  89  94  90  96  87  86  89  NA
\end{verbatim}

~

We can now compare the groups who have and have not considered suicide. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(fem}\SpecialCharTok{$}\NormalTok{IQ, fem}\SpecialCharTok{$}\NormalTok{LIFE, summary)}
\end{Highlighting}
\end{Shaded}

~

Look at the help for the \texttt{by()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{help}\NormalTok{(by)}
\end{Highlighting}
\end{Shaded}

~

Note that you may use \texttt{?by} as a shortcut for \texttt{help(by)}.

The \texttt{by()} function applies another function (in this case the \texttt{summary()} function) to a column in a
data.frame (in this case \texttt{fem\$IQ}) split by the value of another variable (in this case \texttt{fem\$LIFE}).

It can be tedious to always have to specify a data.frame each time we want to use a particular variable. We can
fix this problem by `attaching' the data.frame:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{attach}\NormalTok{(fem)}
\end{Highlighting}
\end{Shaded}

~

We can now refer to the columns in the \texttt{fem} data.frame without having to specify the name of the data.frame. This time we will produce summary statistics for \texttt{WT} by \texttt{LIFE}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(WT, LIFE, summary)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## LIFE: 1
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
## -2.2300 -0.2700  1.0000  0.7867  1.7300  3.7700       4 
## ------------------------------------------------------------ 
## LIFE: 2
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
## -1.6800 -0.4500  0.6400  0.6404  1.5000  2.9500       7
\end{verbatim}

~

We can view the same data as a box and whisker plot:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{boxplot}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ LIFE)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-55-1} \end{center}

\newpage

We can add axis labels and a title to the graph:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{boxplot}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ LIFE,}
        \AttributeTok{xlab =} \StringTok{"Life"}\NormalTok{,}
        \AttributeTok{ylab =} \StringTok{"Weight"}\NormalTok{,}
        \AttributeTok{main =} \StringTok{"Weight BY Life"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-56-1} \end{center}

~

A more descriptive title might be ``Weight Change BY Considered Suicide''.

The groups do not seem to differ much in their medians and the distributions appear to be reasonably symmetrical about their medians with a similar spread of values.

\newpage

We can look at the distribution as histograms:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hist}\NormalTok{(WT[LIFE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-57-1} \end{center}

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{hist}\NormalTok{(WT[LIFE }\SpecialCharTok{==} \DecValTok{2}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-58-1} \end{center}

\newpage

and check the assumption of normality using quantile-quantile plots:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{qqnorm}\NormalTok{(WT[LIFE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{])}
\FunctionTok{qqline}\NormalTok{(WT[LIFE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-59-1} \end{center}

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{qqnorm}\NormalTok{(WT[LIFE }\SpecialCharTok{==} \DecValTok{2}\NormalTok{])}
\FunctionTok{qqline}\NormalTok{(WT[LIFE }\SpecialCharTok{==} \DecValTok{2}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-60-1} \end{center}

\newpage

or by using a formal test:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{shapiro.test}\NormalTok{(WT[LIFE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Shapiro-Wilk normality test
## 
## data:  WT[LIFE == 1]
## W = 0.98038, p-value = 0.4336
\end{verbatim}

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{shapiro.test}\NormalTok{(WT[LIFE }\SpecialCharTok{==} \DecValTok{2}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Shapiro-Wilk normality test
## 
## data:  WT[LIFE == 2]
## W = 0.97155, p-value = 0.3292
\end{verbatim}

~

Remember that we can use the \texttt{by()} function to apply a function to a data.frame, including statistical functions such as \texttt{shapiro.test()}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(WT, LIFE, shapiro.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## LIFE: 1
## 
##  Shapiro-Wilk normality test
## 
## data:  dd[x, ]
## W = 0.98038, p-value = 0.4336
## 
## ------------------------------------------------------------ 
## LIFE: 2
## 
##  Shapiro-Wilk normality test
## 
## data:  dd[x, ]
## W = 0.97155, p-value = 0.3292
\end{verbatim}

\newpage

We can also test whether the variances differ significantly using \emph{Bartlett's test} for the homogeneity of variances:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{bartlett.test}\NormalTok{(WT, LIFE)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Bartlett test of homogeneity of variances
## 
## data:  WT and LIFE
## Bartlett's K-squared = 0.32408, df = 1, p-value = 0.5692
\end{verbatim}

~

There is no significant difference between the two variances.

Many functions in \texttt{R} have a \emph{formula interface} that may be used to specify multiple variables and the relations between multiple variables. We could have used the formula interface with the \texttt{bartlett.test()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{bartlett.test}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ LIFE)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Bartlett test of homogeneity of variances
## 
## data:  WT by LIFE
## Bartlett's K-squared = 0.32408, df = 1, p-value = 0.5692
\end{verbatim}

~

Having checked the normality and homogeneity of variance assumptions we can proceed to carry out a \texttt{t-test}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{t.test}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ LIFE, }\AttributeTok{var.equal =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Two Sample t-test
## 
## data:  WT by LIFE
## t = 0.59869, df = 104, p-value = 0.5507
## alternative hypothesis: true difference in means between group 1 and group 2 is not equal to 0
## 95 percent confidence interval:
##  -0.3382365  0.6307902
## sample estimates:
## mean in group 1 mean in group 2 
##       0.7867213       0.6404444
\end{verbatim}

~

There is no evidence that the two groups differ in weight change in the previous six months.

We could still have performed a \texttt{t-test} if the variances were not homogenous by setting the \textbf{var.equal} parameter of the \texttt{t.test()} function to \textbf{FALSE}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{t.test}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ LIFE, }\AttributeTok{var.equal =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Welch Two Sample t-test
## 
## data:  WT by LIFE
## t = 0.60608, df = 98.866, p-value = 0.5459
## alternative hypothesis: true difference in means between group 1 and group 2 is not equal to 0
## 95 percent confidence interval:
##  -0.3326225  0.6251763
## sample estimates:
## mean in group 1 mean in group 2 
##       0.7867213       0.6404444
\end{verbatim}

~

or performed a non-parametric test:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{wilcox.test}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ LIFE)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Wilcoxon rank sum test with continuity correction
## 
## data:  WT by LIFE
## W = 1488, p-value = 0.4622
## alternative hypothesis: true location shift is not equal to 0
\end{verbatim}

\newpage

An alternative, and more general, non-parametric test is:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{kruskal.test}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ LIFE)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Kruskal-Wallis rank sum test
## 
## data:  WT by LIFE
## Kruskal-Wallis chi-squared = 0.54521, df = 1, p-value = 0.4603
\end{verbatim}

~

We can use the \texttt{table()} function to examine the differences in depression between the two groups:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(DEP, LIFE)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    LIFE
## DEP  1  2
##   1  0 26
##   2 42 24
##   3 16  1
\end{verbatim}

~

The two distributions look very different from each other. We can test this using a chi-square test on the table:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{chisq.test}\NormalTok{(}\FunctionTok{table}\NormalTok{(DEP, LIFE))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Pearson's Chi-squared test
## 
## data:  table(DEP, LIFE)
## X-squared = 43.876, df = 2, p-value = 2.968e-10
\end{verbatim}

\newpage

Note that we passed the output of the \texttt{table()} function directly to the \texttt{chisq.test()} function. We could have saved the table as an object first and then passed the object to the \texttt{chisq.test()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(DEP, LIFE)}
\FunctionTok{chisq.test}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Pearson's Chi-squared test
## 
## data:  tab
## X-squared = 43.876, df = 2, p-value = 2.968e-10
\end{verbatim}

~

The \texttt{tab} object contains the output of the \texttt{table()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "table"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    LIFE
## DEP  1  2
##   1  0 26
##   2 42 24
##   3 16  1
\end{verbatim}

~

We can pass this table object to another function. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fisher.test}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Fisher's Exact Test for Count Data
## 
## data:  tab
## p-value = 1.316e-12
## alternative hypothesis: two.sided
\end{verbatim}

~

When we are finished with the tab object we can delete it using the \texttt{rm()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

~

You can see a list of available objects using the \texttt{ls()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "fem"
\end{verbatim}

~

This should just show the \texttt{fem} object.

We can examine the association between loss of interest in sex and considering suicide in the same way:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(SEX, LIFE)}
\NormalTok{tab}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    LIFE
## SEX  1  2
##   1 58 38
##   2  5 12
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fisher.test}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Fisher's Exact Test for Count Data
## 
## data:  tab
## p-value = 0.03175
## alternative hypothesis: true odds ratio is not equal to 1
## 95 percent confidence interval:
##   1.080298 14.214482
## sample estimates:
## odds ratio 
##   3.620646
\end{verbatim}

\newpage

Note that with a two-by-two table the \texttt{fisher.test()} function produces an estimate of, and confidence intervals for, the odds ratio. Again, we will delete the \texttt{tab} object:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

~

We could have performed the Fisher exact test without creating the tab object by passing the output of the \texttt{table()} function directly to the \texttt{fisher.test()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fisher.test}\NormalTok{(}\FunctionTok{table}\NormalTok{(SEX, LIFE))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Fisher's Exact Test for Count Data
## 
## data:  table(SEX, LIFE)
## p-value = 0.03175
## alternative hypothesis: true odds ratio is not equal to 1
## 95 percent confidence interval:
##   1.080298 14.214482
## sample estimates:
## odds ratio 
##   3.620646
\end{verbatim}

~

Choose whichever method you find easiest but remember that it is easy to save the results of any function for later use.

We can explore the correlation between two variables using the \texttt{cor()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cor}\NormalTok{(IQ, WT, }\AttributeTok{use =} \StringTok{"pairwise.complete.obs"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] -0.2917158
\end{verbatim}

\newpage

or by using a scatter plot:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(IQ, WT)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-80-1} \end{center}

~

and by a formal test:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cor.test}\NormalTok{(IQ, WT)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Pearson's product-moment correlation
## 
## data:  IQ and WT
## t = -3.0192, df = 98, p-value = 0.003231
## alternative hypothesis: true correlation is not equal to 0
## 95 percent confidence interval:
##  -0.4616804 -0.1010899
## sample estimates:
##        cor 
## -0.2917158
\end{verbatim}

\newpage

With some functions you can pass an entire data.frame rather than a list of variables:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cor}\NormalTok{(fem, }\AttributeTok{use =} \StringTok{"pairwise.complete.obs"}\NormalTok{)}
\FunctionTok{pairs}\NormalTok{(fem)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##               ID         AGE            IQ         ANX           DEP
## ID    1.00000000  0.03069077  0.0370598672 -0.02941825 -0.0554147209
## AGE   0.03069077  1.00000000 -0.4345435680  0.06734300 -0.0387049246
## IQ    0.03705987 -0.43454357  1.0000000000 -0.02323787 -0.0001307404
## ANX  -0.02941825  0.06734300 -0.0232378691  1.00000000  0.5437946347
## DEP  -0.05541472 -0.03870492 -0.0001307404  0.54379463  1.0000000000
## SLP  -0.07268743  0.02606547  0.0812993104  0.22317875  0.5248724551
## SEX   0.08999634  0.10609216 -0.0536558660 -0.21062493 -0.3058422258
## LIFE -0.05604349 -0.10300193 -0.0915396469 -0.34211268 -0.6139017253
## WT    0.02640131  0.41574411 -0.2917157832  0.11817532  0.0233742465
##               SLP         SEX        LIFE           WT
## ID   -0.072687434  0.08999634 -0.05604349  0.026401310
## AGE   0.026065468  0.10609216 -0.10300193  0.415744109
## IQ    0.081299310 -0.05365587 -0.09153965 -0.291715783
## ANX   0.223178752 -0.21062493 -0.34211268  0.118175321
## DEP   0.524872455 -0.30584223 -0.61390173  0.023374247
## SLP   1.000000000 -0.29053971 -0.35186578 -0.009259774
## SEX  -0.290539709  1.00000000  0.22316967 -0.027826514
## LIFE -0.351865775  0.22316967  1.00000000 -0.058605326
## WT   -0.009259774 -0.02782651 -0.05860533  1.000000000
\end{verbatim}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-84-1} \end{center}

The output can be a little confusing particularly if it includes categorical or record identifying variables. To avoid this we can create a new object that contains only the columns we are interested in using the column binding \texttt{cbind()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{newfem }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(AGE, IQ, WT)}
\FunctionTok{cor}\NormalTok{(newfem, }\AttributeTok{use =} \StringTok{"pairwise.complete.obs"}\NormalTok{)}
\FunctionTok{pairs}\NormalTok{(newfem)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            AGE         IQ         WT
## AGE  1.0000000 -0.4345436  0.4157441
## IQ  -0.4345436  1.0000000 -0.2917158
## WT   0.4157441 -0.2917158  1.0000000
\end{verbatim}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-87-1} \end{center}

~

When we have finished with the \texttt{newfem} object we can delete it:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(newfem)}
\end{Highlighting}
\end{Shaded}

~

There was no real need to create the \texttt{newfem} object as we could have fed the output of the \texttt{cbind()} function directly to the \texttt{cor()} or \texttt{pairs()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cor}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(AGE, IQ, WT), }\AttributeTok{use =} \StringTok{"pairwise.complete.obs"}\NormalTok{)}
\FunctionTok{pairs}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(AGE, IQ, WT))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            AGE         IQ         WT
## AGE  1.0000000 -0.4345436  0.4157441
## IQ  -0.4345436  1.0000000 -0.2917158
## WT   0.4157441 -0.2917158  1.0000000
\end{verbatim}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-91-1} \end{center}

~

It is, however, easier to work with the \texttt{newfem} object rather than having to retype the \texttt{cbind()} function. This is particularly true if you wanted to continue with an analysis of just the three variables.

The relationship between \texttt{AGE} and \texttt{WT} can be plotted using the \texttt{plot()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(AGE, WT)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-92-1} \end{center}

\newpage

And tested using the \texttt{cor()} and \texttt{cor.test()} functions:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cor}\NormalTok{(AGE, WT, }\AttributeTok{use =} \StringTok{"pairwise.complete.obs"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.4157441
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cor.test}\NormalTok{(AGE, WT)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Pearson's product-moment correlation
## 
## data:  AGE and WT
## t = 4.6841, df = 105, p-value = 8.457e-06
## alternative hypothesis: true correlation is not equal to 0
## 95 percent confidence interval:
##  0.2452434 0.5612979
## sample estimates:
##       cor 
## 0.4157441
\end{verbatim}

\newpage

Or by using the linear modelling \texttt{lm()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(}\FunctionTok{lm}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ AGE))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = WT ~ AGE)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -3.10678 -0.85922 -0.05453  0.71434  2.70874 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)    
## (Intercept) -3.25405    0.85547  -3.804  0.00024 ***
## AGE          0.10592    0.02261   4.684 8.46e-06 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 1.128 on 105 degrees of freedom
##   (11 observations deleted due to missingness)
## Multiple R-squared:  0.1728, Adjusted R-squared:  0.165 
## F-statistic: 21.94 on 1 and 105 DF,  p-value: 8.457e-06
\end{verbatim}

~

We use the \texttt{summary()} function here to extract summary information from the output of the \texttt{lm()} function.

It is often more useful to use \texttt{lm()} to create an object:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem.lm }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ AGE)}
\end{Highlighting}
\end{Shaded}

\newpage

And use the output in other functions:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = WT ~ AGE)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -3.10678 -0.85922 -0.05453  0.71434  2.70874 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)    
## (Intercept) -3.25405    0.85547  -3.804  0.00024 ***
## AGE          0.10592    0.02261   4.684 8.46e-06 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 1.128 on 105 degrees of freedom
##   (11 observations deleted due to missingness)
## Multiple R-squared:  0.1728, Adjusted R-squared:  0.165 
## F-statistic: 21.94 on 1 and 105 DF,  p-value: 8.457e-06
\end{verbatim}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(AGE, WT)}
\FunctionTok{abline}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-97-1} \end{center}

~

In this case we are passing the intercept and slope information held in the \texttt{fem.lm} object to the \texttt{abline()} function which draws a regression line. The \texttt{abline()} function adds to an existing plot. This means that you need to keep the scatter plot of \texttt{AGE} and \texttt{WT} open before issuing the \texttt{abline()} function call.

\newpage

A useful function to apply to the \texttt{fem.lm} object is \texttt{plot()} which produces diagnostic plots of the linear model:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-98-1} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-98-2} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-98-3} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-98-4} \end{center}

\newpage

Objects created by the \texttt{lm()} function (or any of the modelling functions) can use up a lot of memory so we should remove them when we no longer need them:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

~

It might be interesting to see whether a similar relationship exists between \texttt{AGE} and \texttt{WT} for those who have and have not considered suicide. This can be done using the \texttt{coplot()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{coplot}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ AGE }\SpecialCharTok{|} \FunctionTok{as.factor}\NormalTok{(LIFE))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-100-1} \end{center}

\begin{verbatim}
## 
##  Missing rows: 21, 22, 31, 43, 44, 45, 69, 81, 101, 104, 114, 115
\end{verbatim}

\newpage

The two plots looks similar. We could also use \texttt{coplot()} to investigate the relationship between \texttt{AGE} and \texttt{WT} for categories of both \texttt{LIFE} and \texttt{SEX}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{coplot}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ AGE }\SpecialCharTok{|} \FunctionTok{as.factor}\NormalTok{(LIFE) }\SpecialCharTok{*} \FunctionTok{as.factor}\NormalTok{(SEX))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-101-1} \end{center}

\begin{verbatim}
## 
##  Missing rows: 12, 17, 21, 22, 31, 43, 44, 45, 66, 69, 81, 101, 104, 105, 114, 115
\end{verbatim}

~

although the numbers are too small for this to be useful here.

We used the \texttt{as.factor()} function with the \texttt{coplot()} function to ensure that \texttt{R} was aware that the \texttt{LIFE}
and \texttt{SEX} columns hold categorical data.

We can check the way variables are stored using the \texttt{data.class()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{data.class}\NormalTok{(fem}\SpecialCharTok{$}\NormalTok{SEX)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "numeric"
\end{verbatim}

\newpage

We can `apply' this function to all columns in a data.frame using the \texttt{sapply()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sapply}\NormalTok{(fem, data.class)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        ID       AGE        IQ       ANX       DEP       SLP       SEX      LIFE 
## "numeric" "numeric" "numeric" "numeric" "numeric" "numeric" "numeric" "numeric" 
##        WT 
## "numeric"
\end{verbatim}

~

The \texttt{sapply()} function is part of a group of functions that apply a specified function to data objects:

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.29}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.71}}@{}}
\toprule
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Function(s)}
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
\textbf{Applies a function to \ldots{}}
\end{minipage} \\
\midrule
\endhead
\texttt{apply()} & rows and columns of matrices, arrays, and tables \\
\texttt{lapply()} & components of lists and data.frames \\
\texttt{sapply()} & components of lists and data.frames \\
\texttt{mapply()} & components of lists and data.frames \\
\texttt{tapply()} & subsets of data \\
\bottomrule
\end{longtable}

Related functions are \texttt{aggregate()} which compute summary statistics for subsets of data, \texttt{by()} which applies a function to a data.frame split by factors, and \texttt{sweep()} which applies a function to an array.

The parameters of most \texttt{R} functions have default values. These are usually the most used and most useful parameter values for each function. The \texttt{cor.test()} function, for example, calculates \emph{Pearson's product moment correlation coefficient} by default. This is an appropriate measure for data from a bivariate normal distribution. The \texttt{DEP} and \texttt{ANX} variables contain ordered data. An appropriate measure of correlation between \texttt{DEP} and \texttt{ANX} is \emph{Kendall's tau}. This can be obtained using:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cor.test}\NormalTok{(DEP, ANX, }\AttributeTok{method =} \StringTok{"kendall"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Kendall's rank correlation tau
## 
## data:  DEP and ANX
## z = 5.5606, p-value = 2.689e-08
## alternative hypothesis: true tau is not equal to 0
## sample estimates:
##       tau 
## 0.4950723
\end{verbatim}

~

Before we finish we should save the \texttt{fem} data.frame so that next time we want to use it we will not have to bother with recoding the missing values to the special \texttt{NA} value. This is done with the \texttt{write.table()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{write.table}\NormalTok{(fem, }\AttributeTok{file =} \StringTok{"newfem.dat"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

Everything in \texttt{R} is either a function or an object. Even the command to quit \texttt{R} is a function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{q}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

~

When you call the \texttt{q()} function you will be asked if you want to save the workspace image. If you save the workspace image then all of the objects and functions currently available to you will be saved. These will then be automatically restored the next time you start \texttt{R} in the current working directory.

For this exercise there is no need to save the workspace image so click the \textbf{No} or \textbf{Don't Save} button (GUI) or enter \texttt{n} when prompted to save the workspace image (terminal).

\hypertarget{summary}{%
\section{Summary}\label{summary}}

\begin{itemize}
\tightlist
\item
  \texttt{R} is a functional system. Everything is done by calling functions.
\item
  \texttt{R} provides a large set of functions for descriptive statistics, charting, and statistical inference.
\item
  Functions can be chained together so that the output of one function is the input of another function.
\item
  \texttt{R} is an object oriented system. We can use functions to create objects that can then be manipulated or passed to other functions for subsequent analysis.
\end{itemize}

\hypertarget{exercise2}{%
\chapter{Manipulating objects and creating new functions}\label{exercise2}}

In this exercise we will explore how to manipulate \texttt{R} objects and how to write functions that can manipulate and extract data and information from \texttt{R} objects and produce useful analyses.

Before we go any further we should start \texttt{R} and retrieve a dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"salex.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{na.strings =} \StringTok{"9"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

Missing values are coded as 9 throughout this dataset so we can use the \texttt{na.strings} parameter of the \texttt{read.table()} function to replace all 9's with the special \texttt{NA} code when we retrieve the dataset. Check that this works by examining the \texttt{salex} data.frame:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex}
\FunctionTok{names}\NormalTok{(salex)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   ILL HAM BEEF EGGS MUSHROOM PEPPER PORKPIE PASTA RICE LETTUCE TOMATO COLESLAW
## 1   1   1    1    1        1      1       2     2    2       2      2        2
## 2   1   1    1    1        2      2       1     2    2       2      1        2
## 3   1   1    1    1        1      1       1     1    1       1      2        2
## 4   1   1    1    1        2      2       2     2    2       1      1        2
## 5   1   1    1    1        1      1       1     1    1       1      1        1
## 6   1   1    1    1        2      2       2     2    2       2      1        1
##   CRISPS PEACHCAKE CHOCOLATE FRUIT TRIFLE ALMONDS
## 1      2         2         2     2      2       2
## 2      2         2         2     2      2       2
## 3      1         2         1     2      2       2
## 4      2         2         1     2      2       2
## 5      2         2         1     2      1       2
## 6      1         2         1     2      2       2
\end{verbatim}

\begin{verbatim}
##  [1] "ILL"       "HAM"       "BEEF"      "EGGS"      "MUSHROOM"  "PEPPER"   
##  [7] "PORKPIE"   "PASTA"     "RICE"      "LETTUCE"   "TOMATO"    "COLESLAW" 
## [13] "CRISPS"    "PEACHCAKE" "CHOCOLATE" "FRUIT"     "TRIFLE"    "ALMONDS"
\end{verbatim}

~

This data comes from a food-borne outbreak. On Saturday 17th October 1992, eighty-two people attended a buffet meal at a sports club. Within fourteen to twenty-four hours, fifty-one of the participants developed diarrhoea, with nausea, vomiting, abdominal pain and fever.

The columns in the dataset are as follows:

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.22}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.32}}@{}}
\toprule
\endhead
\textbf{ILL} & Ill or not-ill \\
\textbf{HAM} & Baked ham \\
\textbf{BEEF} & Roast beef \\
\textbf{EGGS} & Eggs \\
\textbf{MUSHROOM} & Mushroom flan \\
\textbf{PEPPER} & Pepper flan \\
\textbf{PORKPIE} & Pork pie \\
\textbf{PASTA} & Pasta salad \\
\textbf{RICE} & Rice salad \\
\textbf{LETTUCE} & Lettuce \\
\textbf{TOMATO} & Tomato salad \\
\textbf{COLESLAW} & Coleslaw \\
\textbf{CRISPS} & Crisps \\
\textbf{PEACHCAKE} & Peach cake \\
\textbf{CHOCOLATE} & Chocolate cake \\
\textbf{FRUIT} & Tropical fruit salad \\
\textbf{TRIFLE} & Trifle \\
\textbf{ALMONDS} & Almonds \\
\bottomrule
\end{longtable}

Data is available for seventy-seven of the eighty-two people who attended the sports club buffet. All of the variables are coded 1=yes, 2=no.

\newpage

We can use the \texttt{attach()} function to make it easier to access our data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{attach}\NormalTok{(salex)}
\end{Highlighting}
\end{Shaded}

~

The two-by-two table is a basic epidemiological tool. In analysing data from a food-borne outbreak collected as a retrospective cohort study, for example, we would tabulate each exposure (suspect foodstuffs) against the outcome (illness) and calculate risk ratios and confidence intervals. \texttt{R} has no explicit function to calculate risk ratios from two-by-two tables but we can easily write one ourselves.

The first step in writing such a function would be to create the two-by-two table. This can be done with the \texttt{table()} function. We will use a table of \texttt{HAM} by \texttt{ILL} as an illustration:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(HAM, ILL)}
\end{Highlighting}
\end{Shaded}

~

This command produces the following output:

~

\begin{verbatim}
##    ILL
## HAM  1  2
##   1 46 17
##   2  5  9
\end{verbatim}

~

We can manipulate the output directly but it is easier if we instruct \texttt{R} to save the output of the \texttt{table()} function in an object:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(HAM, ILL)}
\end{Highlighting}
\end{Shaded}

\newpage

The \texttt{tab} object contains the output of the \texttt{table()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    ILL
## HAM  1  2
##   1 46 17
##   2  5  9
\end{verbatim}

~

As it is stored in an object we can examine its contents on an item by item basis.

The \texttt{tab} object is an object of class \texttt{table}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "table"
\end{verbatim}

~

We can extract data from a table object by using indices or row and column co-ordinates:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{tab[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{]}
\NormalTok{tab[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 46
\end{verbatim}

\begin{verbatim}
## [1] 17
\end{verbatim}

\begin{verbatim}
## [1] 5
\end{verbatim}

~

The numbers in the square brackets refer to the \textbf{\emph{position}} (as row and column co-ordinates) of the data item in the table \textbf{\emph{not}} the \textbf{\emph{values}} of the variables. We can extract data using the values of the row and column variables by enclosing the index values in double quotes (``). For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab[}\StringTok{"1"}\NormalTok{,}\StringTok{"1"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 46
\end{verbatim}

\newpage

The two methods of extracting data may be combined. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab[}\DecValTok{1}\NormalTok{,}\StringTok{"1"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 46
\end{verbatim}

~

We can calculate a risk ratio using the extracted data:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(tab[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{/}\NormalTok{(tab[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{tab[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{]))}\SpecialCharTok{/}\NormalTok{(tab[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{/}\NormalTok{(tab[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{tab[}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{]))}
\end{Highlighting}
\end{Shaded}

~

Which returns a risk ratio of

~

\begin{verbatim}
## [1] 2.044444
\end{verbatim}

~

This is a tedious calculation to have to type in every time you need to calculate a risk ratio from a two-by-two table. It would be better to have a function that calculates and displays the risk ratio automatically. Fortunately, \texttt{R} allows us to do just that.

The \texttt{function()} function allows us to create new functions in \texttt{R}:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab2by2 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(exposure, outcome) \{\}}
\end{Highlighting}
\end{Shaded}

~

This creates an empty function called \texttt{tab2by2} that expects two parameters called \texttt{exposure} and \texttt{outcome}. We could type the whole function in at the \texttt{R} command prompt but it is easier to use a text editor:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(tab2by2)}
\end{Highlighting}
\end{Shaded}

~

This will start an editor with the empty \texttt{tab2by2()} function already loaded. We can now edit this function to make it do something useful:

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(exposure, outcome)}
\NormalTok{  \{}
\NormalTok{  tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(exposure, outcome)}
\NormalTok{  a }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{  b }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{]}
\NormalTok{  c }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{  d }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{]}
\NormalTok{  rr }\OtherTok{\textless{}{-}}\NormalTok{ (a }\SpecialCharTok{/}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b)) }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{+}\NormalTok{ d))}
  \FunctionTok{print}\NormalTok{(tab)}
  \FunctionTok{print}\NormalTok{(rr) }
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, check your work, save the file, and quit the editor.
Before proceeding we should examine the \texttt{tab2by2()} function to make sure we understand what the function will do:

\begin{itemize}
\item
  The first line defines \texttt{tab2by2} as a function that expects to be given two parameters which are called \texttt{exposure} and \texttt{outcome}.
\item
  The body of the function (i.e.~the work of the function) is enclosed within curly brackets (\texttt{\{\}}).
\item
  The first line of the body of the function creates a table object (\texttt{tab}) using the variables specified when the \texttt{tab2by2()} function is called (these are the parameters \texttt{exposure} and \texttt{outcome}).
\item
  The next line creates four new objects (called \texttt{a}, \texttt{b}, \texttt{c}, and \texttt{d}) which contain the values of the four cells in the two-by-two table.
\item
  The following line calculates the risk ratio using the objects \texttt{a}, \texttt{b}, \texttt{c}, and \texttt{d} and stores the result of the calculation in an object called \texttt{rr}.
\item
  The final two lines print the contents of the \texttt{tab} and \texttt{rr} objects.
\end{itemize}

\newpage

Let's try the \texttt{tab2by2()} function with our test data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(HAM, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         outcome
## exposure  1  2
##        1 46 17
##        2  5  9
## [1] 2.044444
\end{verbatim}

~

The \texttt{tab2by2()} function displays a table of \texttt{HAM} by \texttt{ILL} followed by the risk ratio calculated from the data in the table.

Try producing another table:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(PASTA, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         outcome
## exposure  1  2
##        1 25  3
##        2 26 23
## [1] 1.682692
\end{verbatim}

~

Have a look at the \texttt{R} objects available to you:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "fem"     "salex"   "tab"     "tab2by2"
\end{verbatim}

~

Note that there are no \texttt{a}, \texttt{b}, \texttt{c}, \texttt{d}, or \texttt{rr} objects.

\newpage

Examine the \texttt{tab} object:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    ILL
## HAM  1  2
##   1 46 17
##   2  5  9
\end{verbatim}

~

This is the table of \texttt{HAM} by \texttt{ILL} that you created earlier \textbf{\emph{not}} the table of \texttt{PASTA} by \texttt{ILL} that was created by the \texttt{tab2by2()} function.

The \texttt{tab}, \texttt{a}, \texttt{b}, \texttt{c}, \texttt{d}, and \texttt{rr} objects in the \texttt{tab2by2()} function are local to that function and do not change anything outside of that function. This means that the \texttt{tab} object inside the function is independent of any object of the same name outside of the function.

When a function completes its work, all of the objects that are local to that function are automatically removed. This is useful as it means that you can use object names inside functions that will not interfere with objects of the same name that are stored elsewhere. It also means that you do not clutter up the \texttt{R} workspace with temporary objects.

Just to prove that \texttt{tab} in the \texttt{tab2by2()} function exists only in the \texttt{tab2by2()} function we can delete the tab object from the \texttt{R} workspace:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rm}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

Now try another call to the \texttt{tab2by2()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(FRUIT, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         outcome
## exposure  1  2
##        1  1  4
##        2 49 22
## [1] 0.2897959
\end{verbatim}

\newpage

Now list the \texttt{R} objects available to you:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ls}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "fem"     "salex"   "tab2by2"
\end{verbatim}

~

Note that there are no \texttt{tab}, \texttt{a}, \texttt{b}, \texttt{c}, \texttt{d}, or \texttt{rr} objects.

The \texttt{tab2by2()} function is very limited. It only displays a table and calculates and displays a simple ratio. A more useful function would also calculate and display a confidence interval for the risk ratio. This is what we will do now. Use the \texttt{fix()} function to edit the \texttt{tab2by2()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(tab2by2)}
\end{Highlighting}
\end{Shaded}

~

We can now edit this function to calculate and display a 95\% confidence interval for the risk ratio.

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(exposure, outcome) \{}
\NormalTok{  tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(exposure, outcome)}
\NormalTok{  a }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{  b }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{]}
\NormalTok{  c }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{  d }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{]}
\NormalTok{  rr }\OtherTok{\textless{}{-}}\NormalTok{ (a }\SpecialCharTok{/}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b)) }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{+}\NormalTok{ d))}
\NormalTok{  se.log.rr }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{((b }\SpecialCharTok{/}\NormalTok{ a) }\SpecialCharTok{/}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b) }\SpecialCharTok{+}\NormalTok{ (d }\SpecialCharTok{/}\NormalTok{ c) }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{+}\NormalTok{ d)) }
\NormalTok{  lci.rr }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\FunctionTok{log}\NormalTok{(rr) }\SpecialCharTok{{-}} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ se.log.rr)}
\NormalTok{  uci.rr }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\FunctionTok{log}\NormalTok{(rr) }\SpecialCharTok{+} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ se.log.rr)}
  \FunctionTok{print}\NormalTok{(tab)}
  \FunctionTok{print}\NormalTok{(rr)}
  \FunctionTok{print}\NormalTok{(lci.rr)}
  \FunctionTok{print}\NormalTok{(uci.rr)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

Once you have made the changes shown above, check your work, save the file, and quit the editor. We should test our revised function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(EGGS, ILL)}
\end{Highlighting}
\end{Shaded}

~

which produces the following output:

~

\begin{verbatim}
##         outcome
## exposure  1  2
##        1 40  6
##        2 10 20
## [1] 2.608696
## [1] 1.553564
## [1] 4.38044
\end{verbatim}

~

The function works but the output could be improved. Use the \texttt{fix()} function to edit the \texttt{tab2by2()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(exposure, outcome) \{}
\NormalTok{  tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(exposure, outcome)}
\NormalTok{  a }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{  b }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{]}
\NormalTok{  c }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{  d }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{]}
\NormalTok{  rr }\OtherTok{\textless{}{-}}\NormalTok{ (a }\SpecialCharTok{/}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b)) }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{+}\NormalTok{ d))}
\NormalTok{  se.log.rr }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{((b }\SpecialCharTok{/}\NormalTok{ a) }\SpecialCharTok{/}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b) }\SpecialCharTok{+}\NormalTok{ (d }\SpecialCharTok{/}\NormalTok{ c) }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{+}\NormalTok{ d)) }
\NormalTok{  lci.rr }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\FunctionTok{log}\NormalTok{(rr) }\SpecialCharTok{{-}} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ se.log.rr)}
\NormalTok{  uci.rr }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\FunctionTok{log}\NormalTok{(rr) }\SpecialCharTok{+} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ se.log.rr)}
  \FunctionTok{print}\NormalTok{(tab)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{RR :"}\NormalTok{, rr,}
      \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{95\% CI :"}\NormalTok{, lci.rr, uci.rr, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, save the file and quit the editor.

\newpage

Now we can test our function again:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(EGGS, ILL)}
\end{Highlighting}
\end{Shaded}

~

Which produces the following output:

~

\begin{verbatim}
##         outcome
## exposure  1  2
##        1 40  6
##        2 10 20
## 
## RR : 2.608696 
## 95% CI : 1.553564 4.38044
\end{verbatim}

~

The \texttt{tab2by2()} function displays output but does not behave like a standard \texttt{R} function in the sense that you cannot save the results of the \texttt{tab2by2()} function into an object:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test2by2 }\OtherTok{\textless{}{-}} \FunctionTok{tab2by2}\NormalTok{(EGGS, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         outcome
## exposure  1  2
##        1 40  6
##        2 10 20
## 
## RR : 2.608696 
## 95% CI : 1.553564 4.38044
\end{verbatim}

~

displays output but does not save anything in the \texttt{test2by2} object:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test2by2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## NULL
\end{verbatim}

\newpage

The returned value (\texttt{NULL}) means that \texttt{test2by2} is an empty object. We will not worry about this at the moment as the \texttt{tab2by2()} function is good-enough for our current purposes. In Exercise 6 we will explore how to make our own functions behave like standard \texttt{R} functions.

We will now add the calculation of the odds ratio and its 95\% confidence interval to the \texttt{tab2by2()} function using the \texttt{fix()} function.

There are two ways of doing this. We could either calculate the odds ratio from the table and use (e.g.) the method of Woolf to calculate the confidence interval:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{or }\OtherTok{\textless{}{-}}\NormalTok{ (a }\SpecialCharTok{/}\NormalTok{ b) }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{/}\NormalTok{ d)}
\NormalTok{se.log.or }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{1} \SpecialCharTok{/}\NormalTok{ a }\SpecialCharTok{+} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ b }\SpecialCharTok{+} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ c }\SpecialCharTok{+} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ d)}
\NormalTok{lci.or }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\FunctionTok{log}\NormalTok{(or) }\SpecialCharTok{{-}} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ se.log.or)}
\NormalTok{uci.or }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\FunctionTok{log}\NormalTok{(or) }\SpecialCharTok{+} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ se.log.or)}
\FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{OR     :"}\NormalTok{, or,}
    \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{95\% CI :"}\NormalTok{, lci.or, uci.or, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

or use the output of the \texttt{fisher.test()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ft }\OtherTok{\textless{}{-}} \FunctionTok{fisher.test}\NormalTok{(tab)}
\FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{OR     :"}\NormalTok{, ft}\SpecialCharTok{$}\NormalTok{estimate,}
    \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{95\% CI :"}\NormalTok{, ft}\SpecialCharTok{$}\NormalTok{conf.int, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

Note that we can refer to components of a function's output using the same syntax as when we refer to columns in a data.frame (e.g.~\texttt{ft\$estimate} to examine the estimate of the odds ratio from the \texttt{fisher.test()} function stored in the object \texttt{ft}).

The names of elements in the output of a standard function such as \texttt{fisher.test()} can be found in the documentation or the help system. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{help}\NormalTok{(fisher.test)}
\end{Highlighting}
\end{Shaded}

\newpage

Output elements are listed under the \texttt{Value} heading.

Revise the \texttt{tab2by2()} function to include the calculation of the odds ratio and the 95\% confidence interval. The revised function will look something like this:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(exposure, outcome) \{}
\NormalTok{  tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(exposure, outcome)}
\NormalTok{  a }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{  b }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{]}
\NormalTok{  c }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{  d }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{]}
\NormalTok{  rr }\OtherTok{\textless{}{-}}\NormalTok{ (a }\SpecialCharTok{/}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b)) }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{+}\NormalTok{ d))}
\NormalTok{  se.log.rr }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{((b }\SpecialCharTok{/}\NormalTok{ a) }\SpecialCharTok{/}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b) }\SpecialCharTok{+}\NormalTok{ (d }\SpecialCharTok{/}\NormalTok{ c) }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{+}\NormalTok{ d)) }
\NormalTok{  lci.rr }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\FunctionTok{log}\NormalTok{(rr) }\SpecialCharTok{{-}} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ se.log.rr)}
\NormalTok{  uci.rr }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\FunctionTok{log}\NormalTok{(rr) }\SpecialCharTok{+} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ se.log.rr)}
\NormalTok{  or }\OtherTok{\textless{}{-}}\NormalTok{ (a }\SpecialCharTok{/}\NormalTok{ b) }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{/}\NormalTok{ d)}
\NormalTok{  se.log.or }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{(}\DecValTok{1} \SpecialCharTok{/}\NormalTok{ a }\SpecialCharTok{+} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ b }\SpecialCharTok{+} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ c }\SpecialCharTok{+} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ d)}
\NormalTok{  lci.or }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\FunctionTok{log}\NormalTok{(or) }\SpecialCharTok{{-}} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ se.log.or)}
\NormalTok{  uci.or }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\FunctionTok{log}\NormalTok{(or) }\SpecialCharTok{+} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ se.log.or)}
\NormalTok{  ft }\OtherTok{\textless{}{-}} \FunctionTok{fisher.test}\NormalTok{(tab)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \FunctionTok{print}\NormalTok{(tab)}
  
  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{Relative Risk     :"}\NormalTok{, rr,}
      \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{95\% CI            :"}\NormalTok{, lci.rr, uci.rr, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  
  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{Sample Odds Ratio :"}\NormalTok{, or,}
      \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{95\% CI            :"}\NormalTok{, lci.or, uci.or, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}

  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{MLE Odds Ratio    :"}\NormalTok{, ft}\SpecialCharTok{$}\NormalTok{estimate,}
      \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{95\% CI            :"}\NormalTok{,  ft}\SpecialCharTok{$}\NormalTok{conf.int, }\StringTok{"}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, check your work, save the file, and quit the editor.

\newpage

Test the \texttt{tab2by2()} function when you have added the calculation of the odds ratio and its 95\% confidence interval.

Now that we have a function that will calculate risk ratios and odds ratios with confidence intervals from a two- by-two table we can use it to analyse the \texttt{salex} data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(HAM, ILL)}
\FunctionTok{tab2by2}\NormalTok{(BEEF, ILL)}
\FunctionTok{tab2by2}\NormalTok{(EGGS, ILL)}
\FunctionTok{tab2by2}\NormalTok{(MUSHROOM, ILL)}
\FunctionTok{tab2by2}\NormalTok{(PEPPER, ILL)}
\FunctionTok{tab2by2}\NormalTok{(PORKPIE, ILL)}
\FunctionTok{tab2by2}\NormalTok{(PASTA, ILL)}
\FunctionTok{tab2by2}\NormalTok{(RICE, ILL)}
\FunctionTok{tab2by2}\NormalTok{(LETTUCE, ILL)}
\FunctionTok{tab2by2}\NormalTok{(TOMATO, ILL)}
\FunctionTok{tab2by2}\NormalTok{(COLESLAW, ILL)}
\FunctionTok{tab2by2}\NormalTok{(CRISPS, ILL)}
\FunctionTok{tab2by2}\NormalTok{(PEACHCAKE, ILL)}
\FunctionTok{tab2by2}\NormalTok{(CHOCOLATE, ILL)}
\FunctionTok{tab2by2}\NormalTok{(FRUIT, ILL)}
\FunctionTok{tab2by2}\NormalTok{(TRIFLE, ILL)}
\FunctionTok{tab2by2}\NormalTok{(ALMONDS, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 46 17
##        2  5  9
## 
## Relative Risk     : 2.044444 
## 95% CI            : 0.9964841 4.194501 
## 
## Sample Odds Ratio : 4.870588 
## 95% CI            : 1.428423 16.60756 
## 
## MLE Odds Ratio    : 4.75649 
## 95% CI            : 1.22777 20.82921
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 45 22
##        2  6  4
## 
## Relative Risk     : 1.119403 
## 95% CI            : 0.6568821 1.907592 
## 
## Sample Odds Ratio : 1.363636 
## 95% CI            : 0.3485746 5.334594 
## 
## MLE Odds Ratio    : 1.357903 
## 95% CI            : 0.2547114 6.428414
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 40  6
##        2 10 20
## 
## Relative Risk     : 2.608696 
## 95% CI            : 1.553564 4.38044 
## 
## Sample Odds Ratio : 13.33333 
## 95% CI            : 4.240168 41.92706 
## 
## MLE Odds Ratio    : 12.74512 
## 95% CI            : 3.762787 50.05419
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 24  6
##        2 25 19
## 
## Relative Risk     : 1.408 
## 95% CI            : 1.028944 1.926697 
## 
## Sample Odds Ratio : 3.04 
## 95% CI            : 1.037274 8.909506 
## 
## MLE Odds Ratio    : 2.995207 
## 95% CI            : 0.9421008 10.7953
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 24  3
##        2 23 22
## 
## Relative Risk     : 1.73913 
## 95% CI            : 1.26876 2.383882 
## 
## Sample Odds Ratio : 7.652174 
## 95% CI            : 2.013718 29.07844 
## 
## MLE Odds Ratio    : 7.448216 
## 95% CI            : 1.861728 44.12015
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 21  9
##        2 29 17
## 
## Relative Risk     : 1.110345 
## 95% CI            : 0.8044752 1.532509 
## 
## Sample Odds Ratio : 1.367816 
## 95% CI            : 0.5113158 3.659032 
## 
## MLE Odds Ratio    : 1.362228 
## 95% CI            : 0.4636016 4.190667
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 25  3
##        2 26 23
## 
## Relative Risk     : 1.682692 
## 95% CI            : 1.255392 2.255433 
## 
## Sample Odds Ratio : 7.371795 
## 95% CI            : 1.964371 27.66451 
## 
## MLE Odds Ratio    : 7.195422 
## 95% CI            : 1.829867 42.07488
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 28  4
##        2 23 22
## 
## Relative Risk     : 1.711957 
## 95% CI            : 1.250197 2.344268 
## 
## Sample Odds Ratio : 6.695652 
## 95% CI            : 2.017327 22.22335 
## 
## MLE Odds Ratio    : 6.532868 
## 95% CI            : 1.852297 29.84928
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 28  1
##        2 23 25
## 
## Relative Risk     : 2.014993 
## 95% CI            : 1.488481 2.727744 
## 
## Sample Odds Ratio : 30.43478 
## 95% CI            : 3.826938 242.041 
## 
## MLE Odds Ratio    : 29.32825 
## 95% CI            : 4.161299 1284.306
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 29  9
##        2 22 17
## 
## Relative Risk     : 1.352871 
## 95% CI            : 0.974698 1.877771 
## 
## Sample Odds Ratio : 2.489899 
## 95% CI            : 0.9347213 6.632562 
## 
## MLE Odds Ratio    : 2.459981 
## 95% CI            : 0.8467562 7.558026
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 29  3
##        2 21 23
## 
## Relative Risk     : 1.89881 
## 95% CI            : 1.366876 2.63775 
## 
## Sample Odds Ratio : 10.5873 
## 95% CI            : 2.806364 39.9417 
## 
## MLE Odds Ratio    : 10.26269 
## 95% CI            : 2.600771 60.35431
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 21 10
##        2 30 16
## 
## Relative Risk     : 1.03871 
## 95% CI            : 0.7529065 1.433004 
## 
## Sample Odds Ratio : 1.12 
## 95% CI            : 0.4258139 2.945888 
## 
## MLE Odds Ratio    : 1.118358 
## 95% CI            : 0.3858206 3.340535
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1  2  2
##        2 49 24
## 
## Relative Risk     : 0.744898 
## 95% CI            : 0.27594 2.010846 
## 
## Sample Odds Ratio : 0.4897959 
## 95% CI            : 0.06497947 3.691936 
## 
## MLE Odds Ratio    : 0.4947099 
## 95% CI            : 0.03393887 7.209143
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 12  2
##        2 38 24
## 
## Relative Risk     : 1.398496 
## 95% CI            : 1.045064 1.871456 
## 
## Sample Odds Ratio : 3.789474 
## 95% CI            : 0.7791326 18.43089 
## 
## MLE Odds Ratio    : 3.733535 
## 95% CI            : 0.7318646 37.28268
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1  1  4
##        2 49 22
## 
## Relative Risk     : 0.2897959 
## 95% CI            : 0.04985828 1.684408 
## 
## Sample Odds Ratio : 0.1122449 
## 95% CI            : 0.01185022 1.06318 
## 
## MLE Odds Ratio    : 0.1157141 
## 95% CI            : 0.002240848 1.256134
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 19  5
##        2 32 21
## 
## Relative Risk     : 1.311198 
## 95% CI            : 0.9718621 1.769016 
## 
## Sample Odds Ratio : 2.49375 
## 95% CI            : 0.8067804 7.708156 
## 
## MLE Odds Ratio    : 2.465794 
## 95% CI            : 0.7363311 9.778463
\end{verbatim}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1  3  3
##        2 38 19
## 
## Relative Risk     : 0.75 
## 95% CI            : 0.3300089 1.7045 
## 
## Sample Odds Ratio : 0.5 
## 95% CI            : 0.09203498 2.716358 
## 
## MLE Odds Ratio    : 0.505905 
## 95% CI            : 0.06170211 4.141891
\end{verbatim}

~

Make a note of any positive associations (i.e.~with a risk ratio \textgreater{} 1 with a 95\% confidence intervals that does not include one). We will use these for the next exercise when we will use logistic regression to analyse this data.

Save the \texttt{tab2by2()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(tab2by2, }\AttributeTok{file =} \StringTok{"tab2by2.r"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

We can now quit \texttt{R}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{q}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

~

For this exercise there is no need to save the workspace image so click the \textbf{No} or \textbf{Don't Save} button (GUI) or enter \texttt{n} when prompted to save the workspace image (terminal).

\hypertarget{summary-1}{%
\section{Summary}\label{summary-1}}

\begin{itemize}
\item
  \texttt{R} objects contain information that can be examined and manipulated.
\item
  \texttt{R} can be extended by writing new functions.
\item
  New functions can perform simple or complex data analysis.
\item
  New functions can be composed of parts of existing function.
\item
  New functions can be saved and used in subsequent \texttt{R} sessions.
\item
  Objects defined within functions are local to that function and only exist while that function is being used. This means that you can re-use meaningful names within functions without them interfering with each other.
\end{itemize}

\hypertarget{exercise3}{%
\chapter{Logistic regression and stratified analysis}\label{exercise3}}

In this exercise we will explore how \texttt{R} handles generalised linear models using the example of logistic regression. We will continue using the \texttt{salex} dataset. Start \texttt{R} and retrieve the \texttt{salex} dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"salex.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{na.strings =} \StringTok{"9"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

When we analysed this data using two-by-two tables and examining the risk ratio and 95\% confidence interval associated with each exposure we found many significant positive associations:

~

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.22}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.15}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.29}}@{}}
\toprule
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Variable}
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
\textbf{RR}
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
\textbf{95\% CI}
\end{minipage} \\
\midrule
\endhead
EGGS & 2.61 & 1.55, 4.38 \\
MUSHROOM & 1.41 & 1.03, 1.93 \\
PEPPER & 1.74 & 1.27, 2.38 \\
PASTA & 1.68 & 1.26, 2.26 \\
RICE & 1.72 & 1.25, 2.34 \\
LETTUCE & 2.01 & 1.49, 2.73 \\
COLESLAW & 1.89 & 1.37, 2.64 \\
CHOCOLATE & 1.39 & 1.05, 1.87 \\
\bottomrule
\end{longtable}

~

Some of these associations may be due to \emph{confounding} in the data. We can use logistic regression to help us identify independent associations.

Logistic regression requires the dependent variable to be either 0 or 1. In order to perform a logistic regression we must first recode the \texttt{ILL} variable so that 0=no and 1=yes:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(salex}\SpecialCharTok{$}\NormalTok{ILL)}
\NormalTok{salex}\SpecialCharTok{$}\NormalTok{ILL[salex}\SpecialCharTok{$}\NormalTok{ILL }\SpecialCharTok{==} \DecValTok{2}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{0}
\FunctionTok{table}\NormalTok{(salex}\SpecialCharTok{$}\NormalTok{ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  1  2 
## 51 26
\end{verbatim}

\begin{verbatim}
## 
##  0  1 
## 26 51
\end{verbatim}

~

We could work with our data as it is but if we wanted to calculate odds ratios and confidence intervals we would calculate their reciprocals (i.e.~odds ratios for non-exposure rather than for exposure). This is because of the way the data has been coded (1=yes, 2=no).

In order to calculate meaningful odds ratios the exposure variables should also be coded 0=no, 1=yes. The actual codes used are not important as long as the value used for `exposed' is one greater than the value used for `not exposed'.

We could issue a series of commands similar to the one we have just used to recode the \texttt{ILL} variable. This is both tedious and unnecessary as the structure of the dataset (i.e.~all variables are coded identically) allows us to recode all variables with a single command:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"salex.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{na.strings =} \StringTok{"9"}\NormalTok{)}
\NormalTok{salex[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   ILL HAM BEEF EGGS MUSHROOM PEPPER PORKPIE PASTA RICE LETTUCE TOMATO COLESLAW
## 1   1   1    1    1        1      1       2     2    2       2      2        2
## 2   1   1    1    1        2      2       1     2    2       2      1        2
## 3   1   1    1    1        1      1       1     1    1       1      2        2
## 4   1   1    1    1        2      2       2     2    2       1      1        2
## 5   1   1    1    1        1      1       1     1    1       1      1        1
##   CRISPS PEACHCAKE CHOCOLATE FRUIT TRIFLE ALMONDS
## 1      2         2         2     2      2       2
## 2      2         2         2     2      2       2
## 3      1         2         1     2      2       2
## 4      2         2         1     2      2       2
## 5      2         2         1     2      1       2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex }\OtherTok{\textless{}{-}} \DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ salex}
\NormalTok{salex[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   ILL HAM BEEF EGGS MUSHROOM PEPPER PORKPIE PASTA RICE LETTUCE TOMATO COLESLAW
## 1   1   1    1    1        1      1       0     0    0       0      0        0
## 2   1   1    1    1        0      0       1     0    0       0      1        0
## 3   1   1    1    1        1      1       1     1    1       1      0        0
## 4   1   1    1    1        0      0       0     0    0       1      1        0
## 5   1   1    1    1        1      1       1     1    1       1      1        1
##   CRISPS PEACHCAKE CHOCOLATE FRUIT TRIFLE ALMONDS
## 1      0         0         0     0      0       0
## 2      0         0         0     0      0       0
## 3      1         0         1     0      0       0
## 4      0         0         1     0      0       0
## 5      0         0         1     0      1       0
\end{verbatim}

~

\textbf{\emph{WARNING}} : The \texttt{attach()} function works with a copy of the data.frame rather than the original data.frame. Commands that manipulate variables in a data.frame may not work as expected if the data.frame has been attached using the \texttt{attach()} function.

It is better to manipulate data \textbf{\emph{before}} attaching a data.frame. The \texttt{detach()} function may be used to remove an attachment prior to any data manipulation.

Many \texttt{R} users avoid using the \texttt{attach()} function altogether.

We can now use the generalised linear model \texttt{glm()} function to specify the logistic regression model:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex.lreg }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ ILL }\SpecialCharTok{\textasciitilde{}}\NormalTok{ EGGS }\SpecialCharTok{+}\NormalTok{ MUSHROOM }\SpecialCharTok{+}\NormalTok{ PEPPER }\SpecialCharTok{+}\NormalTok{ PASTA }\SpecialCharTok{+}
\NormalTok{                  RICE }\SpecialCharTok{+}\NormalTok{ LETTUCE }\SpecialCharTok{+}\NormalTok{ COLESLAW }\SpecialCharTok{+}\NormalTok{ CHOCOLATE,}
                  \AttributeTok{family =} \FunctionTok{binomial}\NormalTok{(logit), }\AttributeTok{data =}\NormalTok{ salex)}
\end{Highlighting}
\end{Shaded}

~

The method used by the \texttt{glm()} function is defined by the \texttt{family} parameter. Here we specify \texttt{binomial} errors and a \texttt{logit} (logistic) linking function.

We have saved the output of the \texttt{glm()} function in the \texttt{salex.lreg} object. We can examine some basic information about the specified model using the \texttt{summary()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(salex.lreg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = ILL ~ EGGS + MUSHROOM + PEPPER + PASTA + RICE + 
##     LETTUCE + COLESLAW + CHOCOLATE, family = binomial(logit), 
##     data = salex)
## 
## Deviance Residuals: 
##      Min        1Q    Median        3Q       Max  
## -1.92036  -0.49869   0.06877   0.40906   2.07182  
## 
## Coefficients:
##              Estimate Std. Error z value Pr(>|z|)   
## (Intercept) -2.021864   0.676606  -2.988  0.00281 **
## EGGS         3.579366   1.267870   2.823  0.00476 **
## MUSHROOM    -3.584345   1.728999  -2.073  0.03817 * 
## PEPPER       2.348074   1.428177   1.644  0.10015   
## PASTA        1.774818   1.162762   1.526  0.12692   
## RICE         0.114180   1.193840   0.096  0.92381   
## LETTUCE      3.401828   1.234060   2.757  0.00584 **
## COLESLAW     0.763857   1.024373   0.746  0.45586   
## CHOCOLATE    0.009782   1.314683   0.007  0.99406   
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 91.246  on 69  degrees of freedom
## Residual deviance: 41.260  on 61  degrees of freedom
##   (7 observations deleted due to missingness)
## AIC: 59.26
## 
## Number of Fisher Scoring iterations: 7
\end{verbatim}

~

We will use \emph{backwards elimination} to remove non-significant variables from the logistic regression model. Remember that previous commands can be recalled and edited using the up and down arrow keys -- they do not need to be typed out in full each time.

\newpage

\texttt{CHOCOLATE} is the least significant variable in the model so we will remove this variable from the model. Storing the output of the \texttt{glm()} function is useful as it allows us to use the \texttt{update()} function to add, remove, or modify variables without having to describe the model in full:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex.lreg }\OtherTok{\textless{}{-}} \FunctionTok{update}\NormalTok{(salex.lreg, . }\SpecialCharTok{\textasciitilde{}}\NormalTok{ . }\SpecialCharTok{{-}}\NormalTok{ CHOCOLATE)}
\FunctionTok{summary}\NormalTok{(salex.lreg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = ILL ~ EGGS + MUSHROOM + PEPPER + PASTA + RICE + 
##     LETTUCE + COLESLAW, family = binomial(logit), data = salex)
## 
## Deviance Residuals: 
##      Min        1Q    Median        3Q       Max  
## -1.92561  -0.49859   0.07555   0.38723   2.07200  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(>|z|)   
## (Intercept)  -2.0223     0.6623  -3.053  0.00226 **
## EGGS          3.5890     1.2188   2.945  0.00323 **
## MUSHROOM     -3.5992     1.6885  -2.132  0.03305 * 
## PEPPER        2.3544     1.4275   1.649  0.09910 . 
## PASTA         1.7770     1.1215   1.585  0.11308   
## RICE          0.1170     1.1388   0.103  0.91819   
## LETTUCE       3.4109     1.2316   2.770  0.00561 **
## COLESLAW      0.7630     1.0224   0.746  0.45547   
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 92.122  on 70  degrees of freedom
## Residual deviance: 41.273  on 63  degrees of freedom
##   (6 observations deleted due to missingness)
## AIC: 57.273
## 
## Number of Fisher Scoring iterations: 7
\end{verbatim}

\newpage

\texttt{RICE} is now the least significant variable in the model so we will remove this variable from the model:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex.lreg }\OtherTok{\textless{}{-}} \FunctionTok{update}\NormalTok{(salex.lreg, . }\SpecialCharTok{\textasciitilde{}}\NormalTok{ . }\SpecialCharTok{{-}}\NormalTok{ RICE)}
\FunctionTok{summary}\NormalTok{(salex.lreg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = ILL ~ EGGS + MUSHROOM + PEPPER + PASTA + LETTUCE + 
##     COLESLAW, family = binomial(logit), data = salex)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.8877  -0.4999   0.0786   0.3897   2.0697  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(>|z|)   
## (Intercept)  -2.0169     0.6600  -3.056  0.00224 **
## EGGS          3.6142     1.1944   3.026  0.00248 **
## MUSHROOM     -3.5508     1.6134  -2.201  0.02774 * 
## PEPPER        2.3002     1.3200   1.743  0.08141 . 
## PASTA         1.8230     1.0280   1.773  0.07617 . 
## LETTUCE       3.4199     1.2273   2.787  0.00533 **
## COLESLAW      0.7611     1.0203   0.746  0.45571   
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 92.122  on 70  degrees of freedom
## Residual deviance: 41.283  on 64  degrees of freedom
##   (6 observations deleted due to missingness)
## AIC: 55.283
## 
## Number of Fisher Scoring iterations: 6
\end{verbatim}

\newpage

\texttt{COLESLAW} is now the least significant variable in the model so we will remove this variable from the model:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex.lreg }\OtherTok{\textless{}{-}} \FunctionTok{update}\NormalTok{(salex.lreg, . }\SpecialCharTok{\textasciitilde{}}\NormalTok{ . }\SpecialCharTok{{-}}\NormalTok{ COLESLAW)}
\FunctionTok{summary}\NormalTok{(salex.lreg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = ILL ~ EGGS + MUSHROOM + PEPPER + PASTA + LETTUCE, 
##     family = binomial(logit), data = salex)
## 
## Deviance Residuals: 
##      Min        1Q    Median        3Q       Max  
## -1.98481  -0.50486   0.08871   0.36910   2.06065  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(>|z|)   
## (Intercept)  -1.9957     0.6545  -3.049  0.00230 **
## EGGS          3.8152     1.1640   3.278  0.00105 **
## MUSHROOM     -3.4008     1.5922  -2.136  0.03269 * 
## PEPPER        2.3520     1.3269   1.773  0.07631 . 
## PASTA         1.9706     0.9922   1.986  0.04701 * 
## LETTUCE       3.4786     1.2246   2.841  0.00450 **
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 92.982  on 71  degrees of freedom
## Residual deviance: 41.895  on 66  degrees of freedom
##   (5 observations deleted due to missingness)
## AIC: 53.895
## 
## Number of Fisher Scoring iterations: 6
\end{verbatim}

\newpage

\texttt{PEPPER} is now the least significant variable in the model so we will remove this variable from the model:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex.lreg }\OtherTok{\textless{}{-}} \FunctionTok{update}\NormalTok{(salex.lreg, . }\SpecialCharTok{\textasciitilde{}}\NormalTok{ . }\SpecialCharTok{{-}}\NormalTok{ PEPPER)}
\FunctionTok{summary}\NormalTok{(salex.lreg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = ILL ~ EGGS + MUSHROOM + PASTA + LETTUCE, family = binomial(logit), 
##     data = salex)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.0920  -0.5360   0.1109   0.4876   2.0056  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(>|z|)    
## (Intercept)  -1.8676     0.6128  -3.048 0.002306 ** 
## EGGS          3.7094     1.0682   3.473 0.000515 ***
## MUSHROOM     -1.6165     1.0829  -1.493 0.135524    
## PASTA         1.8440     0.9193   2.006 0.044864 *  
## LETTUCE       3.2458     1.1698   2.775 0.005527 ** 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 94.659  on 73  degrees of freedom
## Residual deviance: 45.578  on 69  degrees of freedom
##   (3 observations deleted due to missingness)
## AIC: 55.578
## 
## Number of Fisher Scoring iterations: 6
\end{verbatim}

\newpage

\texttt{MUSHROOM} is now the least significant variable in the model so we will remove this variable from the model:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex.lreg }\OtherTok{\textless{}{-}} \FunctionTok{update}\NormalTok{(salex.lreg, . }\SpecialCharTok{\textasciitilde{}}\NormalTok{ . }\SpecialCharTok{{-}}\NormalTok{ MUSHROOM)}
\FunctionTok{summary}\NormalTok{(salex.lreg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = ILL ~ EGGS + PASTA + LETTUCE, family = binomial(logit), 
##     data = salex)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.2024  -0.5108   0.2038   0.4304   2.0501  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(>|z|)    
## (Intercept)  -1.9710     0.6146  -3.207  0.00134 ** 
## EGGS          2.6391     0.7334   3.599  0.00032 ***
## PASTA         1.6646     0.8376   1.987  0.04689 *  
## LETTUCE       3.1956     1.1516   2.775  0.00552 ** 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 97.648  on 75  degrees of freedom
## Residual deviance: 50.529  on 72  degrees of freedom
##   (1 observation deleted due to missingness)
## AIC: 58.529
## 
## Number of Fisher Scoring iterations: 6
\end{verbatim}

~

There are now no non-significant variables in the model.

\newpage

Unfortunately \texttt{R} does not present information on the model coefficients in terms of odds ratios and confidence intervals but we can write a function to calculate them for us.

The first step in doing this is to realise that the \texttt{salex.lreg} object contains essential information about the fitted model. To calculate odds ratios and confidence intervals we need the regression coefficients and their standard errors. Both:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(salex.lreg)}\SpecialCharTok{$}\NormalTok{coefficients}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              Estimate Std. Error   z value     Pr(>|z|)
## (Intercept) -1.970967  0.6145691 -3.207071 0.0013409398
## EGGS         2.639115  0.7333899  3.598515 0.0003200388
## PASTA        1.664581  0.8375970  1.987330 0.0468858898
## LETTUCE      3.195594  1.1516159  2.774879 0.0055222320
\end{verbatim}

~

and:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{coef}\NormalTok{(}\FunctionTok{summary}\NormalTok{(salex.lreg))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              Estimate Std. Error   z value     Pr(>|z|)
## (Intercept) -1.970967  0.6145691 -3.207071 0.0013409398
## EGGS         2.639115  0.7333899  3.598515 0.0003200388
## PASTA        1.664581  0.8375970  1.987330 0.0468858898
## LETTUCE      3.195594  1.1516159  2.774879 0.0055222320
\end{verbatim}

~

extract the data that we require. The preferred method is to use the \texttt{coef()} function. This is because some fitted models may return coefficients in a more complicated manner than (e.g.) those created by the \texttt{glm()} function. The \texttt{coef()} function provides a standard way of extracting this data from all classes of fitted objects.

\newpage

We can store the \texttt{coefficients} data in a separate object to make it easier to work with:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex.lreg.coeffs }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(}\FunctionTok{summary}\NormalTok{(salex.lreg))}
\NormalTok{salex.lreg.coeffs}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              Estimate Std. Error   z value     Pr(>|z|)
## (Intercept) -1.970967  0.6145691 -3.207071 0.0013409398
## EGGS         2.639115  0.7333899  3.598515 0.0003200388
## PASTA        1.664581  0.8375970  1.987330 0.0468858898
## LETTUCE      3.195594  1.1516159  2.774879 0.0055222320
\end{verbatim}

~

We can extract information from this object by addressing each piece of information by its row and column position in the object. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex.lreg.coeffs[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2.639115
\end{verbatim}

~

Is the regression coefficient for \texttt{EGGS}, and:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex.lreg.coeffs[}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.837597
\end{verbatim}

~

is the standard error of the regression coefficient for \texttt{PASTA}. Similarly:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex.lreg.coeffs[ ,}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (Intercept)        EGGS       PASTA     LETTUCE 
##   -1.970967    2.639115    1.664581    3.195594
\end{verbatim}

\newpage

Returns the regression coefficients for all of the variables in the model, and:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex.lreg.coeffs[ ,}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## (Intercept)        EGGS       PASTA     LETTUCE 
##   0.6145691   0.7333899   0.8375970   1.1516159
\end{verbatim}

~

Returns the standard errors of the regression coefficients.

The table below shows the indices that address each cell in the table of regression coefficients:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{matrix}\NormalTok{(salex.lreg.coeffs, }\AttributeTok{nrow =} \DecValTok{4}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##           [,1]      [,2]      [,3]         [,4]
## [1,] -1.970967 0.6145691 -3.207071 0.0013409398
## [2,]  2.639115 0.7333899  3.598515 0.0003200388
## [3,]  1.664581 0.8375970  1.987330 0.0468858898
## [4,]  3.195594 1.1516159  2.774879 0.0055222320
\end{verbatim}

~

We can use this information to calculate odds ratio sand 95\% confidence intervals:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{or }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(salex.lreg.coeffs[ ,}\DecValTok{1}\NormalTok{])}
\NormalTok{lci }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(salex.lreg.coeffs[ ,}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ salex.lreg.coeffs[ ,}\DecValTok{2}\NormalTok{])}
\NormalTok{uci }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(salex.lreg.coeffs[ ,}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ salex.lreg.coeffs[ ,}\DecValTok{2}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

~

and make a single object that contains all of the required information:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lreg.or }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(or, lci, uci)}
\NormalTok{lreg.or}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                     or       lci         uci
## (Intercept)  0.1393221 0.0417723   0.4646777
## EGGS        14.0008053 3.3256684  58.9423019
## PASTA        5.2834608 1.0231552  27.2832114
## LETTUCE     24.4246856 2.5559581 233.4018193
\end{verbatim}

~

We seldom need to report estimates and confidence intervals to more than two decimal places. We can use the \texttt{round()} function to remove the excess digits:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{round}\NormalTok{(lreg.or, }\AttributeTok{digits =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                or  lci    uci
## (Intercept)  0.14 0.04   0.46
## EGGS        14.00 3.33  58.94
## PASTA        5.28 1.02  27.28
## LETTUCE     24.42 2.56 233.40
\end{verbatim}

~

We have now gone through all the necessary calculations step-by-step but it would be nice to have a function that did it all for us that we could use whenever we needed to.

First we will create a template for the function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lreg.or }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(model, }\AttributeTok{digits =} \DecValTok{2}\NormalTok{) \{\}}
\end{Highlighting}
\end{Shaded}

~

and then use the \texttt{fix()} function to edit the \texttt{lreg.or()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(lreg.or)}
\end{Highlighting}
\end{Shaded}

~

We can now edit this function to add a calculation of odds ratios and 95\% confidence intervals:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(model, }\AttributeTok{digits =} \DecValTok{2}\NormalTok{) \{}
\NormalTok{  lreg.coeffs }\OtherTok{\textless{}{-}} \FunctionTok{coef}\NormalTok{(}\FunctionTok{summary}\NormalTok{(model))}
\NormalTok{  OR }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(lreg.coeffs[ ,}\DecValTok{1}\NormalTok{])}
\NormalTok{  LCI }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(lreg.coeffs[ ,}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ lreg.coeffs[ ,}\DecValTok{2}\NormalTok{])}
\NormalTok{  UCI }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(lreg.coeffs[ ,}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ lreg.coeffs[ ,}\DecValTok{2}\NormalTok{])}
\NormalTok{  lreg.or }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(OR, LCI, UCI), }\AttributeTok{digits =}\NormalTok{ digits)}
\NormalTok{  lreg.or}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

Once you have made the changes shown above, check your work, save the file, and quit the editor.

We can test our function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lreg.or}\NormalTok{(salex.lreg)}
\end{Highlighting}
\end{Shaded}

~

Which produces the following output:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lreg.or}\NormalTok{(salex.lreg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                OR  LCI    UCI
## (Intercept)  0.14 0.04   0.46
## EGGS        14.00 3.33  58.94
## PASTA        5.28 1.02  27.28
## LETTUCE     24.42 2.56 233.40
\end{verbatim}

~

The \texttt{digits} parameter of the \texttt{lreg.or()} function, which has \texttt{digits\ =\ 2} as its default value, allows us to specify the precision with which the estimates and their confidence intervals are reported:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lreg.or}\NormalTok{(salex.lreg, }\AttributeTok{digits =} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                  OR    LCI      UCI
## (Intercept)  0.1393 0.0418   0.4647
## EGGS        14.0008 3.3257  58.9423
## PASTA        5.2835 1.0232  27.2832
## LETTUCE     24.4247 2.5560 233.4018
\end{verbatim}

~

Before we continue, it is probably a good idea to save this function for later use:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(lreg.or, }\AttributeTok{file =} \StringTok{"lregor.r"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\newpage

Which can be reloaded whenever it is needed:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\StringTok{"lregor.r"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

An alternative to using logistic regression with data that contains associations that may be due to confounding is to use stratified analysis (i.e.~\emph{Mantel-Haenszel} techniques). With several potential confounders, a stratified analysis results in the analysis of many tables which can be difficult to interpret. For example, four potential confounders, each with two levels would produce sixteen tables. In such situations, logistic regression might be a better approach. In order to illustrate Mantel-Haenszel techniques in \texttt{R} we will work with a simpler dataset.

On Saturday, 21st April 1990, a luncheon was held in the home of Jean Bateman. There was a total of forty-five guests which included thirty-five members of the Department of Epidemiology and Population Sciences at the London School of Hygiene and Tropical Medicine. On Sunday morning, 22nd April 1990, Jean awoke with symptoms of gastrointestinal illness; her husband awoke with similar symptoms. The possibility of an outbreak related to the luncheon was strengthened when several of the guests telephoned Jean on Sunday and reported illness. On Monday, 23rd April 1990, there was an unusually large number of department members absent from work and reporting illness. Data from this outbreak is stored in the file \texttt{bateman.dat}.

The variables in the file \texttt{bateman.dat} are:

~

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.22}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.47}}@{}}
\toprule
\endhead
\textbf{ILL} & Ill? \\
\textbf{CHEESE} & Cheddar cheese \\
\textbf{CRABDIP} & Crab dip \\
\textbf{CRISPS} & Crisps \\
\textbf{BREAD} & French bread \\
\textbf{CHICKEN} & Chicken (roasted, served warm) \\
\textbf{RICE} & Rice (boiled, served warm) \\
\textbf{CAESAR} & Caesar salad \\
\textbf{TOMATO} & Tomato salad \\
\textbf{ICECREAM} & Vanilla ice-cream \\
\textbf{CAKE} & Chocolate cake \\
\textbf{JUICE} & Orange juice \\
\textbf{WINE} & White wine \\
\textbf{COFFEE} & Coffee \\
\bottomrule
\end{longtable}

\newpage

Data is available for all forty-five guests at the luncheon. All of the variables are coded 1=yes, 2=no. Retrieve and attach the \texttt{bateman} dataset in \texttt{R}:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bateman }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"bateman.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{bateman}
\FunctionTok{attach}\NormalTok{(bateman)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   ILL CHEESE CRABDIP CRISPS BREAD CHICKEN RICE CAESAR TOMATO ICECREAM CAKE
## 1   1      1       1      1     2       1    1      1      1        1    1
## 2   2      1       1      1     2       1    2      2      2        1    1
## 3   1      2       2      1     2       1    2      1      2        1    1
## 4   1      1       2      1     1       1    2      1      2        1    1
## 5   1      1       1      1     2       1    1      1      1        2    1
## 6   1      1       1      1     1       1    2      1      1        2    1
##   JUICE WINE COFFEE
## 1     1    1      1
## 2     1    1      2
## 3     2    1      2
## 4     2    1      2
## 5     1    1      1
## 6     1    2      2
\end{verbatim}

\begin{verbatim}
## The following objects are masked from salex:
## 
##     CRISPS, ILL, RICE, TOMATO
\end{verbatim}

~

We will use our \texttt{tab2by2()} function to analyse this data. Retrieve this function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\StringTok{"tab2by2.r"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\newpage

Use the \texttt{tab2by2()} function to analyse the data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(CHEESE, ILL)}
\FunctionTok{tab2by2}\NormalTok{(CRABDIP, ILL)}
\FunctionTok{tab2by2}\NormalTok{(CRISPS, ILL)}
\FunctionTok{tab2by2}\NormalTok{(BREAD, ILL)}
\FunctionTok{tab2by2}\NormalTok{(CHICKEN, ILL)}
\FunctionTok{tab2by2}\NormalTok{(RICE, ILL)}
\FunctionTok{tab2by2}\NormalTok{(CAESAR, ILL)}
\FunctionTok{tab2by2}\NormalTok{(TOMATO, ILL)}
\FunctionTok{tab2by2}\NormalTok{(ICECREAM, ILL)}
\FunctionTok{tab2by2}\NormalTok{(CAKE, ILL)}
\FunctionTok{tab2by2}\NormalTok{(JUICE, ILL)}
\FunctionTok{tab2by2}\NormalTok{(WINE, ILL)}
\FunctionTok{tab2by2}\NormalTok{(COFFEE, ILL)}
\end{Highlighting}
\end{Shaded}

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(CHEESE, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 15  7
##        2 14  9
## 
## Relative Risk     : 1.12013 
## 95% CI            : 0.7253229 1.729838 
## 
## Sample Odds Ratio : 1.377551 
## 95% CI            : 0.4037553 4.699992 
## 
## MLE Odds Ratio    : 1.367743 
## 95% CI            : 0.3427732 5.649399
\end{verbatim}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(CRABDIP, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 18  9
##        2 11  7
## 
## Relative Risk     : 1.090909 
## 95% CI            : 0.6921784 1.719329 
## 
## Sample Odds Ratio : 1.272727 
## 95% CI            : 0.3682028 4.3993 
## 
## MLE Odds Ratio    : 1.265848 
## 95% CI            : 0.3042941 5.188297
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(CRISPS, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 21 12
##        2  8  4
## 
## Relative Risk     : 0.9545455 
## 95% CI            : 0.5930168 1.536478 
## 
## Sample Odds Ratio : 0.875 
## 95% CI            : 0.2170373 3.527619 
## 
## MLE Odds Ratio    : 0.8775841 
## 95% CI            : 0.1587568 4.184763
\end{verbatim}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(BREAD, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1  9  8
##        2 20  8
## 
## Relative Risk     : 0.7411765 
## 95% CI            : 0.4469843 1.228997 
## 
## Sample Odds Ratio : 0.45 
## 95% CI            : 0.1280647 1.581232 
## 
## MLE Odds Ratio    : 0.4584416 
## 95% CI            : 0.1072622 1.897017
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(CHICKEN, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 25 11
##        2  4  5
## 
## Relative Risk     : 1.5625 
## 95% CI            : 0.7293337 3.347448 
## 
## Sample Odds Ratio : 2.840909 
## 95% CI            : 0.637796 12.65415 
## 
## MLE Odds Ratio    : 2.76979 
## 95% CI            : 0.4912167 16.93409
\end{verbatim}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(RICE, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 22 10
##        2  7  6
## 
## Relative Risk     : 1.276786 
## 95% CI            : 0.7330759 2.223756 
## 
## Sample Odds Ratio : 1.885714 
## 95% CI            : 0.5027038 7.073586 
## 
## MLE Odds Ratio    : 1.85813 
## 95% CI            : 0.4026256 8.531602
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(CAESAR, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 26  5
##        2  3 11
## 
## Relative Risk     : 3.913978 
## 95% CI            : 1.418617 10.7987 
## 
## Sample Odds Ratio : 19.06667 
## 95% CI            : 3.866585 94.02038 
## 
## MLE Odds Ratio    : 17.33517 
## 95% CI            : 3.179027 133.7994
\end{verbatim}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(TOMATO, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 24  6
##        2  5 10
## 
## Relative Risk     : 2.4 
## 95% CI            : 1.14769 5.018775 
## 
## Sample Odds Ratio : 8 
## 95% CI            : 1.97785 32.35836 
## 
## MLE Odds Ratio    : 7.553116 
## 95% CI            : 1.642249 41.02567
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(ICECREAM, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 20  9
##        2  9  7
## 
## Relative Risk     : 1.226054 
## 95% CI            : 0.7463643 2.01404 
## 
## Sample Odds Ratio : 1.728395 
## 95% CI            : 0.4889138 6.110177 
## 
## MLE Odds Ratio    : 1.7069 
## 95% CI            : 0.4021245 7.255001
\end{verbatim}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(CAKE, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 22 11
##        2  7  5
## 
## Relative Risk     : 1.142857 
## 95% CI            : 0.6689315 1.95255 
## 
## Sample Odds Ratio : 1.428571 
## 95% CI            : 0.3678242 5.548347 
## 
## MLE Odds Ratio    : 1.416945 
## 95% CI            : 0.2847257 6.685098
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(JUICE, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1  8  5
##        2 21 11
## 
## Relative Risk     : 0.9377289 
## 95% CI            : 0.5701453 1.542301 
## 
## Sample Odds Ratio : 0.8380952 
## 95% CI            : 0.2206785 3.182927 
## 
## MLE Odds Ratio    : 0.8414367 
## 95% CI            : 0.185464 4.101313
\end{verbatim}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(WINE, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 22 12
##        2  7  4
## 
## Relative Risk     : 1.016807 
## 95% CI            : 0.6099343 1.695094 
## 
## Sample Odds Ratio : 1.047619 
## 95% CI            : 0.2543383 4.315141 
## 
## MLE Odds Ratio    : 1.046515 
## 95% CI            : 0.1855742 5.186546
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(COFFEE, ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 17 11
##        2 12  5
## 
## Relative Risk     : 0.860119 
## 95% CI            : 0.5607997 1.319196 
## 
## Sample Odds Ratio : 0.6439394 
## 95% CI            : 0.1772875 2.338901 
## 
## MLE Odds Ratio    : 0.6502015 
## 95% CI            : 0.1388979 2.729586
\end{verbatim}

\newpage

Two variables (\texttt{CAESAR} and \texttt{TOMATO}) are associated with \texttt{ILL}.

These two variables are also associated with each other:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(CAESAR, TOMATO)}
\FunctionTok{chisq.test}\NormalTok{(}\FunctionTok{table}\NormalTok{(CAESAR, TOMATO))}
\FunctionTok{fisher.test}\NormalTok{(}\FunctionTok{table}\NormalTok{(CAESAR, TOMATO))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(CAESAR, TOMATO)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure  1  2
##        1 27  4
##        2  3 11
## 
## Relative Risk     : 4.064516 
## 95% CI            : 1.477162 11.1838 
## 
## Sample Odds Ratio : 24.75 
## 95% CI            : 4.738936 129.2616 
## 
## MLE Odds Ratio    : 22.10962 
## 95% CI            : 3.850174 183.4671
\end{verbatim}

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{chisq.test}\NormalTok{(}\FunctionTok{table}\NormalTok{(CAESAR, TOMATO))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in chisq.test(table(CAESAR, TOMATO)): Chi-squared approximation may be
## incorrect
\end{verbatim}

\begin{verbatim}
## 
##  Pearson's Chi-squared test with Yates' continuity correction
## 
## data:  table(CAESAR, TOMATO)
## X-squared = 15.877, df = 1, p-value = 6.759e-05
\end{verbatim}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fisher.test}\NormalTok{(}\FunctionTok{table}\NormalTok{(CAESAR, TOMATO))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Fisher's Exact Test for Count Data
## 
## data:  table(CAESAR, TOMATO)
## p-value = 3.442e-05
## alternative hypothesis: true odds ratio is not equal to 1
## 95 percent confidence interval:
##    3.850174 183.467108
## sample estimates:
## odds ratio 
##   22.10962
\end{verbatim}

~

This suggests the potential for one of these associations to be due to confounding. We can perform a simple stratified analysis using the \texttt{table()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(CAESAR, ILL, TOMATO)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## , , TOMATO = 1
## 
##       ILL
## CAESAR  1  2
##      1 23  4
##      2  1  2
## 
## , , TOMATO = 2
## 
##       ILL
## CAESAR  1  2
##      1  3  1
##      2  2  9
\end{verbatim}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(TOMATO, ILL, CAESAR)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## , , CAESAR = 1
## 
##       ILL
## TOMATO  1  2
##      1 23  4
##      2  3  1
## 
## , , CAESAR = 2
## 
##       ILL
## TOMATO  1  2
##      1  1  2
##      2  2  9
\end{verbatim}

~

It would be useful to calculate odds ratios for each stratum. We can define a simple function to calculate an odds ratio from a two-by-two table:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{or }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{(x[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{] }\SpecialCharTok{/}\NormalTok{ x[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{]) }\SpecialCharTok{/}\NormalTok{ (x[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{] }\SpecialCharTok{/}\NormalTok{ x[}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{])\}}
\end{Highlighting}
\end{Shaded}

~

We can use \texttt{apply()} to apply the \texttt{or()} function to the two-by-two table in each stratum:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tabC }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(CAESAR, ILL, TOMATO)}
\FunctionTok{apply}\NormalTok{(tabC, }\DecValTok{3}\NormalTok{, or)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    1    2 
## 11.5 13.5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tabT }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(TOMATO, ILL, CAESAR)}
\FunctionTok{apply}\NormalTok{(tabT, }\DecValTok{3}\NormalTok{, or)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        1        2 
## 1.916667 2.250000
\end{verbatim}

~

The 3 instructs the \texttt{apply()} function to apply the \texttt{or()} function to the third dimension of the table objects (i.e.~levels of the potential confounder in \texttt{tabC} and \texttt{tabT}).

The \texttt{mantelhaen.test()} function performs the stratified analysis:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mantelhaen.test}\NormalTok{(tabC)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Mantel-Haenszel chi-squared test with continuity correction
## 
## data:  tabC
## Mantel-Haenszel X-squared = 5.752, df = 1, p-value = 0.01647
## alternative hypothesis: true common odds ratio is not equal to 1
## 95 percent confidence interval:
##   1.878994 83.156212
## sample estimates:
## common odds ratio 
##              12.5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mantelhaen.test}\NormalTok{(tabT)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Mantel-Haenszel chi-squared test with continuity correction
## 
## data:  tabT
## Mantel-Haenszel X-squared = 0.049144, df = 1, p-value = 0.8246
## alternative hypothesis: true common odds ratio is not equal to 1
## 95 percent confidence interval:
##   0.3156862 13.4192331
## sample estimates:
## common odds ratio 
##          2.058219
\end{verbatim}

~

It is likely that \texttt{CAESAR} salad was a vehicle of food-poisoning, and that \texttt{TOMATO} salad was not a vehicle of food-poisoning. Many of those at the luncheon ate both \texttt{CAESAR} salad and \texttt{TOMATO} salad. \texttt{CAESAR} confounded the relationship between \texttt{TOMATO} and \texttt{ILL}. This resulted in a spurious association between \texttt{TOMATO} and \texttt{ILL}.

It only makes sense to calculate a common odds ratio in the absence of interaction. We can check for interaction `by eye' by examining and comparing the odds ratios for each stratum as we did above.

\newpage

There does appear to be an interaction between \texttt{CAESAR}, \texttt{WINE}, and \texttt{ILL}:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tabW }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(CAESAR, ILL, WINE)}
\FunctionTok{apply}\NormalTok{(tabW, }\DecValTok{3}\NormalTok{, or)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    1    2 
## 63.0  2.5
\end{verbatim}

~

\emph{Woolf's test} for interaction (also known as \emph{Woolf's test for the homogeneity of odds ratios}) provides a formal test for interaction.

\texttt{R} does not provide a function to perform \emph{Woolf's test} for the homogeneity of odds ratios but it is possible to write a function to perform this test.

First we will create a template for the function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{woolf.test }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{\}}
\end{Highlighting}
\end{Shaded}

~

And then use the \texttt{fix()} function to edit the \texttt{woolf.test()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(woolf.test)}
\end{Highlighting}
\end{Shaded}

~

We can now edit this function to make it do something useful:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  x }\OtherTok{\textless{}{-}}\NormalTok{ x }\SpecialCharTok{+} \FloatTok{0.5}
\NormalTok{  k }\OtherTok{\textless{}{-}} \FunctionTok{dim}\NormalTok{(x)[}\DecValTok{3}\NormalTok{]}
\NormalTok{  or }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(x, }\DecValTok{3}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x)}
\NormalTok{              \{(x[}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{] }\SpecialCharTok{/}\NormalTok{ x[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{]) }\SpecialCharTok{/}\NormalTok{ (x[}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{] }\SpecialCharTok{/}\NormalTok{ x[}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{])\})}
\NormalTok{  w }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(x, }\DecValTok{3}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) \{}\DecValTok{1} \SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(}\DecValTok{1} \SpecialCharTok{/}\NormalTok{ x)\})}
\NormalTok{  chi.sq }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(w }\SpecialCharTok{*}\NormalTok{ (}\FunctionTok{log}\NormalTok{(or) }\SpecialCharTok{{-}} \FunctionTok{weighted.mean}\NormalTok{(}\FunctionTok{log}\NormalTok{(or), w))}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{  p }\OtherTok{\textless{}{-}} \FunctionTok{pchisq}\NormalTok{(chi.sq, }\AttributeTok{df =}\NormalTok{ k }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{, }\AttributeTok{lower.tail =} \ConstantTok{FALSE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{Woolf\textquotesingle{}s X2 :"}\NormalTok{, chi.sq,}
      \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{p{-}value    :"}\NormalTok{, p, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

Once you have made the changes shown above, check your work, save the file, and quit the editor.
We can use the \texttt{woolf.test()} function to test for a three-way interaction between \texttt{CAESAR}, \texttt{WINE}, and \texttt{ILL}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{woolf.test}\NormalTok{(tabW)}
\end{Highlighting}
\end{Shaded}

~

Which returns:

~

\begin{verbatim}
## 
## Woolf's X2 : 3.319492 
## p-value    : 0.06846297
\end{verbatim}

~

Which is weak evidence of an interaction.

We should test for interaction between \texttt{CAESAR}, \texttt{TOMATO}, and \texttt{ILL} before accepting the results reported by
the \texttt{mantelhaen.test()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{woolf.test}\NormalTok{(tabC)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Woolf's X2 : 0.0001233783 
## p-value    : 0.9911376
\end{verbatim}

~

We can repeat this analysis using logistic regression.

\newpage

We need to change the coding of the variables to 0 and 1 before specifying the model:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{detach}\NormalTok{(bateman)}
\NormalTok{bateman }\OtherTok{\textless{}{-}} \DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ bateman}
\NormalTok{bateman}
\NormalTok{bateman.lreg }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ ILL }\SpecialCharTok{\textasciitilde{}}\NormalTok{ CAESAR }\SpecialCharTok{+}\NormalTok{ TOMATO,}
                    \AttributeTok{family =} \FunctionTok{binomial}\NormalTok{(logit), }\AttributeTok{data =}\NormalTok{ bateman)}
\FunctionTok{summary}\NormalTok{(bateman.lreg)}
\NormalTok{bateman.lreg }\OtherTok{\textless{}{-}} \FunctionTok{update}\NormalTok{(bateman.lreg, . }\SpecialCharTok{\textasciitilde{}}\NormalTok{ . }\SpecialCharTok{{-}}\NormalTok{ TOMATO)}
\FunctionTok{summary}\NormalTok{(bateman.lreg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = ILL ~ CAESAR + TOMATO, family = binomial(logit), 
##     data = bateman)
## 
## Deviance Residuals: 
##    Min      1Q  Median      3Q     Max  
## -1.960  -0.641   0.563   0.563   1.835  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(>|z|)   
## (Intercept)  -1.4780     0.7101  -2.082  0.03739 * 
## CAESAR        2.5202     0.9653   2.611  0.00904 **
## TOMATO        0.7197     0.9552   0.753  0.45116   
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 58.574  on 44  degrees of freedom
## Residual deviance: 41.408  on 42  degrees of freedom
## AIC: 47.408
## 
## Number of Fisher Scoring iterations: 4
\end{verbatim}

\begin{verbatim}
## 
## Call:
## glm(formula = ILL ~ CAESAR, family = binomial(logit), data = bateman)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.9103  -0.6945   0.5931   0.5931   1.7552  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(>|z|)    
## (Intercept)  -1.2993     0.6513  -1.995 0.046066 *  
## CAESAR        2.9479     0.8141   3.621 0.000293 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 58.574  on 44  degrees of freedom
## Residual deviance: 41.940  on 43  degrees of freedom
## AIC: 45.94
## 
## Number of Fisher Scoring iterations: 4
\end{verbatim}

\newpage

Interactions are specified using the multiply (\texttt{*}) symbol in the model formula:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bateman.lreg }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ ILL }\SpecialCharTok{\textasciitilde{}}\NormalTok{ CAESAR }\SpecialCharTok{+}\NormalTok{ WINE }\SpecialCharTok{+}\NormalTok{ CAESAR }\SpecialCharTok{*}\NormalTok{ WINE,}
                    \AttributeTok{family =} \FunctionTok{binomial}\NormalTok{(logit), }\AttributeTok{data =}\NormalTok{ bateman)}
\FunctionTok{summary}\NormalTok{(bateman.lreg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = ILL ~ CAESAR + WINE + CAESAR * WINE, family = binomial(logit), 
##     data = bateman)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.0393  -0.4590   0.5168   0.5168   2.1460  
## 
## Coefficients:
##               Estimate Std. Error z value Pr(>|z|)  
## (Intercept) -1.092e-15  1.000e+00   0.000   1.0000  
## CAESAR       9.163e-01  1.304e+00   0.703   0.4822  
## WINE        -2.197e+00  1.453e+00  -1.512   0.1305  
## CAESAR:WINE  3.227e+00  1.787e+00   1.806   0.0709 .
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 58.574  on 44  degrees of freedom
## Residual deviance: 38.508  on 41  degrees of freedom
## AIC: 46.508
## 
## Number of Fisher Scoring iterations: 4
\end{verbatim}

~

Before we continue, it is probably a good idea to save the \texttt{woolf.test()} function for later use:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{save}\NormalTok{(woolf.test, }\AttributeTok{file =} \StringTok{"woolf.r"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

\hypertarget{matched-data}{%
\section{Matched data}\label{matched-data}}

\emph{Matching} is another way to control for the effects of potential confounding variables. Matching is usually performed during data-collection as part of the design of a study.

In a matched case-control studies, each case is matched with one or more controls which are chosen to have the same values over a set of potential confounding variables.
In order to illustrate how matched data may be analysed using tabulation and stratification in \texttt{R} we will start with the simple case of one-to-one matching (i.e.~each case has a single matched control):

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{octe }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"octe.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{octe[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    ID CASE OC
## 1   1    1  1
## 2   1    2  1
## 3   2    1  1
## 4   2    2  1
## 5   3    1  1
## 6   3    2  1
## 7   4    1  1
## 8   4    2  1
## 9   5    1  1
## 10  5    2  1
\end{verbatim}

~

This data is from a matched case-control study investigating the association between oral contraceptive use and thromboembolism. The cases are 175 women aged between 15 and 44 years admitted to hospital for thromboembolism and discharged alive. The controls are female patients admitted for conditions believed to be unrelated to oral contraceptive use. Cases and controls were matched on age, ethnic group, marital status, parity, income, place of residence, and date of hospitalisation. The variables in the dataset are:

\newpage

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.20}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.80}}@{}}
\toprule
\endhead
\textbf{ID} & Identifier for the matched sets of cases and controls \\
\textbf{CASE} & Case (1) or control (2) \\
\textbf{OC} & Used oral contraceptives in the previous month (1=yes, 2=no) \\
\bottomrule
\end{longtable}

~

The dataset consists of 350 records:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nrow}\NormalTok{(octe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 350
\end{verbatim}

~

There are 175 matched sets of cases and controls:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(octe}\SpecialCharTok{$}\NormalTok{ID))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 175
\end{verbatim}

~

In each matched set of cases and controls there is one case and one control:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(octe}\SpecialCharTok{$}\NormalTok{ID, octe}\SpecialCharTok{$}\NormalTok{CASE)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     
##      1 2
##   1  1 1
##   2  1 1
##   3  1 1
##   4  1 1
##   5  1 1
##   6  1 1
##   7  1 1
##   8  1 1
##   9  1 1
##   10 1 1
\end{verbatim}

\newpage

This data may be analysed using \emph{McNemar's chi-squared test} which use the number of discordant (i.e.~relative to exposure) pairs of matched cases and controls.

To find the number of discordant pairs we need to split the dataset into cases and controls:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{octe.cases }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(octe, CASE }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}
\NormalTok{octe.controls }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(octe, CASE }\SpecialCharTok{==} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

Sorting these two datasets (i.e.~\texttt{octe.cases} and \texttt{octe.controls}) by the \texttt{ID} variable simplifies the analysis:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{octe.cases }\OtherTok{\textless{}{-}}\NormalTok{ octe.cases[}\FunctionTok{order}\NormalTok{(octe.cases}\SpecialCharTok{$}\NormalTok{ID), ]}
\NormalTok{octe.controls }\OtherTok{\textless{}{-}}\NormalTok{ octe.controls[}\FunctionTok{order}\NormalTok{(octe.controls}\SpecialCharTok{$}\NormalTok{ID), ]}
\end{Highlighting}
\end{Shaded}

~

Since the two datasets (i.e.~\texttt{octe.cases} and \texttt{octe.controls}) are now sorted by the \texttt{ID} variable we can use the \texttt{table()} function to retrieve the number if concordant and discordant pairs and store them in a table object:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(octe.cases}\SpecialCharTok{$}\NormalTok{OC, octe.controls}\SpecialCharTok{$}\NormalTok{OC)}
\NormalTok{tab}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    
##      1  2
##   1 10 57
##   2 13 95
\end{verbatim}

~

This table object (i.e.~\texttt{tab}) can then be passed to the \texttt{mcnemar.test()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mcnemar.test}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  McNemar's Chi-squared test with continuity correction
## 
## data:  tab
## McNemar's chi-squared = 26.414, df = 1, p-value = 2.755e-07
\end{verbatim}

~

The \texttt{mcnemar.test()} function does not provide an estimate of the odds ratio. This is the ratio of the discordant pairs:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{r }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{]}
\NormalTok{s }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{rdp }\OtherTok{\textless{}{-}}\NormalTok{ r }\SpecialCharTok{/}\NormalTok{ s}
\NormalTok{rdp}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 4.384615
\end{verbatim}

~

A confidence interval can also be calculated:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ci.p }\OtherTok{\textless{}{-}} \FunctionTok{binom.test}\NormalTok{(r, r }\SpecialCharTok{+}\NormalTok{ s)}\SpecialCharTok{$}\NormalTok{conf.int}
\NormalTok{ci.rdp }\OtherTok{\textless{}{-}}\NormalTok{ ci.p }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ci.p)}
\NormalTok{ci.rdp}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2.371377 8.731311
## attr(,"conf.level")
## [1] 0.95
\end{verbatim}

~

This provides a 95\% confidence interval. Other (e.g.~99\%) confidence intervals can be produced by specifying appropriate values for the \texttt{conf.level} parameter of the \texttt{binom.test()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ci.p }\OtherTok{\textless{}{-}} \FunctionTok{binom.test}\NormalTok{(r, r }\SpecialCharTok{+}\NormalTok{ s, }\AttributeTok{conf.level =} \FloatTok{0.99}\NormalTok{)}\SpecialCharTok{$}\NormalTok{conf.int}
\NormalTok{ci.rdp }\OtherTok{\textless{}{-}}\NormalTok{ ci.p }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ci.p)}
\NormalTok{ci.rdp}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1]  2.010478 10.949095
## attr(,"conf.level")
## [1] 0.99
\end{verbatim}

\newpage

An alternative way of analysing this data is to use the \texttt{mantelhaen.test()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(octe}\SpecialCharTok{$}\NormalTok{OC, octe}\SpecialCharTok{$}\NormalTok{CASE, octe}\SpecialCharTok{$}\NormalTok{ID)}
\FunctionTok{mantelhaen.test}\NormalTok{(tab)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Mantel-Haenszel chi-squared test with continuity correction
## 
## data:  tab
## Mantel-Haenszel X-squared = 26.414, df = 1, p-value = 2.755e-07
## alternative hypothesis: true common odds ratio is not equal to 1
## 95 percent confidence interval:
##  2.400550 8.008521
## sample estimates:
## common odds ratio 
##          4.384615
\end{verbatim}

~

The Mantel-Haenszel approach is preferred because it can be used with data from matched case-control studies that match more than one control to each case. Multiple matching is useful when the condition being studied is rare or at the early stages of an outbreak (i.e.~when cases are hard to find and controls are easy to find).

We will now work with some data where each case has one or more controls:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tsstamp }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"tsstamp.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{tsstamp}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    ID CASE RBTAMP
## 1   1    1      1
## 2   1    2      1
## 3   1    2      1
## 4   2    1      1
## 5   2    2      2
## 6   2    2      1
## 7   2    2      1
## 8   3    1      2
## 9   3    2      2
## 10  3    2      1
## 11  4    1      1
## 12  4    2      2
## 13  5    1      1
## 14  5    2      1
## 15  5    2      2
## 16  6    1      1
## 17  6    2      1
## 18  7    1      1
## 19  7    2      2
## 20  7    2      2
## 21  8    1      1
## 22  8    2      1
## 23  8    2      2
## 24  9    1      2
## 25  9    2      1
## 26  9    2      2
## 27  9    2      2
## 28 10    1      1
## 29 10    2      2
## 30 10    2      2
## 31 11    1      1
## 32 11    2      2
## 33 11    2      2
## 34 12    1      1
## 35 12    2      2
## 36 12    2      2
## 37 12    2      2
## 38 13    1      1
## 39 13    2      2
## 40 13    2      2
## 41 14    1      2
## 42 14    2      2
## 43 14    2      2
\end{verbatim}

~

This data is from a matched case-control study investigating the association between the use of different brands of tampon and toxic shock syndrome undertaken during an outbreak. Only a subset of the original dataset is used here. The variables in the dataset are:

\newpage

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.21}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.79}}@{}}
\toprule
\endhead
\textbf{ID} & Identifier for the matched sets of cases and controls \\
\textbf{CASE} & Case (1) or control (2) \\
\textbf{RBTAMP} & Used Rely brand tampons (1=yes, 2=no) \\
\bottomrule
\end{longtable}

~

The dataset consists of forty-three (43) records:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{nrow}\NormalTok{(tsstamp)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 43
\end{verbatim}

~

There are fourteen (14) matched sets of cases and controls:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(tsstamp}\SpecialCharTok{$}\NormalTok{ID))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 14
\end{verbatim}

~

Each matched set of cases and controls consists of one case and one or more controls:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(tsstamp}\SpecialCharTok{$}\NormalTok{ID, tsstamp}\SpecialCharTok{$}\NormalTok{CASE)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     
##      1 2
##   1  1 2
##   2  1 3
##   3  1 2
##   4  1 1
##   5  1 2
##   6  1 1
##   7  1 2
##   8  1 2
##   9  1 3
##   10 1 2
##   11 1 2
##   12 1 3
##   13 1 2
##   14 1 2
\end{verbatim}

~

The \emph{McNemar's chi-squared test} is not useful for this data as it is limited to the special case of one-to-one matching.

Analysing this data using a simple tabulation such as:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fisher.test}\NormalTok{(}\FunctionTok{table}\NormalTok{(tsstamp}\SpecialCharTok{$}\NormalTok{RBTAMP, tsstamp}\SpecialCharTok{$}\NormalTok{CASE))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Fisher's Exact Test for Count Data
## 
## data:  table(tsstamp$RBTAMP, tsstamp$CASE)
## p-value = 0.007805
## alternative hypothesis: true odds ratio is not equal to 1
## 95 percent confidence interval:
##   1.542686 53.734756
## sample estimates:
## odds ratio 
##   7.709932
\end{verbatim}

~

ignores the matched nature of the data and is, therefore, also not useful for this data.

The matched nature of the data may be accounted by stratifying on the variable that identifies the matched sets
of cases and controls (i.e.~the \texttt{ID} variable) using the \texttt{mantelhaen.test()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mantelhaen.test}\NormalTok{(}\FunctionTok{table}\NormalTok{(tsstamp}\SpecialCharTok{$}\NormalTok{RBTAMP, tsstamp}\SpecialCharTok{$}\NormalTok{CASE, tsstamp}\SpecialCharTok{$}\NormalTok{ID))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Mantel-Haenszel chi-squared test with continuity correction
## 
## data:  table(tsstamp$RBTAMP, tsstamp$CASE, tsstamp$ID)
## Mantel-Haenszel X-squared = 5.9384, df = 1, p-value = 0.01481
## alternative hypothesis: true common odds ratio is not equal to 1
## 95 percent confidence interval:
##   1.589505 43.191463
## sample estimates:
## common odds ratio 
##          8.285714
\end{verbatim}

~

Analysis of several risk factors or adjustment for confounding variables not matched for in the design of a matched case-control study cannot be performed using tabulation-based procedures such as the \texttt{McNemar\textquotesingle{}s\ chi-\ squared\ test} and Mantel-Haenszel procedures. In these situations a special form of logistic regression, called \texttt{conditional\ logistic\ regression}, should be used.

We can now quit \texttt{R}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{q}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

~

For this exercise there is no need to save the workspace image so click the \textbf{No} or \textbf{Don't Save} button (GUI) or enter \texttt{n} when prompted to save the workspace image (terminal).

\hypertarget{summary-2}{%
\section{Summary}\label{summary-2}}

\begin{itemize}
\item
  \texttt{R} provides functions for many kinds of complex statistical analysis. We have looked at using the generalised linear model \texttt{glm()} function to perform logistic regression. We have looked ar the \texttt{mantelhaen.test()} function to perform stratified analyses and the \texttt{mantelhaen.test()} and \texttt{mcnemar.test()} functions to analyse data from matched case-control studies.
\item
  \texttt{R} can be extended by writing new functions. New functions can perform simple or complex data analysis. New functions can be composed of parts of existing function. New functions can be saved and used in subsequent \texttt{R} sessions. By building your own functions you can use \texttt{R} to build your own statistical analysis system.
\end{itemize}

\hypertarget{exercise4}{%
\chapter{Analysing some data with R}\label{exercise4}}

In this exercise we will use the \texttt{R} functions we have already used and the functions we have added to \texttt{R} to
analyse a small dataset. First we will start \texttt{R} and retrieve our functions:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{load}\NormalTok{(}\StringTok{"tab2by2.r"}\NormalTok{)}
\FunctionTok{load}\NormalTok{(}\StringTok{"lregor.r"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

And then retrieve and attach the sample dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gudhiv }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"gudhiv.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{na.strings =} \StringTok{"X"}\NormalTok{)}
\FunctionTok{attach}\NormalTok{(gudhiv)}
\end{Highlighting}
\end{Shaded}

\newpage

This data is from a cross-sectional study of 435 male patients who presented with sexually transmitted infections at an outpatient clinic in The Gambia between August 1988 and June 1990. Several studies have documented an association between genital ulcer disease (GUD) and HIV infection. A study of Gambian prostitutes documented an association between seropositivity for HIV-2 and antibodies against \texttt{Treponema\ pallidum} (a serological test for syphilis). Prostitutes are not the ideal population for such studies as they may have experienced multiple sexually transmitted infections and it is difficult to quantify the number of times they may have had sex with HIV-2 seropositive customers. A sample of males with sexually transmitted infections is easier to study as they have probably had fewer sexual partners than prostitutes and much less contact with sexually transmitted infection pathogens. In such a sample it is also easier to find subjects and collect data. The variables in the dataset are:

~

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.21}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.79}}@{}}
\toprule
\endhead
\textbf{MARRIED} & Married (1=yes, 0=no) \\
\textbf{GAMBIAN} & Gambian Citizen (1=yes, 0=no) \\
\textbf{GUD} & History of GUD or syphilis (1=yes, 0=no) \\
\textbf{UTIGC} & History of urethral discharge (1=yes, 0=no) \\
\textbf{CIR} & Circumcised (1=yes, 0=no) \\
\textbf{TRAVOUT} & Travelled outside of Gambia and Senegal (1=yes, 0=no) \\
\textbf{SEXPRO} & Ever had sex with a prostitute (1=yes, 0=no) \\
\textbf{INJ12M} & Injection in previous 12 months (1=yes, 0=no) \\
\textbf{PARTNERS} & Sexual partners in previous 12 months (number) \\
\textbf{HIV HIV-2} & positive serology (1=yes, 0=no) \\
\bottomrule
\end{longtable}

~

Data is available for all 435 patients enrolled in the study.

We will start our analysis by examining pairwise associations between the binary exposure variables and the
HIV variable using the \texttt{tab2by2()} function that we wrote earlier:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(MARRIED, HIV)}
\FunctionTok{tab2by2}\NormalTok{(GAMBIAN, HIV)}
\FunctionTok{tab2by2}\NormalTok{(GUD, HIV)}
\FunctionTok{tab2by2}\NormalTok{(UTIGC, HIV)}
\FunctionTok{tab2by2}\NormalTok{(CIR, HIV)}
\FunctionTok{tab2by2}\NormalTok{(TRAVOUT, HIV)}
\FunctionTok{tab2by2}\NormalTok{(SEXPRO, HIV)}
\FunctionTok{tab2by2}\NormalTok{(INJ12M, HIV)}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(MARRIED, HIV)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure   0   1
##        0 321  13
##        1  93   8
## 
## Relative Risk     : 1.043751 
## 95% CI            : 0.9818512 1.109554 
## 
## Sample Odds Ratio : 2.124069 
## 95% CI            : 0.8545749 5.279433 
## 
## MLE Odds Ratio    : 2.119801 
## 95% CI            : 0.7380371 5.714354
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(GAMBIAN, HIV)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure   0   1
##        0  73   4
##        1 341  17
## 
## Relative Risk     : 0.9953155 
## 95% CI            : 0.9400068 1.053879 
## 
## Sample Odds Ratio : 0.909824 
## 95% CI            : 0.2974059 2.783333 
## 
## MLE Odds Ratio    : 0.9100104 
## 95% CI            : 0.2853202 3.826485
\end{verbatim}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(GUD, HIV)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure   0   1
##        0 339  12
##        1  72   9
## 
## Relative Risk     : 1.086538 
## 95% CI            : 1.003531 1.176412 
## 
## Sample Odds Ratio : 3.53125 
## 95% CI            : 1.434372 8.693509 
## 
## MLE Odds Ratio    : 3.517408 
## 95% CI            : 1.258556 9.491924
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(UTIGC, HIV)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure   0   1
##        0 261  12
##        1 151   9
## 
## Relative Risk     : 1.013027 
## 95% CI            : 0.9678841 1.060275 
## 
## Sample Odds Ratio : 1.296358 
## 95% CI            : 0.5338453 3.147997 
## 
## MLE Odds Ratio    : 1.295532 
## 95% CI            : 0.4703496 3.438842
\end{verbatim}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(CIR, HIV)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure   0   1
##        0  10   3
##        1 392  17
## 
## Relative Risk     : 0.8025903 
## 95% CI            : 0.5955085 1.081682 
## 
## Sample Odds Ratio : 0.1445578 
## 95% CI            : 0.0364195 0.5737851 
## 
## MLE Odds Ratio    : 0.1460183 
## 95% CI            : 0.03322189 0.899754
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(TRAVOUT, HIV)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure   0   1
##        0 152   2
##        1 256  19
## 
## Relative Risk     : 1.060268 
## 95% CI            : 1.02181 1.100173 
## 
## Sample Odds Ratio : 5.640625 
## 95% CI            : 1.295879 24.55218 
## 
## MLE Odds Ratio    : 5.624226 
## 95% CI            : 1.32716 50.45859
\end{verbatim}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(SEXPRO, HIV)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure   0   1
##        0 268  13
##        1 143   8
## 
## Relative Risk     : 1.007093 
## 95% CI            : 0.9621259 1.054161 
## 
## Sample Odds Ratio : 1.153308 
## 95% CI            : 0.4671083 2.847562 
## 
## MLE Odds Ratio    : 1.152912 
## 95% CI            : 0.4042323 3.083152
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(INJ12M, HIV)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure   0   1
##        0 146   7
##        1 268  14
## 
## Relative Risk     : 1.004097 
## 95% CI            : 0.9610996 1.049018 
## 
## Sample Odds Ratio : 1.089552 
## 95% CI            : 0.4301305 2.759916 
## 
## MLE Odds Ratio    : 1.089351 
## 95% CI            : 0.4006202 3.263814
\end{verbatim}

~

Note that our \texttt{tab2by2()} function returns misleading risk ratio estimates and confidence intervals for this dataset. This is because the function expects the \texttt{exposure} and \texttt{outcome} variables to be ordered with exposure-present and outcome-present as the first category (e.g.~1 = present, 2 = absent). This coding is reversed (i.e.~0 = absent, 1 = present) in the \texttt{gudhiv} dataset.

\newpage

We can produce risk ratio estimates for variables in the \texttt{gudhiv} data using the \texttt{tab2by2()} function and a
simple transformation of the \texttt{exposure} and \texttt{outcome} variables. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{tab2by2}\NormalTok{(}\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ GUD, }\DecValTok{2} \SpecialCharTok{{-}}\NormalTok{ HIV)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##         outcome
## exposure   1   2
##        1   9  72
##        2  12 339
## 
## Relative Risk     : 3.25 
## 95% CI            : 1.417411 7.451965 
## 
## Sample Odds Ratio : 3.53125 
## 95% CI            : 1.434372 8.693509 
## 
## MLE Odds Ratio    : 3.517408 
## 95% CI            : 1.258556 9.491924
\end{verbatim}

~

The odds ratio estimates returned by the \texttt{tab2by2()} function, with or without this transformation, are correct. The \texttt{GUD} and \texttt{TRAVOUT} variables are associated with \texttt{HIV}.

\texttt{PARTNERS} is a continuous variable and we should examine its distribution before doing anything with it:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(PARTNERS)}
\FunctionTok{hist}\NormalTok{(PARTNERS)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(PARTNERS)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## PARTNERS
##   1   2   3   4   5   6   7   8   9 
##  61 129 133  71  25   6   6   2   2
\end{verbatim}

\newpage

\includegraphics{prfe_files/figure-latex/unnamed-chunk-250-1.pdf}

~

The distribution of \texttt{PARTNERS} is severely non-normal. Instead of attempting to transform the variable we will produce summary statistics for each level of the \texttt{HIV} variable and perform a non-parametric test:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{by}\NormalTok{(PARTNERS, HIV, summary)}
\FunctionTok{kruskal.test}\NormalTok{(PARTNERS }\SpecialCharTok{\textasciitilde{}}\NormalTok{ HIV)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## HIV: 0
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##    1.00    2.00    3.00    2.72    3.00    8.00 
## ------------------------------------------------------------ 
## HIV: 1
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   1.000   4.000   5.000   5.381   7.000   9.000
\end{verbatim}

\begin{verbatim}
## 
##  Kruskal-Wallis rank sum test
## 
## data:  PARTNERS by HIV
## Kruskal-Wallis chi-squared = 32.036, df = 1, p-value = 1.514e-08
\end{verbatim}

\newpage

An alternative way of looking at the data is as a tabulation:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(PARTNERS, HIV)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         HIV
## PARTNERS   0   1
##        1  60   1
##        2 128   1
##        3 131   2
##        4  68   3
##        5  21   4
##        6   3   3
##        7   2   4
##        8   1   1
##        9   0   2
\end{verbatim}

~

You can use the \texttt{plot()} function to represent this table graphically:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\FunctionTok{table}\NormalTok{(PARTNERS, HIV), }\AttributeTok{color =} \FunctionTok{c}\NormalTok{(}\StringTok{"lightgreen"}\NormalTok{, }\StringTok{"red"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-254-1.pdf}

\newpage

There appears to be an association between the number of sexual \texttt{PARTNERS} in the previous twelve months and positive \texttt{HIV} serology. The proportion with positive \texttt{HIV} serology increases as the number of sexual partners increases:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{prop.table}\NormalTok{(}\FunctionTok{table}\NormalTok{(PARTNERS, HIV), }\DecValTok{1}\NormalTok{) }\SpecialCharTok{*} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         HIV
## PARTNERS           0           1
##        1  98.3606557   1.6393443
##        2  99.2248062   0.7751938
##        3  98.4962406   1.5037594
##        4  95.7746479   4.2253521
##        5  84.0000000  16.0000000
##        6  50.0000000  50.0000000
##        7  33.3333333  66.6666667
##        8  50.0000000  50.0000000
##        9   0.0000000 100.0000000
\end{verbatim}

~

The \textbf{`1'} instructs the \texttt{prop.table()} function to calculate row proportions. You can also use the \texttt{plot()} function to represent this table graphically:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\FunctionTok{prop.table}\NormalTok{(}\FunctionTok{table}\NormalTok{(PARTNERS, HIV), }\DecValTok{1}\NormalTok{) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\AttributeTok{color =} \FunctionTok{c}\NormalTok{(}\StringTok{"lightgreen"}\NormalTok{, }\StringTok{"red"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-256-1.pdf}

\newpage

The \emph{chi-square test for trend} is an appropriate test to perform on this data. The \texttt{prop.trend.test()} function that performs the \emph{chi-square test for trend} requires you to specify the \emph{number of events} and the \emph{number of trials}. In this table:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(PARTNERS, HIV)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         HIV
## PARTNERS   0   1
##        1  60   1
##        2 128   1
##        3 131   2
##        4  68   3
##        5  21   4
##        6   3   3
##        7   2   4
##        8   1   1
##        9   0   2
\end{verbatim}

~

The \emph{number of events} in each row is in the second column (labelled \textbf{1}) and the \emph{number of trials} is the total number of cases in each row of the table.

We can extract this data from a table object:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(PARTNERS, HIV)}
\NormalTok{events }\OtherTok{\textless{}{-}}\NormalTok{ tab[ ,}\DecValTok{2}\NormalTok{]}
\NormalTok{trials }\OtherTok{\textless{}{-}}\NormalTok{ tab[ ,}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ tab[ ,}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(PARTNERS, HIV)}
\NormalTok{events }\OtherTok{\textless{}{-}}\NormalTok{ tab[ ,}\DecValTok{2}\NormalTok{]}
\NormalTok{trials }\OtherTok{\textless{}{-}}\NormalTok{ tab[ ,}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ tab[ ,}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

~

Another way of creating the \texttt{trials} object would be to use the \texttt{apply()} function to sum the rows of the tab object:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trials }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(tab, }\DecValTok{1}\NormalTok{, sum)}
\end{Highlighting}
\end{Shaded}

\newpage

Pass this data to the \texttt{prop.trend.test()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{prop.trend.test}\NormalTok{(events, trials)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Chi-squared Test for Trend in Proportions
## 
## data:  events out of trials ,
##  using scores: 1 2 3 4 5 6 7 8 9
## X-squared = 76.389, df = 1, p-value < 2.2e-16
\end{verbatim}

~

With a linear trend such as this we can use \texttt{PARTNERS} in a logistic model without recoding or creating indicator variables. We can now specify and fit the logistic regression model:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gudhiv.lreg }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ HIV }\SpecialCharTok{\textasciitilde{}}\NormalTok{ GUD }\SpecialCharTok{+}\NormalTok{ TRAVOUT }\SpecialCharTok{+}\NormalTok{ PARTNERS,}
                   \AttributeTok{family =} \FunctionTok{binomial}\NormalTok{(logit))}
\FunctionTok{summary}\NormalTok{(gudhiv.lreg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = HIV ~ GUD + TRAVOUT + PARTNERS, family = binomial(logit))
## 
## Deviance Residuals: 
##      Min        1Q    Median        3Q       Max  
## -1.70415  -0.19849  -0.11148  -0.06247   3.11742  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(>|z|)    
## (Intercept)  -9.4854     1.4663  -6.469 9.86e-11 ***
## GUD           1.3869     0.5937   2.336   0.0195 *  
## TRAVOUT       2.0867     0.9547   2.186   0.0288 *  
## PARTNERS      1.1605     0.2050   5.662 1.50e-08 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 167.364  on 425  degrees of freedom
## Residual deviance:  99.377  on 422  degrees of freedom
##   (9 observations deleted due to missingness)
## AIC: 107.38
## 
## Number of Fisher Scoring iterations: 8
\end{verbatim}

~

We can use the \texttt{lreg.or()} function that we wrote earlier to calculate and display odds ratios and confidence intervals:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lreg.or}\NormalTok{(gudhiv.lreg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##               OR  LCI   UCI
## (Intercept) 0.00 0.00  0.00
## GUD         4.00 1.25 12.81
## TRAVOUT     8.06 1.24 52.35
## PARTNERS    3.19 2.14  4.77
\end{verbatim}

~

\texttt{PARTNERS} is incorporated into the logistic model as a continuous variable.

The odds ratio reported for \texttt{PARTNERS} is the odds ratio associated with a unit increase in the number of sexual \texttt{PARTNERS}. A man reporting five sexual partners, for example, was over three times as likely (odds ratio = 3.19) to have a positive HIV-2 serology than a man reporting four sexual partners.

An alternative approach would be to have created an \emph{indicator} variables:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{part.gt}\FloatTok{.5} \OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(PARTNERS }\SpecialCharTok{\textgreater{}} \DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

This creates a new variable (\texttt{part.gt.5}) that indicates whether or not an individual subject reported having more than five sexual partners in the previous twelve months:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(PARTNERS, part.gt}\FloatTok{.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         part.gt.5
## PARTNERS   0   1
##        1  61   0
##        2 129   0
##        3 133   0
##        4  71   0
##        5  25   0
##        6   0   6
##        7   0   6
##        8   0   2
##        9   0   2
\end{verbatim}

~

You can also inspect this on a case-by-case basis:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cbind}\NormalTok{(PARTNERS, part.gt}\FloatTok{.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      PARTNERS part.gt.5
## [1,]        2         0
## [2,]        2         0
## [3,]        1         0
## [4,]        2         0
## [5,]        3         0
## [6,]        2         0
\end{verbatim}

~

We can now specify and fit the logistic regression model using our indicator variable:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gudhiv.lreg }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ HIV }\SpecialCharTok{\textasciitilde{}}\NormalTok{ GUD }\SpecialCharTok{+}\NormalTok{ TRAVOUT }\SpecialCharTok{+}\NormalTok{ part.gt}\FloatTok{.5}\NormalTok{,}
                   \AttributeTok{family =} \FunctionTok{binomial}\NormalTok{(logit))}
\FunctionTok{summary}\NormalTok{(gudhiv.lreg)}
\FunctionTok{lreg.or}\NormalTok{(gudhiv.lreg)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = HIV ~ GUD + TRAVOUT + part.gt.5, family = binomial(logit))
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.6092  -0.2205  -0.2205  -0.0719   3.4521  
## 
## Coefficients:
##             Estimate Std. Error z value Pr(>|z|)    
## (Intercept)  -5.9559     0.9850  -6.046 1.48e-09 ***
## GUD           1.4930     0.5805   2.572   0.0101 *  
## TRAVOUT       2.2514     0.9319   2.416   0.0157 *  
## part.gt.5     4.6791     0.7560   6.189 6.05e-10 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 167.36  on 425  degrees of freedom
## Residual deviance: 106.43  on 422  degrees of freedom
##   (9 observations deleted due to missingness)
## AIC: 114.43
## 
## Number of Fisher Scoring iterations: 7
\end{verbatim}

\begin{verbatim}
##                 OR   LCI    UCI
## (Intercept)   0.00  0.00   0.02
## GUD           4.45  1.43  13.89
## TRAVOUT       9.50  1.53  59.02
## part.gt.5   107.67 24.47 473.84
\end{verbatim}

~

We can now quit R:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{q}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

~

For this exercise there is no need to save the workspace image so click the \textbf{No} or \textbf{Don't Save} button (GUI) or enter \texttt{n} when prompted to save the workspace image (terminal).

\hypertarget{summary-3}{%
\section{Summary}\label{summary-3}}

\begin{itemize}
\item
  Using built-in functions and our own functions we can use \texttt{R} to analyse epidemiological data.
\item
  The power of \texttt{R} is that it can be easily extended. Many user-contributed functions (usually packages of related functions) are available for download over the Internet. We will use one of these packages in the next exercise.
\end{itemize}

\hypertarget{exercise5}{%
\chapter{Extending R with packages}\label{exercise5}}

\texttt{R} has no built-in functions for survival analysis but, because it is an extensible system, survival analysis is
available as an add-in package. You can find a list of add-in packages at the \texttt{R} website.

\url{http://www.r-project.org/}

Add-in packages are installed from the Internet. There are a series of \texttt{R} functions that enable you to download and install add-in packages.

The \texttt{survival} package adds functions to \texttt{R} that enable it to analyse survival data. This package may be downloaded and installed using \texttt{install.packages("survival")} or from the \texttt{Packages} or \texttt{Packages\ \&\ Data} menu if you are using a GUI version of \texttt{R}.

Packages are loaded into \texttt{R} as they are needed using the \texttt{library()} function. Start \texttt{R} and load the \texttt{survival} package:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(survival)}
\end{Highlighting}
\end{Shaded}

~

Before we go any further we should retrieve a dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ca }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"ca.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{attach}\NormalTok{(ca)}
\end{Highlighting}
\end{Shaded}

~

The columns in this dataset on the survival of cancer patients in two different treatment groups are as follows:

~

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.22}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.57}}@{}}
\toprule
\endhead
\textbf{time} & Survival or censoring time (months) \\
\textbf{status} & Censoring status (1=dead, 0=censored) \\
\textbf{group} & Treatment group (1 / 2) \\
\bottomrule
\end{longtable}

~

We next need to create a \texttt{survival} object from the \texttt{time} and \texttt{status} variables using the \texttt{Surv()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{response }\OtherTok{\textless{}{-}} \FunctionTok{Surv}\NormalTok{(time, status)}
\end{Highlighting}
\end{Shaded}

~

We can then specify the model for the survival analysis. In this case we state that survival (\texttt{response}) is dependent upon the treatment \texttt{group}:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ca.surv }\OtherTok{\textless{}{-}} \FunctionTok{survfit}\NormalTok{(response }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group)}
\end{Highlighting}
\end{Shaded}

~

The \texttt{summary()} function applied to a \texttt{survfit} object lists the survival probabilities at each time point with 95\% confidence intervals:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(ca.surv)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Call: survfit(formula = response ~ group)
## 
##                 group=1 
##  time n.risk n.event survival std.err lower 95% CI upper 95% CI
##     8     22       1    0.955  0.0444       0.8714        1.000
##     9     21       1    0.909  0.0613       0.7966        1.000
##    13     19       1    0.861  0.0744       0.7270        1.000
##    14     17       1    0.811  0.0856       0.6591        0.997
##    18     16       1    0.760  0.0940       0.5963        0.968
##    19     15       1    0.709  0.1005       0.5373        0.936
##    21     14       1    0.659  0.1053       0.4814        0.901
##    23     13       1    0.608  0.1087       0.4282        0.863
##    30     10       1    0.547  0.1136       0.3643        0.822
##    31      9       1    0.486  0.1161       0.3046        0.776
##    32      8       1    0.426  0.1164       0.2489        0.727
##    34      7       1    0.365  0.1146       0.1971        0.675
##    48      5       1    0.292  0.1125       0.1371        0.621
##    56      3       1    0.195  0.1092       0.0647        0.585
## 
##                 group=2 
##  time n.risk n.event survival std.err lower 95% CI upper 95% CI
##     4     24       1   0.9583  0.0408      0.88163        1.000
##     5     23       2   0.8750  0.0675      0.75221        1.000
##     6     21       1   0.8333  0.0761      0.69681        0.997
##     7     20       1   0.7917  0.0829      0.64478        0.972
##     8     19       2   0.7083  0.0928      0.54795        0.916
##     9     17       1   0.6667  0.0962      0.50240        0.885
##    11     16       1   0.6250  0.0988      0.45845        0.852
##    12     15       1   0.5833  0.1006      0.41598        0.818
##    21     12       1   0.5347  0.1033      0.36614        0.781
##    23     11       1   0.4861  0.1047      0.31866        0.742
##    27     10       1   0.4375  0.1049      0.27340        0.700
##    28      9       1   0.3889  0.1039      0.23032        0.657
##    30      8       1   0.3403  0.1017      0.18945        0.611
##    32      7       1   0.2917  0.0981      0.15088        0.564
##    33      6       1   0.2431  0.0930      0.11481        0.515
##    37      5       1   0.1944  0.0862      0.08157        0.464
##    41      4       2   0.0972  0.0650      0.02624        0.360
##    43      2       1   0.0486  0.0473      0.00722        0.327
##    45      1       1   0.0000     NaN           NA           NA
\end{verbatim}

~

Printing the \texttt{ca.surv} object provides another view of the results:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ca.surv}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Call: survfit(formula = response ~ group)
## 
##          n events median 0.95LCL 0.95UCL
## group=1 22     14     31      21      NA
## group=2 24     22     23      11      37
\end{verbatim}

~

The \texttt{plot()} function with a \texttt{survfit} object displays the survival curves:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(ca.surv, }\AttributeTok{xlab =} \StringTok{"Months"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Survival"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-277-1} \end{center}

~

We can make it easier to distinguish between the two lines by specifying a width for each line using thelwd
parameter of the \texttt{plot()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(ca.surv, }\AttributeTok{xlab =} \StringTok{"Months"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Survival"}\NormalTok{, }\AttributeTok{lwd =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-278-1} \end{center}

~

It would also be useful to add a legend:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{legend}\NormalTok{(}\DecValTok{125}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FunctionTok{names}\NormalTok{(ca.surv}\SpecialCharTok{$}\NormalTok{strata), }\AttributeTok{lwd =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-280-1} \end{center}

~

If there is only one survival curve to plot then plotting a \texttt{survfit} object will plot the survival curve with 95\% confidence limits. You can specify that confidence limits should be plotted when there is more than one survival curve but the results can be disappointing:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(ca.surv, }\AttributeTok{conf.int =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-281-1} \end{center}

~

Plots can be improved by specifying different colours for each curve:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(ca.surv, }\AttributeTok{conf.int =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"red"}\NormalTok{, }\StringTok{"darkgreen"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-282-1} \end{center}

~

We can perform a formal test of the two survival times using the \texttt{survdiff()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{survdiff}\NormalTok{(response }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Call:
## survdiff(formula = response ~ group)
## 
##          N Observed Expected (O-E)^2/E (O-E)^2/V
## group=1 22       14     21.1      2.38      6.26
## group=2 24       22     14.9      3.36      6.26
## 
##  Chisq= 6.3  on 1 degrees of freedom, p= 0.01
\end{verbatim}

~

We can now quit \texttt{R}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{q}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

~

For this exercise there is no need to save the workspace image so click the \textbf{No} or \textbf{Don't Save} button (GUI) or enter \texttt{n} when prompted to save the workspace image (terminal).

\hypertarget{summary-4}{%
\section{Summary}\label{summary-4}}

\begin{itemize}
\item
  \texttt{R} can be extended by adding additional packages. Some packages are included with the standard \texttt{R} installation but many others are available and may be downloaded from the Internet.
\item
  You can find a list of add-in packages at the \texttt{R} website: \url{http://www.r-project.org/}
\item
  Packages may also be downloaded and installed from this site using the \texttt{install.packages()} function or from the \textbf{Packages} or \textbf{Packages \& Data} menu if you are using a GUI version of \texttt{R}.
\item
  Packages are loaded into \texttt{R} as they are needed using the \texttt{library()} function. You can use the \texttt{search()} function to display a list of loaded packages and attached data.frames.
\end{itemize}

\hypertarget{exercise6}{%
\chapter{Making your own objects behave like R objects}\label{exercise6}}

In the previous exercises we concentrated on writing functions that take some input data, analyse it, and display the results of the analysis. The standard \texttt{R} functions we have used all do this. The \texttt{fisher.test()} function, for example, takes a \texttt{table} object (or the names of two variables) as input and calculates and displays the p- value for \emph{Fisher's exact test} and the odds ratio and associated confidence interval for two-by-two tables:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"fem.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{attach}\NormalTok{(fem)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## The following objects are masked from fem (pos = 7):
## 
##     AGE, ANX, DEP, ID, IQ, LIFE, SEX, SLP, WT
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fisher.test}\NormalTok{(SEX, LIFE)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Fisher's Exact Test for Count Data
## 
## data:  SEX and LIFE
## p-value = 0.03175
## alternative hypothesis: true odds ratio is not equal to 1
## 95 percent confidence interval:
##   1.080298 14.214482
## sample estimates:
## odds ratio 
##   3.620646
\end{verbatim}

~

The results of the \texttt{fisher.test()} function may also be saved for later use:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ft }\OtherTok{\textless{}{-}} \FunctionTok{fisher.test}\NormalTok{(SEX, LIFE)}
\NormalTok{ft}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Fisher's Exact Test for Count Data
## 
## data:  SEX and LIFE
## p-value = 0.03175
## alternative hypothesis: true odds ratio is not equal to 1
## 95 percent confidence interval:
##   1.080298 14.214482
## sample estimates:
## odds ratio 
##   3.620646
\end{verbatim}

~

The \texttt{fisher.test()} function returns an object of the class \texttt{htest}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(ft)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "htest"
\end{verbatim}

~

which is a list containing the output of the \texttt{fisher.test()} function. Each item of output is stored as a different named item in the list:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{names}\NormalTok{(ft)}
\FunctionTok{str}\NormalTok{(ft)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "p.value"     "conf.int"    "estimate"    "null.value"  "alternative"
## [6] "method"      "data.name"
\end{verbatim}

\begin{verbatim}
## List of 7
##  $ p.value    : num 0.0318
##  $ conf.int   : num [1:2] 1.08 14.21
##   ..- attr(*, "conf.level")= num 0.95
##  $ estimate   : Named num 3.62
##   ..- attr(*, "names")= chr "odds ratio"
##  $ null.value : Named num 1
##   ..- attr(*, "names")= chr "odds ratio"
##  $ alternative: chr "two.sided"
##  $ method     : chr "Fisher's Exact Test for Count Data"
##  $ data.name  : chr "SEX and LIFE"
##  - attr(*, "class")= chr "htest"
\end{verbatim}

~

Each of these items can be referred to by name:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ft}\SpecialCharTok{$}\NormalTok{estimate}
\NormalTok{ft}\SpecialCharTok{$}\NormalTok{conf.int}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## odds ratio 
##   3.620646
\end{verbatim}

\begin{verbatim}
## [1]  1.080298 14.214482
## attr(,"conf.level")
## [1] 0.95
\end{verbatim}

~

When you display the output of the \texttt{fisher.test()} function either by calling the function directly:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fisher.test}\NormalTok{(SEX, LIFE)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Fisher's Exact Test for Count Data
## 
## data:  SEX and LIFE
## p-value = 0.03175
## alternative hypothesis: true odds ratio is not equal to 1
## 95 percent confidence interval:
##   1.080298 14.214482
## sample estimates:
## odds ratio 
##   3.620646
\end{verbatim}

~

or by typing the name of an object created using the \texttt{fisher.test()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ft}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Fisher's Exact Test for Count Data
## 
## data:  SEX and LIFE
## p-value = 0.03175
## alternative hypothesis: true odds ratio is not equal to 1
## 95 percent confidence interval:
##   1.080298 14.214482
## sample estimates:
## odds ratio 
##   3.620646
\end{verbatim}

~

The \texttt{print()} function takes over and formatted output is produced. The \texttt{print()} function knows about \texttt{htest} class objects and produces output of the correct format for that class of object. This means that any function that produces an \texttt{htest} object (or any other standard \texttt{R} object) does not need to include \texttt{R} commands to produce formatted output.

All hypothesis testing functions supplied with \texttt{R} produce objects of the htest class and use the \texttt{print()} function to produce formatted output. For example:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tt }\OtherTok{\textless{}{-}} \FunctionTok{t.test}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ LIFE)}
\FunctionTok{class}\NormalTok{(tt)}
\NormalTok{tt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "htest"
\end{verbatim}

\begin{verbatim}
## 
##  Welch Two Sample t-test
## 
## data:  WT by LIFE
## t = 0.60608, df = 98.866, p-value = 0.5459
## alternative hypothesis: true difference in means between group 1 and group 2 is not equal to 0
## 95 percent confidence interval:
##  -0.3326225  0.6251763
## sample estimates:
## mean in group 1 mean in group 2 
##       0.7867213       0.6404444
\end{verbatim}

~

You can use this feature of \texttt{R} in your own functions. We will explore this by writing a function to test the null hypothesis that the \emph{variance to mean ratio} of a vector of numbers is equal to one. Such a test might be used to investigate the spatial distribution (e.g.~over natural sampling units such as households) of cases of a disease.

Create a new function using the \texttt{function()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{v2m.test }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data) \{\}}
\end{Highlighting}
\end{Shaded}

~

And start the function editor:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(v2m.test)}
\end{Highlighting}
\end{Shaded}

\newpage

Now edit this function to make it do something useful:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(data) \{}
\NormalTok{  nsu }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(data)}
\NormalTok{  obs }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(data)}
\NormalTok{  m }\OtherTok{\textless{}{-}}\NormalTok{ obs }\SpecialCharTok{/}\NormalTok{ nsu}
\NormalTok{  v }\OtherTok{\textless{}{-}} \FunctionTok{var}\NormalTok{(data)}
\NormalTok{  vmr }\OtherTok{\textless{}{-}}\NormalTok{ v }\SpecialCharTok{/}\NormalTok{ m}
\NormalTok{  chi2 }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{((data }\SpecialCharTok{{-}}\NormalTok{ m)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ m}
\NormalTok{  df }\OtherTok{\textless{}{-}}\NormalTok{ nsu }\SpecialCharTok{{-}} \DecValTok{1}
\NormalTok{  p }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}} \FunctionTok{pchisq}\NormalTok{(chi2, df)}
  \FunctionTok{names}\NormalTok{(chi2) }\OtherTok{\textless{}{-}} \StringTok{"Chi{-}square"}
  \FunctionTok{names}\NormalTok{(df) }\OtherTok{\textless{}{-}} \StringTok{"df"}
  \FunctionTok{names}\NormalTok{(vmr) }\OtherTok{\textless{}{-}} \StringTok{"Variance : mean ratio"}
\NormalTok{  v2m }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{method =} \StringTok{"Variance to mean test"}\NormalTok{,}
              \AttributeTok{data.name =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(data)),}
              \AttributeTok{statistic =}\NormalTok{ chi2,}
              \AttributeTok{parameter =}\NormalTok{ df,}
              \AttributeTok{p.value =}\NormalTok{ p,}
              \AttributeTok{estimate =}\NormalTok{ vmr)}
  \FunctionTok{class}\NormalTok{(v2m) }\OtherTok{\textless{}{-}} \StringTok{"htest"}
  \FunctionTok{return}\NormalTok{(v2m)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, check your work, save the file, and quit the editor.

Before proceeding we should examine the \texttt{v2m.test()} function to make sure we understand what is happening:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  The first eight lines after the opening curly bracket (\texttt{\{}) contain the required calculations.
\item
  The next three lines use the \texttt{names()} function to give our variables names that will make sense in formatted output.
\item
  The next line creates a list of items that the function returns using some of the names used by \texttt{htest} class objects.
\item
  The next line tells \texttt{R} that the list object called \texttt{v2m} is of the class \texttt{htest}.
\item
  The next line causes the function to return the \texttt{v2m} object (i.e.~a list of class \texttt{htest} containing the named items \texttt{method}, \texttt{data.name}, \texttt{statistic}, \texttt{parameter}, \texttt{p.value}, and \texttt{estimate}).
\item
  The final line ends the function definition.
\end{enumerate}

Note that objects of class htest may contain items with the following names:

~

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.23}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.77}}@{}}
\toprule
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Item}
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
\textbf{Usage}
\end{minipage} \\
\midrule
\endhead
\textbf{method} & Text description of the test used to title output \\
\textbf{data.name} & Name(s) of data or variables used for the test \\
\textbf{null.value} & The null value \\
\textbf{statistic} & Value of test statistic \\
\textbf{parameter} & A test parameter such as the degrees of freedom of the test statistic \\
\textbf{p.value} & The p-value of the test \\
\textbf{estimate} & An estimate (e.g.~the mean) \\
\textbf{conf.int} & Confidence interval of estimate \\
\textbf{alternative} & Text describing the alternative hypothesis \\
\textbf{note} & Text note \\
\bottomrule
\end{longtable}

~

We are now ready to test the \texttt{v2m.test()} function. This table:

~

\begin{verbatim}
Number of cases :       0  1  2  3  4  6
Number of households : 24 29 26 14  5  2
\end{verbatim}

~

shows the number of cases of chronic (stunting) undernutrition found in a random sample of 100 households.

We can reproduce the data behind this table using a combination of the \texttt{c()} and \texttt{rep()} functions:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stunt }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{24}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{29}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{26}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{14}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\DecValTok{4}\NormalTok{,}\DecValTok{5}\NormalTok{),}
           \FunctionTok{rep}\NormalTok{(}\DecValTok{5}\NormalTok{,}\DecValTok{0}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\DecValTok{6}\NormalTok{,}\DecValTok{2}\NormalTok{))}
\FunctionTok{table}\NormalTok{(stunt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## stunt
##  0  1  2  3  4  6 
## 24 29 26 14  5  2
\end{verbatim}

~

And use it to test our new \texttt{v2m.test()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{v2m.test}\NormalTok{(stunt)}
\end{Highlighting}
\end{Shaded}

~

Which should produce the following output:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{v2m.test}\NormalTok{(stunt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Variance to mean test
## 
## data:  stunt
## Chi-square = 110.16, df = 99, p-value = 0.2083
## sample estimates:
## Variance : mean ratio 
##               1.11274
\end{verbatim}

~

If your \texttt{vm2.test()} function does not produce this output then use the \texttt{fix()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(v2m.test)}
\end{Highlighting}
\end{Shaded}

~

to check and edit the \texttt{vm2.test()} function and try again.

The important thing to note from this exercise is that \texttt{R} allows us to specify a class for the output of our functions. This means that we can use standard \texttt{R} classes and functions to (e.g.) produce formatted output without us having to write commands to format the output ourselves.

More importantly, it also means that we can write functions that return values when we need them to return values but can also produce formatted output when we need them to produce formatted output.

Our \texttt{v2m.test()} function can produce values for later use:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vm }\OtherTok{\textless{}{-}} \FunctionTok{v2m.test}\NormalTok{(stunt)}
\NormalTok{vm}\SpecialCharTok{$}\NormalTok{p.value}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.2083442
\end{verbatim}

~

or produce formatted output:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{v2m.test}\NormalTok{(stunt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Variance to mean test
## 
## data:  stunt
## Chi-square = 110.16, df = 99, p-value = 0.2083
## sample estimates:
## Variance : mean ratio 
##               1.11274
\end{verbatim}

~

This way of working is not limited to using standard \texttt{R} classes and functions.

\texttt{R} also allows us to define our own classes. We will explore this by defining functions and a new class to deal
with two-by-two tables.

We need to create two functions:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  One function will handle the calculations.
\item
  A second function function will produce formatted output when required.
\end{enumerate}

Create a new function using the \texttt{function()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rr22 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(exposure, outcome) \{\}}
\end{Highlighting}
\end{Shaded}

~

And start the function editor:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(rr22)}
\end{Highlighting}
\end{Shaded}

~

Now edit this function to make it do something useful:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(exposure, outcome) \{}
\NormalTok{  tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(exposure, outcome)}
\NormalTok{  a }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{  b }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{]}
\NormalTok{  c }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{  d }\OtherTok{\textless{}{-}}\NormalTok{ tab[}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{]}
\NormalTok{  rr }\OtherTok{\textless{}{-}}\NormalTok{ (a }\SpecialCharTok{/}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b)) }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{+}\NormalTok{ d))}
\NormalTok{  se.log.rr }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{((b }\SpecialCharTok{/}\NormalTok{ a) }\SpecialCharTok{/}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b) }\SpecialCharTok{+}\NormalTok{ (d }\SpecialCharTok{/}\NormalTok{ c) }\SpecialCharTok{/}\NormalTok{ (c }\SpecialCharTok{+}\NormalTok{ d))}
\NormalTok{  lci }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\FunctionTok{log}\NormalTok{(rr) }\SpecialCharTok{{-}} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ se.log.rr)}
\NormalTok{  uci }\OtherTok{\textless{}{-}} \FunctionTok{exp}\NormalTok{(}\FunctionTok{log}\NormalTok{(rr) }\SpecialCharTok{+} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ se.log.rr)}
\NormalTok{  rr22.output }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{estimate =}\NormalTok{ rr, }\AttributeTok{ci =} \FunctionTok{c}\NormalTok{(lci, uci))}
  \FunctionTok{class}\NormalTok{(rr22.output) }\OtherTok{\textless{}{-}} \StringTok{"rr22"}
  \FunctionTok{return}\NormalTok{(rr22.output)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, save the file and quit the editor.

The \texttt{rr22()} function is similar to the \texttt{tab2by2()} function that you created in the second exercise of this
tutorial except that the function now returns a list of values instead of formatted output:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"fem.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{attach}\NormalTok{(fem)}
\NormalTok{rr22.test }\OtherTok{\textless{}{-}} \FunctionTok{rr22}\NormalTok{(SEX, LIFE)}
\FunctionTok{names}\NormalTok{(rr22.test)}
\NormalTok{rr22.test}\SpecialCharTok{$}\NormalTok{estimate}
\NormalTok{rr22.test}\SpecialCharTok{$}\NormalTok{conf.int}
\NormalTok{rr22.test}\SpecialCharTok{$}\NormalTok{conf.int[}\DecValTok{1}\NormalTok{]}
\NormalTok{rr22.test}\SpecialCharTok{$}\NormalTok{conf.int[}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## The following objects are masked from fem (pos = 3):
## 
##     AGE, ANX, DEP, ID, IQ, LIFE, SEX, SLP, WT
\end{verbatim}

\begin{verbatim}
## The following objects are masked from fem (pos = 8):
## 
##     AGE, ANX, DEP, ID, IQ, LIFE, SEX, SLP, WT
\end{verbatim}

\begin{verbatim}
## [1] "estimate" "ci"
\end{verbatim}

\begin{verbatim}
## [1] 2.054167
\end{verbatim}

\begin{verbatim}
## NULL
\end{verbatim}

\begin{verbatim}
## NULL
\end{verbatim}

\begin{verbatim}
## NULL
\end{verbatim}

~

The function returns a list of class \texttt{rr22}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{class}\NormalTok{(rr22.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "rr22"
\end{verbatim}

~

The displayed output from the \texttt{rr22()} function is, however, not pretty:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(rr22.test)}
\FunctionTok{rr22}\NormalTok{(SEX, LIFE)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $estimate
## [1] 2.054167
## 
## $ci
## [1] 0.966417 4.366232
## 
## attr(,"class")
## [1] "rr22"
\end{verbatim}

\begin{verbatim}
## $estimate
## [1] 2.054167
## 
## $ci
## [1] 0.966417 4.366232
## 
## attr(,"class")
## [1] "rr22"
\end{verbatim}

~

This can be fixed by creating a new function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{print.rr22 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{\}}
\end{Highlighting}
\end{Shaded}

~

And start the function editor:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(print.rr22)}
\end{Highlighting}
\end{Shaded}

~

Now edit this function to make it do something useful:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"RR     : "}\NormalTok{, x}\SpecialCharTok{$}\NormalTok{estimate, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
      \StringTok{"95\% CI : "}\NormalTok{, x}\SpecialCharTok{$}\NormalTok{ci[}\DecValTok{1}\NormalTok{], }\StringTok{"; "}\NormalTok{, x}\SpecialCharTok{$}\NormalTok{ci[}\DecValTok{2}\NormalTok{], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, check your work, save the file, and quit the editor.

The function name \texttt{print.rr22()} indicates that this function contains the print method for objects of class \texttt{rr22}. All objects of class \texttt{rr22} will use the function \texttt{print.rr22()} instead of the standard \texttt{R} \texttt{print()} function to produce formatted output:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rr22}\NormalTok{(SEX, LIFE)}
\NormalTok{rr22.test }\OtherTok{\textless{}{-}} \FunctionTok{rr22}\NormalTok{(SEX, LIFE)}
\NormalTok{rr22.test}
\FunctionTok{print}\NormalTok{(rr22.test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## RR     : 2.054167
## 95% CI : 0.966417; 4.366232
\end{verbatim}

\begin{verbatim}
## RR     : 2.054167
## 95% CI : 0.966417; 4.366232
\end{verbatim}

\begin{verbatim}
## RR     : 2.054167
## 95% CI : 0.966417; 4.366232
\end{verbatim}

~

Note that we can still extract returned values from an \texttt{rr22} class object:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rr22.test}\SpecialCharTok{$}\NormalTok{estimate}
\end{Highlighting}
\end{Shaded}

~

The \texttt{print.rr22()} function only controls the way an entire \texttt{rr22} object is displayed.

You might like to use the \texttt{save()} function to save the \texttt{v2m.test()}, \texttt{rr22()}, and \texttt{print.rr22()} functions before quitting \texttt{R}. We can now quit \texttt{R}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{q}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

~

For this exercise there is no need to save the workspace image so click the \textbf{No} or \textbf{Don't Save} button (GUI) or enter \texttt{n} when prompted to save the workspace image (terminal).

\hypertarget{summary-5}{%
\section{Summary}\label{summary-5}}

\begin{itemize}
\item
  \texttt{R} objects can be assigned a class or type.
\item
  Objects of a specific class or type may share functions that extract and manipulate data common to members of that class. This allows you to write functions that handle data that is common to all members of that class (e.g.~to produce formatted output for hypothesis testing functions).
\item
  \texttt{R} provides a set of ready-made classes (e.g.~\texttt{htest}) which can be used by standard R functions such as the \texttt{print()} and \texttt{summary()} functions.
\item
  \texttt{R} allows you to create new classes and class-specific functions that can extract and manipulate data common to the new classes.
\item
  Classes allows you to create versatile functions that return values when you need them to return values but can also produce formatted output when you need them to produce formatted output.
\item
  Classes allow you to write functions that can be chained together so that the output of one function is the input of another function.
\end{itemize}

\hypertarget{exercise7}{%
\chapter{Writing your own graphical functions}\label{exercise7}}

\texttt{R} provides a pretty full set of graphical functions for plotting data as well as \texttt{plot()} methods for a wide variety of statistical functions. There will be times, however, when you will need to write you own graphical functions to present and analyse data in a specific way. In this exercise we will create a function that produces a plot that may be used for assessing agreement between two methods of clinical measurement as described in:

\begin{verbatim}
Bland JM, Altman DG. Statistical Methods for Assessing Agreement Between Two Methods 
    of Clinical Measurement. The Lancet. 1986;1: 307–310. 
\end{verbatim}

Which involves plotting the difference of two measurements against the mean of the two measurements and calculating and displaying limits of agreement.

Start \texttt{R} and retrieve and attach the sample dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ba }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"ba.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{attach}\NormalTok{(ba)}
\end{Highlighting}
\end{Shaded}

~

The \texttt{ba} data.frame contains measurements (in litres per minute) taken with a \emph{Wright peak flow meter} and a \emph{Mini-Wright peak flow meter}. This is the same data that is presented in the referenced Lancet article:

~

\begin{verbatim}
##    Wright Mini
## 1     494  512
## 2     395  430
## 3     516  520
## 4     434  428
## 5     476  500
## 6     557  600
## 7     413  364
## 8     442  380
## 9     650  658
## 10    433  445
## 11    417  432
## 12    656  626
## 13    267  260
## 14    478  477
## 15    178  259
## 16    423  350
## 17    427  451
\end{verbatim}

~

You can examine the \texttt{ba} data.frame using the \texttt{print()} and \texttt{summary()} functions:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{print}\NormalTok{(ba)}
\NormalTok{ba}
\FunctionTok{summary}\NormalTok{(ba)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    Wright Mini
## 1     494  512
## 2     395  430
## 3     516  520
## 4     434  428
## 5     476  500
## 6     557  600
## 7     413  364
## 8     442  380
## 9     650  658
## 10    433  445
## 11    417  432
## 12    656  626
## 13    267  260
## 14    478  477
## 15    178  259
## 16    423  350
## 17    427  451
\end{verbatim}

\begin{verbatim}
##    Wright Mini
## 1     494  512
## 2     395  430
## 3     516  520
## 4     434  428
## 5     476  500
## 6     557  600
## 7     413  364
## 8     442  380
## 9     650  658
## 10    433  445
## 11    417  432
## 12    656  626
## 13    267  260
## 14    478  477
## 15    178  259
## 16    423  350
## 17    427  451
\end{verbatim}

\begin{verbatim}
##      Wright           Mini      
##  Min.   :178.0   Min.   :259.0  
##  1st Qu.:417.0   1st Qu.:380.0  
##  Median :434.0   Median :445.0  
##  Mean   :450.4   Mean   :452.5  
##  3rd Qu.:494.0   3rd Qu.:512.0  
##  Max.   :656.0   Max.   :658.0
\end{verbatim}

~

The \texttt{function()} function allows us to create new functions in \texttt{R}:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ba.plot }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(a, b) \{\}}
\end{Highlighting}
\end{Shaded}

~

This creates an empty function called \texttt{ba.plot()} that expects two parameters called \texttt{a} and \texttt{b}. We could type the whole function in at the \texttt{R} command prompt but it is easier to use a text editor:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(ba.plot)}
\end{Highlighting}
\end{Shaded}

~

We will start be writing a basic function which we will gradually improve throughout this exercise.

Edit the \texttt{ba.plot()} function to read:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(a, b) \{}
\NormalTok{  mean.two }\OtherTok{\textless{}{-}}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b) }\SpecialCharTok{/} \DecValTok{2}
\NormalTok{  diff.two }\OtherTok{\textless{}{-}}\NormalTok{ a }\SpecialCharTok{{-}}\NormalTok{ b}
  \FunctionTok{plot}\NormalTok{(mean.two, diff.two)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, check your work, save the file, and quit the editor.

The function calculates the mean and the difference of the two measures and then plots the results. Lets try the
\texttt{ba.plot()} function with the test data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ba.plot}\NormalTok{(Wright, Mini)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-331-1.pdf}

~

The resulting plot is rather plain and lacks meaningful titles and axis labels. Use the \texttt{fix()} function to edit the \texttt{ba.plot()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(ba.plot)}
\end{Highlighting}
\end{Shaded}

~

Edit the function to read:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(a, b, }\AttributeTok{title =} \StringTok{"Bland and Altman Plot"}\NormalTok{) \{}
\NormalTok{  a.txt }\OtherTok{\textless{}{-}} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(a))}
\NormalTok{  b.txt }\OtherTok{\textless{}{-}} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(b))}
\NormalTok{  x.lab }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Mean of"}\NormalTok{, a.txt, }\StringTok{"and"}\NormalTok{, b.txt)}
\NormalTok{  y.lab }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(a.txt, }\StringTok{"{-}"}\NormalTok{, b.txt)}
\NormalTok{  mean.two }\OtherTok{\textless{}{-}}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b) }\SpecialCharTok{/} \DecValTok{2}
\NormalTok{  diff.two }\OtherTok{\textless{}{-}}\NormalTok{ a }\SpecialCharTok{{-}}\NormalTok{ b}
  \FunctionTok{plot}\NormalTok{(mean.two, diff.two, }\AttributeTok{xlab =}\NormalTok{ x.lab, }\AttributeTok{ylab =}\NormalTok{ y.lab, }\AttributeTok{main =}\NormalTok{ title)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, check your work, save the file, and quit the editor.

We have added a new parameter (\texttt{title}) to the function and given this a default value of \texttt{Bland\ and\ Altman\ Plot}. Adding \texttt{title} as a parameter means that we will be able to specify a title for the plot when we call the function. We have also used the function combination \texttt{deparse(substitute())} to retrieve the names of the vectors passed to parameters \texttt{a} and \texttt{b}. The \texttt{paste()} function pastes pieces of text together. It is used here to create the text for the axis labels used with the \texttt{plot()} function.

Lets try the \texttt{ba.plot()} function with the test data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ba.plot}\NormalTok{(Wright, Mini)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-335-1.pdf}

~

We may also specify a title for the plot using the title parameter:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ba.plot}\NormalTok{(Wright, Mini, }\AttributeTok{title =} \StringTok{"PEFR data"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-336-1.pdf}

~

We can now edit the function to calculate and plot mean, difference, and the limits of agreement. Use the \texttt{fix()} function to edit the \texttt{ba.plot()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(ba.plot)}
\end{Highlighting}
\end{Shaded}

~

Edit the function to read:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(a, b, }\AttributeTok{title =} \StringTok{"Bland and Altman Plot"}\NormalTok{) \{}
\NormalTok{  a.txt }\OtherTok{\textless{}{-}} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(a))}
\NormalTok{  b.txt }\OtherTok{\textless{}{-}} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(b))}
\NormalTok{  x.lab }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Mean of"}\NormalTok{, a.txt, }\StringTok{"and"}\NormalTok{, b.txt)}
\NormalTok{  y.lab }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(a.txt, }\StringTok{"{-}"}\NormalTok{, b.txt)}
\NormalTok{  mean.two }\OtherTok{\textless{}{-}}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b) }\SpecialCharTok{/} \DecValTok{2}
\NormalTok{  diff.two }\OtherTok{\textless{}{-}}\NormalTok{ a }\SpecialCharTok{{-}}\NormalTok{ b}
  \FunctionTok{plot}\NormalTok{(mean.two, diff.two, }\AttributeTok{xlab =}\NormalTok{ x.lab, }\AttributeTok{ylab =}\NormalTok{ y.lab, }\AttributeTok{main =}\NormalTok{ title) }
\NormalTok{  mean.diff }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(diff.two)}
\NormalTok{  sd.diff }\OtherTok{\textless{}{-}} \FunctionTok{sd}\NormalTok{(diff.two)}
\NormalTok{  upper }\OtherTok{\textless{}{-}}\NormalTok{ mean.diff }\SpecialCharTok{+} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ sd.diff}
\NormalTok{  lower }\OtherTok{\textless{}{-}}\NormalTok{ mean.diff }\SpecialCharTok{{-}} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ sd.diff}
  \FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{range}\NormalTok{(mean.two), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(mean.diff, mean.diff), }\AttributeTok{lty =} \DecValTok{3}\NormalTok{) }
  \FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{range}\NormalTok{(mean.two), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(upper, upper), }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
  \FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{range}\NormalTok{(mean.two), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(lower, lower), }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, check your work, save the file and quit the editor.

We have used the \texttt{mean()} and \texttt{sd()} functions to calculate the mean and standard deviation of the difference between the two measures and calculated the limits of agreement (\texttt{upper} and \texttt{lower}) assuming that the differences are \emph{Normally} distributed.

The \texttt{lines()} function is then used to plot the mean and the limits of agreement on top of the existing scatter plot.

The parameter \texttt{lty\ =\ 3} used with the \texttt{lines()} function specifies dotted lines.

\texttt{R} provided a great number of graphical parameters that can be used to customise plots. You can see a list of
these parameters using:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{help}\NormalTok{(par)}
\end{Highlighting}
\end{Shaded}

~

These parameters can be specified for almost all graphical functions.

Lets try the \texttt{ba.plot()} function with the test data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ba.plot}\NormalTok{(Wright, Mini, }\AttributeTok{title =} \StringTok{"Difference vs. mean for PEFR data"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-341-1.pdf}

~

The function is almost complete. All that remains to do is to label the lines with the values of the mean difference and the limits of agreement.

Use the \texttt{fix()} function to edit the \texttt{ba.plot()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(ba.plot)}
\end{Highlighting}
\end{Shaded}

~

Edit the function to read:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(a, b, }\AttributeTok{title =} \StringTok{"Bland and Altman Plot"}\NormalTok{) \{}
\NormalTok{  a.txt }\OtherTok{\textless{}{-}} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(a))}
\NormalTok{  b.txt }\OtherTok{\textless{}{-}} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(b))}
\NormalTok{  x.lab }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Mean of"}\NormalTok{, a.txt, }\StringTok{"and"}\NormalTok{, b.txt)}
\NormalTok{  y.lab }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(a.txt, }\StringTok{"{-}"}\NormalTok{, b.txt)}
\NormalTok{  mean.two }\OtherTok{\textless{}{-}}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b) }\SpecialCharTok{/} \DecValTok{2}
\NormalTok{  diff.two }\OtherTok{\textless{}{-}}\NormalTok{ a }\SpecialCharTok{{-}}\NormalTok{ b}
  \FunctionTok{plot}\NormalTok{(mean.two, diff.two, }\AttributeTok{xlab =}\NormalTok{ x.lab, }\AttributeTok{ylab =}\NormalTok{ y.lab, }\AttributeTok{main =}\NormalTok{ title) }
\NormalTok{  mean.diff }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(diff.two)}
\NormalTok{  sd.diff }\OtherTok{\textless{}{-}} \FunctionTok{sd}\NormalTok{(diff.two)}
\NormalTok{  upper }\OtherTok{\textless{}{-}}\NormalTok{ mean.diff }\SpecialCharTok{+} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ sd.diff}
\NormalTok{  lower }\OtherTok{\textless{}{-}}\NormalTok{ mean.diff }\SpecialCharTok{{-}} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ sd.diff}
  \FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{range}\NormalTok{(mean.two), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(mean.diff, mean.diff), }\AttributeTok{lty =} \DecValTok{3}\NormalTok{) }
  \FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{range}\NormalTok{(mean.two), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(upper, upper), }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
  \FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{range}\NormalTok{(mean.two), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(lower, lower), }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\NormalTok{  m.text }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(mean.diff, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)}
\NormalTok{  u.text }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(upper , }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)}
\NormalTok{  l.text }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(lower, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)}
  \FunctionTok{text}\NormalTok{(}\FunctionTok{max}\NormalTok{(mean.two), mean.diff, m.text, }\AttributeTok{adj =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{)) }
  \FunctionTok{text}\NormalTok{(}\FunctionTok{max}\NormalTok{(mean.two), upper, u.text, }\AttributeTok{adj =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{)) }
  \FunctionTok{text}\NormalTok{(}\FunctionTok{max}\NormalTok{(mean.two), lower, l.text, }\AttributeTok{adj =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, check your work, save the file, and quit the editor.
We have used the \texttt{round()} function to limit the display of the mean difference and the limits of agreement to one decimal place and used the \texttt{text()} function to display these (rounded) values. The \texttt{adj} parameter to the \texttt{text()} function controls the position and justification of text.

Let's try the \texttt{ba.plot()} function with the test data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ba.plot}\NormalTok{(Wright, Mini, }\AttributeTok{title =} \StringTok{"PEFR data"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-345-1.pdf}

~

The graphical function is now complete.

One improvement that we could make is for the function to produce a chart and return the values of the mean difference and the limits of agreement.

We would do this in exactly the same way as we would with a non-graphical function. We would return the mean difference and the limits of agreement as members of a list.

We could also specify a class for the returned list and create a class specific \texttt{print()} function (or \emph{method}) to produce nicely formatted output.

Use the \texttt{fix()} function to edit the \texttt{ba.plot()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(ba.plot)}
\end{Highlighting}
\end{Shaded}

~

Edit the function to read:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(a, b, }\AttributeTok{title =} \StringTok{"Bland and Altman Plot"}\NormalTok{) \{}
\NormalTok{  a.txt }\OtherTok{\textless{}{-}} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(a))}
\NormalTok{  b.txt }\OtherTok{\textless{}{-}} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(b))}
\NormalTok{  x.lab }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\StringTok{"Mean of"}\NormalTok{, a.txt, }\StringTok{"and"}\NormalTok{, b.txt)}
\NormalTok{  y.lab }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(a.txt, }\StringTok{"{-}"}\NormalTok{, b.txt)}
\NormalTok{  mean.two }\OtherTok{\textless{}{-}}\NormalTok{ (a }\SpecialCharTok{+}\NormalTok{ b) }\SpecialCharTok{/} \DecValTok{2}
\NormalTok{  diff.two }\OtherTok{\textless{}{-}}\NormalTok{ a }\SpecialCharTok{{-}}\NormalTok{ b}
  \FunctionTok{plot}\NormalTok{(mean.two, diff.two, }\AttributeTok{xlab =}\NormalTok{ x.lab, }\AttributeTok{ylab =}\NormalTok{ y.lab, }\AttributeTok{main =}\NormalTok{ title) }
\NormalTok{  mean.diff }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(diff.two)}
\NormalTok{  sd.diff }\OtherTok{\textless{}{-}} \FunctionTok{sd}\NormalTok{(diff.two)}
\NormalTok{  upper }\OtherTok{\textless{}{-}}\NormalTok{ mean.diff }\SpecialCharTok{+} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ sd.diff}
\NormalTok{  lower }\OtherTok{\textless{}{-}}\NormalTok{ mean.diff }\SpecialCharTok{{-}} \FloatTok{1.96} \SpecialCharTok{*}\NormalTok{ sd.diff}
  \FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{range}\NormalTok{(mean.two), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(mean.diff, mean.diff), }\AttributeTok{lty =} \DecValTok{3}\NormalTok{) }
  \FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{range}\NormalTok{(mean.two), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(upper, upper), }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
  \FunctionTok{lines}\NormalTok{(}\AttributeTok{x =} \FunctionTok{range}\NormalTok{(mean.two), }\AttributeTok{y =} \FunctionTok{c}\NormalTok{(lower, lower), }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\NormalTok{  m.text }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(mean.diff, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)}
\NormalTok{  u.text }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(upper , }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)}
\NormalTok{  l.text }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(lower, }\AttributeTok{digits =} \DecValTok{1}\NormalTok{)}
  \FunctionTok{text}\NormalTok{(}\FunctionTok{max}\NormalTok{(mean.two), mean.diff, m.text, }\AttributeTok{adj =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{)) }
  \FunctionTok{text}\NormalTok{(}\FunctionTok{max}\NormalTok{(mean.two), upper, u.text, }\AttributeTok{adj =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{)) }
  \FunctionTok{text}\NormalTok{(}\FunctionTok{max}\NormalTok{(mean.two), lower, l.text, }\AttributeTok{adj =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{))}
\NormalTok{  ba }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{mean =}\NormalTok{ mean.diff, }\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(lower, upper))}
  \FunctionTok{class}\NormalTok{(ba) }\OtherTok{\textless{}{-}} \StringTok{"ba"}
  \FunctionTok{return}\NormalTok{(ba)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, save the file and quit the editor.

Create a \texttt{print()} function for objects of the \texttt{ba} class:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{print.ba }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{\}}
\end{Highlighting}
\end{Shaded}

~

Use the \texttt{fix()} function to edit the new function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(print.ba)}
\end{Highlighting}
\end{Shaded}

~

Edit the function to read:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(x) \{}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Mean difference     : "}\NormalTok{, x}\SpecialCharTok{$}\NormalTok{mean, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
      \StringTok{"Limits of agreement : "}\NormalTok{, x}\SpecialCharTok{$}\NormalTok{limits[}\DecValTok{1}\NormalTok{], }\StringTok{"; "}\NormalTok{, x}\SpecialCharTok{$}\NormalTok{limits[}\DecValTok{2}\NormalTok{], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
      \AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, check your work, save the file, and quit the editor.

Let's try the \texttt{ba.plot()} function with the test data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ba.plot}\NormalTok{(Wright, Mini, }\AttributeTok{title =} \StringTok{"PEFR data"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-353-1.pdf}

\begin{verbatim}
## Mean difference     : -2.117647
## Limits of agreement : -78.0973; 73.86201
\end{verbatim}

~

The function produces the plot and returns the mean difference and limits of agreement as a list of class \texttt{ba} which is formatted and printed by the \texttt{print.ba()} function.

We can manipulate the returned values just as we would with any other function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ba.test }\OtherTok{\textless{}{-}} \FunctionTok{ba.plot}\NormalTok{(Wright, Mini)}
\FunctionTok{print}\NormalTok{(ba.test)}
\NormalTok{ba.test}
\NormalTok{ba.test}\SpecialCharTok{$}\NormalTok{mean}
\NormalTok{ba.test}\SpecialCharTok{$}\NormalTok{limits}
\NormalTok{ba.test}\SpecialCharTok{$}\NormalTok{limits[}\DecValTok{1}\NormalTok{]}
\NormalTok{ba.test}\SpecialCharTok{$}\NormalTok{limits[}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-355-1.pdf}

\begin{verbatim}
## Mean difference     : -2.117647
## Limits of agreement : -78.0973; 73.86201
\end{verbatim}

\begin{verbatim}
## Mean difference     : -2.117647
## Limits of agreement : -78.0973; 73.86201
\end{verbatim}

\begin{verbatim}
## [1] -2.117647
\end{verbatim}

\begin{verbatim}
## [1] -78.09730  73.86201
\end{verbatim}

\begin{verbatim}
## [1] -78.0973
\end{verbatim}

\begin{verbatim}
## [1] 73.86201
\end{verbatim}

~

You might like to use the \texttt{save()} function to save the \texttt{ba.plot()} and \texttt{print.ba()} functions before quitting \texttt{R}.

We can now quit \texttt{R}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{q}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

~

For this exercise there is no need to save the workspace image so click the \textbf{No} or \textbf{Don't Save} button (GUI) or enter \texttt{n} when prompted to save the workspace image (terminal).

\hypertarget{summary-6}{%
\section{Summary}\label{summary-6}}

\begin{itemize}
\item
  \texttt{R} allows you to create functions that produce graphical output.
\item
  \texttt{R} allows you to create functions that produce graphical output and return values.
\item
  \texttt{R} objects can be assigned a class or type.
\item
  \texttt{R} allows you to create new classes and class-specific functions that can extract and manipulate data common to the new classes.
\item
  Classes allows you to create versatile functions that return values when we need them to return values but can also produce formatted output when we need them to produce formatted output.
\item
  Classes allow you to write functions that can be chained together so that the output of one function is the input of another function.
\end{itemize}

\hypertarget{exercise8}{%
\chapter{More graphical functions}\label{exercise8}}

Graphical functions in \texttt{R} are just like any other function in \texttt{R} in the sense that \texttt{R} provides you with a set of functions which can be altered or added to. In this exercise we will experiment with some of the graphical functions provided by R to demonstrate the flexibility of graphical functions in \texttt{R}. We will then use the graphical functions that we experiment with to create some useful graphical functions of our own.

The first function that we will develop will be a function that is capable of plotting two data series on a single graph. We will take this exercise slowly in order to introduce some further graphical functions.
Before we go any further we should start \texttt{R} and retrieve a dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mal }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"malaria.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{attach}\NormalTok{(mal)}
\end{Highlighting}
\end{Shaded}

~

The file \texttt{malaria.dat} contains data on rainfall (in mm) and the number of cases of malaria reported from health centres in an administrative district of Ethiopia between July 1997 and July 1999. The columns in this dataset are as follows:

~

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.15}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.57}}@{}}
\toprule
\endhead
\textbf{Time} & Month and year (as text) \\
\textbf{Cases} & Number of cases of malaria reported \\
\textbf{Rain} & Rainfall in mm \\
\bottomrule
\end{longtable}

\newpage

Examine the dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mal}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Time Cases  Rain
## 1  Jul-97   997  68.5
## 2  Aug-97   824 162.1
## 3  Sep-97   573 138.8
## 4  Oct-97   586 222.2
## 5  Nov-97   523 115.5
## 6  Dec-97   968  37.2
## 7  Jan-98   985  96.6
## 8  Feb-98   745  99.1
## 9  Mar-98   520  51.2
## 10 Apr-98   406  80.0
## 11 May-98   523 112.4
## 12 Jun-98   560 183.7
## 13 Jul-98   671 101.0
## 14 Aug-98   667 252.5
## 15 Sep-98   768  40.8
## 16 Oct-98   990 193.7
## 17 Nov-98   775  17.5
## 18 Dec-98   833   0.0
## 19 Jan-99   672  33.5
## 20 Feb-99   505   0.0
## 21 Mar-99   320 106.8
## 22 Apr-99   274 117.4
## 23 May-99   263 175.8
## 24 Jun-99   264 187.5
## 25 Jul-99   179 283.5
\end{verbatim}

\newpage

First we will plot the number of cases of malaria seen over time using the \texttt{plot()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Cases, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-359-1} \end{center}

~

The problem with this plot is that it does not treat the data as a time series. Adding the \texttt{Time} variable to the plot does not solve the problem:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Time, Cases, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\FunctionTok{as.factor}\NormalTok{(Time), Cases, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-361-1} \end{center}

\newpage

Because \texttt{Time} is a factor variable. If you convert \texttt{Time} to a character variable using \texttt{as.character()} or prevent \texttt{R} from converting \texttt{Time} to a factor using the \texttt{as.is} parameter to the \texttt{read.table()} function the \texttt{plot()} function will return an error because it expects a numeric x-axis variable. We should, instead, specify a time series (\texttt{ts}) class object. Rather than change the original data, we will create a new object using the \texttt{ts()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cases.ts }\OtherTok{\textless{}{-}} \FunctionTok{ts}\NormalTok{(Cases, }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1997}\NormalTok{, }\DecValTok{7}\NormalTok{), }\AttributeTok{frequency =} \DecValTok{12}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

Examine the cases.ts object:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cases.ts}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
## 1997                         997 824 573 586 523 968
## 1998 985 745 520 406 523 560 671 667 768 990 775 833
## 1999 672 505 320 274 263 264 179
\end{verbatim}

~

We can now plot \texttt{cases.ts} as a time series:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(cases.ts)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-364-1} \end{center}

\newpage

We might want to explore the association between the \texttt{Rain} and \texttt{Cases} variables. A simple scatter plot is not particularly informative:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Rain, Cases)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-365-1} \end{center}

\newpage

It is better to treat both variables as time series (which they are) and use the built-in \texttt{plot()} methods for objects of class \texttt{ts}:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rain.cases.ts }\OtherTok{\textless{}{-}} \FunctionTok{ts}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(Rain, Cases), }\AttributeTok{start =} \FunctionTok{c}\NormalTok{(}\DecValTok{1997}\NormalTok{,}\DecValTok{7}\NormalTok{), }\AttributeTok{frequency =} \DecValTok{12}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(rain.cases.ts)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-366-1} \end{center}

~

The association between the \texttt{Rain} and \texttt{Cases} variables is now clearer with the number of malaria cases peaking shortly after peaks in rainfall.

The \texttt{plot()} function when used with objects of class \texttt{ts} produces useful output but it is not particularly flexible and the output is, sometimes, not particularly pretty. We can however use basic graphical functions to produce multiple plots. First we will set the \texttt{mfrow} graphical parameter using the \texttt{par()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

~

The \texttt{par()} function sets a graphical parameter. The \texttt{mfrow} parameter is used to set the number of charts that will appear on a page in rows and columns. We have specified two rows with one chart per row. Test this by plotting two charts:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Rain, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-368-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Cases, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-368-2} \end{center}

\newpage

We will want to have tick-marks on the x-axis of each for each record. We can set the number of tick-marks on axes by setting the \texttt{lab} graphical parameter using the \texttt{par()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{lab =} \FunctionTok{c}\NormalTok{(}\FunctionTok{length}\NormalTok{(Time), }\DecValTok{10}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

~

The \texttt{par()} function sets a graphical parameter. The \texttt{lab} parameter is used to set the number tick-marks on the x and y axes and the label size. We have specified a tick-mark on the x-axis for each record (i.e.~using \texttt{length(Time)}), ten tick-marks on the y-axis, and a label length of seven. Test this by plotting two charts:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Rain, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(Cases, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-371-1} \end{center}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-372-1} \end{center}

~

The problem with these charts is that the month and year are not displayed on the x-axis. We can get round this by plotting a chart without axes and then specifying the axes and labels directly:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Rain, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"Time"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"mm"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Rainfall"}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{labels =} \FunctionTok{as.character}\NormalTok{(Time), }\AttributeTok{at =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(Time))}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-373-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Cases, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"Time"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"n"}\NormalTok{, }\AttributeTok{main =} \StringTok{"Cases"}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{labels =} \FunctionTok{as.character}\NormalTok{(Time), }\AttributeTok{at =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(Time))}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-373-2} \end{center}

~

The resulting charts now look much better (you may need to resize the plot to display the x-axis labels correctly) but it would be nice to be able draw the two lines on a single chart.

Before proceeding we will use the \texttt{par()} function to specify one plot per window (using the \texttt{mfrow} parameter) and set the default number of tick-marks on the axes (using the \texttt{lab} parameter):

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\FunctionTok{par}\NormalTok{(}\AttributeTok{lab =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

~

And then use the \texttt{plot()} and \texttt{lines()} function to draw the two lines on the same graph:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Cases, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{)}
\FunctionTok{lines}\NormalTok{(Rain, }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-375-1} \end{center}

~

The problem with this is that the ranges of the two variables are different and the \texttt{plot()} function automatically sets the y-axis to the range of the specified variable. To fix this problem we need to set the limits of the y-axis to the minimum and maximum value of both of variables using the \texttt{ylim} parameter of the \texttt{plot()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(Cases, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(Cases, Rain), }\FunctionTok{max}\NormalTok{(Cases, Rain)))}
\FunctionTok{lines}\NormalTok{(Rain, }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-376-1} \end{center}

~

We can improve the chart by adding a legend:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{legend}\NormalTok{(}\DecValTok{18}\NormalTok{, }\DecValTok{1000}\NormalTok{, }\AttributeTok{legend =} \FunctionTok{c}\NormalTok{(}\StringTok{"Cases"}\NormalTok{, }\StringTok{"Rainfall (mm)"}\NormalTok{), }\AttributeTok{lty =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-378-1} \end{center}

\newpage

We could continue to improve the chart (e.g.~by adding labels for the x-axis tick-marks taken from the \texttt{Time} variable, specifying more meaningful axis labels, and specifying a title) but the chart would be more useful if each variable made full use of the plotting area. We can do this by plotting one chart on top of another by using the \texttt{new} graphical parameter:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{lab =} \FunctionTok{c}\NormalTok{(}\FunctionTok{length}\NormalTok{(Time), }\DecValTok{5}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(Cases, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{2}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{new =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(Rain, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lty =} \DecValTok{2}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{4}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-379-1} \end{center}

~

This chart is much clearer but there are still some improvements that could be made:

\begin{itemize}
\item
  The chart should have a title. We can do this using the \texttt{main} parameter of either of the \texttt{plot()} functions.
\item
  The y-axis labels are displayed on top of each other beside the left-hand y-axis. We can solve this problem by preventing the second \texttt{plot()} function from displaying a y-axis label (i.e.~by specifying an empty character string for the \texttt{ylab} parameter).
\item
  We will need to make room on the right-hand side of the chart for an axis label (i.e.~by setting the \texttt{mar} (margin) graphical parameter) and place the label there ourselves (using the \texttt{mtext()} function).
\item
  The x-axis should display the month and year which are held as character strings in the \texttt{Time} variable. We can do this using the labels parameter of the \texttt{axis()} function after setting the appropriate number of tick-marks using the \texttt{lab} graphical parameter.
\end{itemize}

The x-axis should be properly labelled. We can do this using the \texttt{xlab} parameters of the \texttt{plot()} functions. An empty string must be specified for one of the \texttt{plot()} functions in order to prevent the default label from being displayed.

Try this now:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{))}
\FunctionTok{par}\NormalTok{(}\AttributeTok{lab =} \FunctionTok{c}\NormalTok{(}\FunctionTok{length}\NormalTok{(Time), }\DecValTok{5}\NormalTok{, }\DecValTok{7}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(Cases, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{"Malaria cases and rainfall"}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{2}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\AttributeTok{text =} \StringTok{"Malaria cases"}\NormalTok{, }\AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{line =} \DecValTok{3}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{new =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(Rain, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lty =} \DecValTok{2}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{"Month \& Year"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{4}\NormalTok{)}
\FunctionTok{mtext}\NormalTok{(}\AttributeTok{text =} \StringTok{"Rainfall (mm)"}\NormalTok{, }\AttributeTok{side =} \DecValTok{4}\NormalTok{, }\AttributeTok{line =} \DecValTok{3}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{labels =} \FunctionTok{as.character}\NormalTok{(Time), }\AttributeTok{at =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(Time))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-380-1} \end{center}

\newpage

Now that we know how to create a two-axis chart, we can write a function that we will be able to use whenever we need to plot two variables on the same chart. Create a new function called \texttt{plot2var()}:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plot2var }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{\}}
\end{Highlighting}
\end{Shaded}

~

This creates an empty function called \texttt{plot2var()}.

Use the \texttt{fix()} function to edit the \texttt{plot2var()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(plot2var)}
\end{Highlighting}
\end{Shaded}

~

Edit the function to read:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(y1,}
\NormalTok{         y2,}
\NormalTok{         x.ticks,}
         \AttributeTok{x.lab =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(x.ticks)),}
         \AttributeTok{y1.lab =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(y1)),}
         \AttributeTok{y2.lab =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(y2)),}
         \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(y1.lab, }\StringTok{"\&"}\NormalTok{, y2.lab)) \{}
\NormalTok{  old.par.mar }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\StringTok{"mar"}\NormalTok{)}
\NormalTok{  old.par.lab }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\StringTok{"lab"}\NormalTok{)}
  \FunctionTok{par}\NormalTok{(}\AttributeTok{mar =} \FunctionTok{c}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{missing}\NormalTok{(x.ticks)) \{}\FunctionTok{par}\NormalTok{(}\AttributeTok{lab =} \FunctionTok{c}\NormalTok{(}\FunctionTok{length}\NormalTok{(x.ticks), }\DecValTok{5}\NormalTok{, }\DecValTok{7}\NormalTok{))\}}
  \FunctionTok{plot}\NormalTok{(y1, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lty =} \DecValTok{1}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
       \AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =}\NormalTok{ main)}
  \FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{2}\NormalTok{)}
  \FunctionTok{mtext}\NormalTok{(}\AttributeTok{text =}\NormalTok{ y1.lab, }\AttributeTok{side =} \DecValTok{2}\NormalTok{, }\AttributeTok{line =} \DecValTok{3}\NormalTok{)}
  \FunctionTok{par}\NormalTok{(}\AttributeTok{new =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{plot}\NormalTok{(y2, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lty =} \DecValTok{2}\NormalTok{, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
       \AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{xlab =}\NormalTok{ x.lab)}
  \FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{4}\NormalTok{)}
  \FunctionTok{mtext}\NormalTok{(}\AttributeTok{text =}\NormalTok{ y2.lab, }\AttributeTok{side =} \DecValTok{4}\NormalTok{, }\AttributeTok{line =} \DecValTok{3}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{missing}\NormalTok{(x.ticks)) \{}
    \FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{, }\AttributeTok{labels =} \FunctionTok{as.character}\NormalTok{(x.ticks),}
         \AttributeTok{at =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(x.ticks))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{)\}}
  \FunctionTok{par}\NormalTok{(}\AttributeTok{mar =}\NormalTok{ old.par.mar)}
  \FunctionTok{par}\NormalTok{(}\AttributeTok{lab =}\NormalTok{ old.par.lab)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, save the file and quit the editor.

Note that with this function we have given some of the parameters default values in the function definition and we have also used the \texttt{if()} function to check whether the user specified a value for the \texttt{x.ticks} parameter. We also save and restore the graphical parameters \texttt{mar} and \texttt{lab} so as to prevent changes to these parameters in the \texttt{plot2var()} function affecting other graphical functions.

Let's try the \texttt{plot2var()} function with the test data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot2var}\NormalTok{(Rain, Cases)}
\FunctionTok{plot2var}\NormalTok{(Rain, Cases, Time)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-386-1} \end{center}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-387-1} \end{center}

~

Note how the function has used default values for the axis labels and chart title. We can override these default values if we want to:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot2var}\NormalTok{(Rain, Cases, Time, }\AttributeTok{x.lab =} \StringTok{"Month and Year"}\NormalTok{,}
         \AttributeTok{y1.lab =} \StringTok{"Rainfall (mm)"}\NormalTok{, }\AttributeTok{y2.lab =} \StringTok{"Cases of malaria"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-388-1} \end{center}

~

You might like to use the \texttt{save()} function to save the \texttt{plot2var()} function.

As an exercise you might want to edit the \texttt{plot2var()} function to automatically add a legend to the two-axis
chart using the \texttt{legend()} function with \texttt{y1.lab} and \texttt{y2.lab}. Before continuing we should detach the \texttt{mal} data.frame:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{detach}\NormalTok{(mal)}
\end{Highlighting}
\end{Shaded}

\hypertarget{population-pyramid}{%
\section{Population pyramid}\label{population-pyramid}}

A common chart type that is not available in many statistical applications and in \texttt{R} is the \emph{population pyramid}.

Before we go any further we should retrieve a dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pop }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"pop.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{attach}\NormalTok{(pop)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## The following objects are masked from fem (pos = 4):
## 
##     AGE, SEX
\end{verbatim}

\begin{verbatim}
## The following objects are masked from fem (pos = 5):
## 
##     AGE, SEX
\end{verbatim}

\begin{verbatim}
## The following objects are masked from fem (pos = 10):
## 
##     AGE, SEX
\end{verbatim}

~

The file \texttt{pop.dat} contains data on the age (in months) and sex of 438 children aged between six and sixty months collected as part of a nutritional anthropometry survey of the Khosh Valley in Northeast Afghanistan.

The columns in this dataset are as follows:

~

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.15}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.40}}@{}}
\toprule
\endhead
\textbf{AGE} & Age of the child in months \\
\textbf{SEX} & Sex of the child (M/F) \\
\bottomrule
\end{longtable}

~

Examine the first twenty records of the dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pop[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{20}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    AGE SEX
## 1    7   M
## 2   42   M
## 3   60   M
## 4   60   F
## 5   48   M
## 6   60   F
## 7   18   M
## 8   48   M
## 9   60   F
## 10  36   M
## 11  24   F
## 12  60   M
## 13  60   M
## 14  48   F
## 15  18   M
## 16  60   M
## 17   6   M
## 18   7   M
## 19  12   M
## 20  60   M
\end{verbatim}

~

The first step is to make groups from the \texttt{AGE} variable since many ages are biased towards full years:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(AGE)}
\FunctionTok{barplot}\NormalTok{(}\FunctionTok{table}\NormalTok{(AGE), }\AttributeTok{col =} \StringTok{"white"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## AGE
##  6  7  8  9 10 12 13 14 15 17 18 22 23 24 25 26 30 34 36 38 40 42 48 54 60 
##  7  5  8 15  3 21  1  3  5  1 45  1  1 48  1  2 24  1 80  2  1  9 67  4 83
\end{verbatim}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-393-1} \end{center}

~

So we will centre the age-groups around the months representing full years:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{age.group }\OtherTok{\textless{}{-}} \FunctionTok{cut}\NormalTok{(AGE, }\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{17}\NormalTok{, }\DecValTok{29}\NormalTok{, }\DecValTok{41}\NormalTok{, }\DecValTok{53}\NormalTok{, }\DecValTok{99}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\newpage

We can check that the grouping operation has worked as expected by tabulating \texttt{AGE} and \texttt{age.group}:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(AGE, age.group)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     age.group
## AGE  (0,17] (17,29] (29,41] (41,53] (53,99]
##   6       7       0       0       0       0
##   7       5       0       0       0       0
##   8       8       0       0       0       0
##   9      15       0       0       0       0
##   10      3       0       0       0       0
##   12     21       0       0       0       0
##   13      1       0       0       0       0
##   14      3       0       0       0       0
##   15      5       0       0       0       0
##   17      1       0       0       0       0
##   18      0      45       0       0       0
##   22      0       1       0       0       0
##   23      0       1       0       0       0
##   24      0      48       0       0       0
##   25      0       1       0       0       0
##   26      0       2       0       0       0
##   30      0       0      24       0       0
##   34      0       0       1       0       0
##   36      0       0      80       0       0
##   38      0       0       2       0       0
##   40      0       0       1       0       0
##   42      0       0       0       9       0
##   48      0       0       0      67       0
##   54      0       0       0       0       4
##   60      0       0       0       0      83
\end{verbatim}

\newpage

We now use the \texttt{table()} function to produce the summary data for the population pyramid:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{table}\NormalTok{(age.group, SEX)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          SEX
## age.group  F  M
##   (0,17]  34 35
##   (17,29] 54 44
##   (29,41] 49 59
##   (41,53] 39 37
##   (53,99] 41 46
\end{verbatim}

~

We will construct our population pyramid using the \texttt{barplot()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(}\FunctionTok{table}\NormalTok{(age.group, SEX))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-397-1} \end{center}

\newpage

The default behaviour of the \texttt{barplot()} function is to produce stacked bars. We can set the \texttt{beside} parameter to display the bars side-by-side:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(}\FunctionTok{table}\NormalTok{(age.group, SEX), }\AttributeTok{beside =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-398-1} \end{center}

~

We can also use the \texttt{horiz} parameter to present the data as horizontal bars:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(}\FunctionTok{table}\NormalTok{(age.group, SEX), }\AttributeTok{beside =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-399-1} \end{center}

\newpage

In order to centre the bars around zero we need to make one column of the summary data table contain negative numbers:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(age.group, SEX)}
\NormalTok{tab}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          SEX
## age.group  F  M
##   (0,17]  34 35
##   (17,29] 54 44
##   (29,41] 49 59
##   (41,53] 39 37
##   (53,99] 41 46
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tab[ ,}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\NormalTok{tab[ ,}\DecValTok{1}\NormalTok{]}
\NormalTok{tab}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          SEX
## age.group   F   M
##   (0,17]  -34  35
##   (17,29] -54  44
##   (29,41] -49  59
##   (41,53] -39  37
##   (53,99] -41  46
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(tab, }\AttributeTok{beside =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-400-1} \end{center}

~

This is looking better.

We still need to shift the second set of bars down beside the first set of bars using thespace parameter:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(tab, }\AttributeTok{beside =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{space =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\FunctionTok{nrow}\NormalTok{(tab)))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-401-1} \end{center}

~

The axis labels are wrong but we can fix that using the \texttt{names.arg} parameter:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bar.names }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{dimnames}\NormalTok{(tab)}\SpecialCharTok{$}\NormalTok{age.group, }\FunctionTok{dimnames}\NormalTok{(tab)}\SpecialCharTok{$}\NormalTok{age.group)}
\FunctionTok{barplot}\NormalTok{(tab, }\AttributeTok{beside =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{space =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\FunctionTok{nrow}\NormalTok{(tab)),}
        \AttributeTok{names.arg =}\NormalTok{ bar.names)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-402-1} \end{center}

\newpage

The chart can still be improved upon by making the fill-colour of each bar white and by expanding the x-axis slightly:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(tab, }\AttributeTok{beside =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{space =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\FunctionTok{nrow}\NormalTok{(tab)),}
        \AttributeTok{col =} \StringTok{"white"}\NormalTok{, }\AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(tab) }\SpecialCharTok{*} \FloatTok{1.2}\NormalTok{, }\FunctionTok{max}\NormalTok{(tab) }\SpecialCharTok{*} \FloatTok{1.2}\NormalTok{),}
        \AttributeTok{names.arg =}\NormalTok{ bar.names)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-403-1} \end{center}

~

The chart would be better if the x-axis displayed only positive numbers:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(tab, }\AttributeTok{beside =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{horiz =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{space =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\FunctionTok{nrow}\NormalTok{(tab)),}
        \AttributeTok{col =} \StringTok{"white"}\NormalTok{, }\AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(tab) }\SpecialCharTok{*} \FloatTok{1.2}\NormalTok{, }\FunctionTok{max}\NormalTok{(tab) }\SpecialCharTok{*} \FloatTok{1.2}\NormalTok{),}
        \AttributeTok{names.arg =}\NormalTok{ bar.names, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{,}
     \AttributeTok{labels =} \FunctionTok{abs}\NormalTok{(}\FunctionTok{axTicks}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{)),}
     \AttributeTok{at =}\NormalTok{ (}\FunctionTok{axTicks}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-405-1} \end{center}

Now we know how to create a population pyramid, we can write a function that we will be able to use whenever we need to plot a population pyramid.

Create a new function called \texttt{pyramid.plot()}:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pyramid.plot }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{\}}
\end{Highlighting}
\end{Shaded}

~

This creates an empty function called \texttt{pyramid.plot()}.

Use the \texttt{fix()} function to edit the \texttt{pyramid.plot()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(pyramid.plot)}
\end{Highlighting}
\end{Shaded}

\newpage

Edit the function to read:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(x,}
\NormalTok{         g,}
         \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Pyramid plot of"}\NormalTok{, }\FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(x)),}
                      \StringTok{"by"}\NormalTok{, }\FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(g))),}
         \AttributeTok{xlab =} \FunctionTok{paste}\NormalTok{(}\FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(g)),}
                      \StringTok{"("}\NormalTok{, }\FunctionTok{levels}\NormalTok{(g)[}\DecValTok{1}\NormalTok{], }\StringTok{"/"}\NormalTok{,}\FunctionTok{levels}\NormalTok{(g)[}\DecValTok{2}\NormalTok{],}\StringTok{")"}\NormalTok{),}
         \AttributeTok{ylab =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(x))) \{}
\NormalTok{  tab }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(x, g)}
\NormalTok{  tab[ ,}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\NormalTok{tab[ ,}\DecValTok{1}\NormalTok{]}
  \FunctionTok{barplot}\NormalTok{(tab,}
          \AttributeTok{horiz =} \ConstantTok{TRUE}\NormalTok{,}
          \AttributeTok{beside =} \ConstantTok{TRUE}\NormalTok{,}
          \AttributeTok{space =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\FunctionTok{nrow}\NormalTok{(tab)),}
          \AttributeTok{names.arg =} \FunctionTok{c}\NormalTok{(}\FunctionTok{dimnames}\NormalTok{(tab)}\SpecialCharTok{$}\NormalTok{x, }\FunctionTok{dimnames}\NormalTok{(tab)}\SpecialCharTok{$}\NormalTok{x),}
          \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(tab) }\SpecialCharTok{*} \FloatTok{1.2}\NormalTok{,}
          \FunctionTok{max}\NormalTok{(tab) }\SpecialCharTok{*} \FloatTok{1.2}\NormalTok{),}
          \AttributeTok{col =} \StringTok{"white"}\NormalTok{,}
          \AttributeTok{main =}\NormalTok{ main,}
          \AttributeTok{xlab =}\NormalTok{ xlab,}
          \AttributeTok{ylab =}\NormalTok{ ylab,}
          \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
  \FunctionTok{axis}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{,}
       \AttributeTok{labels =} \FunctionTok{abs}\NormalTok{(}\FunctionTok{axTicks}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{)),}
       \AttributeTok{at =}\NormalTok{ (}\FunctionTok{axTicks}\NormalTok{(}\AttributeTok{side =} \DecValTok{1}\NormalTok{)))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Note that with this function we have given some of the parameters default values in the function definition.

Giving default values to parameters is useful because it means that you do not need to specify parameters such as titles and axis labels unless you want to. Many \texttt{R} functions use default parameters which are usually set to the most frequently used values.

Once you have made the changes shown above, check your work, save the file, and quit the editor. Let's try the \texttt{pyramid.plot()} function with the test data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pyramid.plot}\NormalTok{(age.group, SEX)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-410-1} \end{center}

~

Note how the function has used default values for the axis labels and chart titles. We can override these default values if we want to:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pyramid.plot}\NormalTok{(age.group, SEX, }\AttributeTok{ylab =} \StringTok{"Months"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"Sex F / M"}\NormalTok{,}
             \AttributeTok{main =} \StringTok{"Children by age and sex"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-412-1} \end{center}

~

You might like to use the \texttt{save()} function to save the \texttt{pyramid.plot()} function.

\hypertarget{pareto-chart}{%
\section{Pareto chart}\label{pareto-chart}}

Another type of chart that is missing from many statistical applications is the \emph{Pareto} chart which is a bar chart where the bars are sorted by the bar value with the largest bar drawn first. Such a chart is easier to interpret than a pie chart, particularly when there are more than a few categories being plotted.

Before we go any further we should detach the \texttt{pop} data.frame and retrieve a new dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{detach}\NormalTok{(pop)}
\NormalTok{sssw }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"sssw.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{attach}\NormalTok{(sssw)}
\end{Highlighting}
\end{Shaded}

~

The file \texttt{sssw.dat} contains data on the marital status, home circumstances, and ethnic group of 152 persons recruited into a study into the levels of stress experienced by student social workers in the United Kingdom. The columns in this dataset are as follows:

~

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.22}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.57}}@{}}
\toprule
\endhead
\textbf{marital} & Marital status coded as:

1 = Married

2 = Single

3 = Divorced

4 = Separated

5 = Cohabiting

6 = Widowed \\
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.22}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.57}}@{}}
\toprule
\endhead
\textbf{living} & Living with\ldots{} coded as:

1 = Alone

2 = Parents or siblings

3 = Partner

4 = Partner and children

5 = Children

6 = Friends or colleagues \\
\bottomrule
\end{longtable}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.22}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.57}}@{}}
\toprule
\endhead
\textbf{ethnic} & Ethnic group coded as:

1 = African

2 = West-Indian

3 = Indian

4 = Pakistani

5 = Bangladeshi

6 = East African Asian

7 = Chinese

8 = Cypriot

9 = Black European

10 = White European

11 = Other \\
\bottomrule
\end{longtable}

\newpage

Examine the dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sssw[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{20}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    marital living ethnic
## 1        2      5      2
## 2        1      4      2
## 3        1      1     11
## 4        1      4     10
## 5        2      3     10
## 6        2      6     10
## 7        1      4     10
## 8        1      4     10
## 9        2      2      4
## 10       2      6     10
## 11       2      5     10
## 12       1      3      1
## 13       5      3     10
## 14       1      4     10
## 15       2      6      3
## 16       1      4     10
## 17       1      3      3
## 18       5      3     10
## 19       3      5     10
## 20       5      3     10
\end{verbatim}

~

Producing a bar chart from this data is simple as long as we remember to pass summary data (i.e.~created using the \texttt{table()} function) to the \texttt{barplot()} function instead of the variable name:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(}\FunctionTok{table}\NormalTok{(marital))}
\FunctionTok{barplot}\NormalTok{(}\FunctionTok{table}\NormalTok{(living))}
\FunctionTok{barplot}\NormalTok{(}\FunctionTok{table}\NormalTok{(ethnic))}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(}\FunctionTok{table}\NormalTok{(marital))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-416-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(}\FunctionTok{table}\NormalTok{(living))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-417-1} \end{center}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(}\FunctionTok{table}\NormalTok{(ethnic))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-418-1} \end{center}

~

Creating a Pareto chart only requires us to sort the summary data. We do this using the \texttt{rev()} and \texttt{sort()} functions:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(}\FunctionTok{rev}\NormalTok{(}\FunctionTok{sort}\NormalTok{(}\FunctionTok{table}\NormalTok{(marital))))}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-419-1.pdf}

\newpage

Having to specify \texttt{rev(sort(table(variable)))} each time we want to produce a \emph{Pareto} plot is rather tedious but now that we know how to create a \emph{Pareto} chart, we can write a function that we will be able to use whenever we need to plot a Pareto chart. Create a new function called \texttt{pareto()}:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pareto }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{\}}
\end{Highlighting}
\end{Shaded}

~

This creates an empty function called \texttt{pareto()}. Use the \texttt{fix()} function to edit the \texttt{pareto()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(pareto)}
\end{Highlighting}
\end{Shaded}

Edit the function to read:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(x,}
         \AttributeTok{xlab =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(x)),}
         \AttributeTok{ylab =} \StringTok{"Count"}\NormalTok{,}
         \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Pareto Chart of"}\NormalTok{, }\FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(x)))) \{}
  \FunctionTok{barplot}\NormalTok{(}\FunctionTok{rev}\NormalTok{(}\FunctionTok{sort}\NormalTok{(}\FunctionTok{table}\NormalTok{(x))),}
          \AttributeTok{xlab =}\NormalTok{ xlab,}
          \AttributeTok{ylab =}\NormalTok{ ylab,}
          \AttributeTok{main =}\NormalTok{ main,}
          \AttributeTok{col =} \StringTok{"white"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, check your work, save the file, and quit the editor.

\newpage

Let's try the \texttt{pareto()} function with the test data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pareto}\NormalTok{(marital)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-424-1} \end{center}

~

Note how the function has used default values for the axis labels and chart titles. We can override these default values if we want to:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pareto}\NormalTok{(marital, }\AttributeTok{ylab =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"Marital Status"}\NormalTok{,}
       \AttributeTok{main =} \StringTok{"Marital Status"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-425-1} \end{center}

\newpage

Note that we can use value labels if the variable we plot is a factor with value labels as levels rather than a simple numeric vector:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ms }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(marital)}
\FunctionTok{levels}\NormalTok{(ms) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Married"}\NormalTok{, }\StringTok{"Single"}\NormalTok{, }\StringTok{"Divorced"}\NormalTok{, }\StringTok{"Separated"}\NormalTok{,}
                \StringTok{"Cohabiting"}\NormalTok{, }\StringTok{"Widowed"}\NormalTok{)}
\FunctionTok{table}\NormalTok{(ms)}
\FunctionTok{pareto}\NormalTok{(ms, }\AttributeTok{ylab =} \StringTok{"n"}\NormalTok{, }\AttributeTok{xlab =} \StringTok{"Marital Status"}\NormalTok{,}
       \AttributeTok{main =} \StringTok{"Marital Status"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ms
##    Married     Single   Divorced  Separated Cohabiting    Widowed 
##         32         90          5          4         21          0
\end{verbatim}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-427-1} \end{center}

~

You may need to resize the plot to display the x-axis labels correctly.

You might like to use the \texttt{save()} function to save the \texttt{pareto()} function.

\newpage

\hypertarget{adding-confidence-intervals-or-error-bars-on-plots}{%
\section{Adding confidence intervals or error bars on plots}\label{adding-confidence-intervals-or-error-bars-on-plots}}

You may want to plot your data with confidence intervals or error bars. \texttt{R} does not have a function to do this but it is a relatively simple matter to write a function to do so. On the way we will use some of \texttt{R}s data management functions as well.

Before we go any further we should detach the \texttt{sssw} data.frame and retrieve a new dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{detach}\NormalTok{(sssw)}
\NormalTok{diets }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"diets.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

The file \texttt{diets.dat} contains data from a trial of two different diets undertaken at an adult therapeutic feeding centre in Somalia. The columns in this dataset are as follows:

~

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.16}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.84}}@{}}
\toprule
\endhead
\textbf{day} & The day after start of diet that measurements were taken \\
\textbf{oedema} & Type of undernutrition coded as: 1 = Oedematous; 2 = Marasmic \\
\textbf{diet} & The trial diets coded as: LP = Low protein; HP = High protein \\
\textbf{wt} & Mean weight change weight velocity) in g/kg/day since the previous measurement \\
\textbf{sd} & Standard deviation of weight change in g/kg/day \\
\textbf{n} & Number of subjects at each observation \\
\bottomrule
\end{longtable}

~

Examine the dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diets}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    day oedema diet   wt   sd   n
## 1    3      1   HP  1.1 11.5  37
## 2    6      1   HP  1.0 11.0  37
## 3    9      1   HP  1.2  8.4  37
## 4   12      1   HP -1.0  7.4  37
## 5   15      1   HP -0.9  3.2  37
## 6   18      1   HP -1.7  5.8  37
## 7   21      1   HP -1.7  4.8  37
## 8   24      1   HP -1.7  4.8  37
## 9   27      1   HP -1.7  5.3  37
## 10  30      1   HP -2.5  6.8  37
## 11  33      1   HP -1.3  8.4  37
## 12   3      2   HP  5.1 15.1 291
## 13   6      2   HP  5.1 13.4 291
## 14   9      2   HP  4.5  6.5 291
## 15  12      2   HP  5.2  9.9 291
## 16  15      2   HP  4.6  8.2 291
## 17  18      2   HP  5.1 13.4 291
## 18  21      2   HP  5.0 13.4 291
## 19  24      2   HP  5.2 15.1 291
## 20  27      2   HP  5.1 11.6 291
## 21  30      2   HP  5.0  9.2 291
## 22  33      2   HP  5.2  8.2 291
## 23   3      1   LP -3.0 15.7  65
## 24   6      1   LP -2.5 11.9  65
## 25   9      1   LP -2.0 13.7  65
## 26  12      1   LP  2.0 11.0  65
## 27  15      1   LP  2.1 13.2  65
## 28  18      1   LP  1.7 16.2  65
## 29  21      1   LP  4.0 11.0  65
## 30  24      1   LP  6.5 14.7  65
## 31  27      1   LP  6.4 10.2  65
## 32  30      1   LP  6.6  8.0  65
## 33  33      1   LP  6.5 11.0  65
## 34   3      2   LP  5.1 11.1  86
## 35   6      2   LP  6.0  8.2  86
## 36   9      2   LP  5.1  8.2  86
## 37  12      2   LP  6.5 11.9  86
## 38  15      2   LP  6.4  9.1  86
## 39  18      2   LP  5.9 13.8  86
## 40  21      2   LP  6.1 16.5  86
## 41  24      2   LP  4.0  9.1  86
## 42  27      2   LP  3.1 12.8  86
## 43  30      2   LP  4.0  7.3  86
## 44  33      2   LP  5.0  9.1  86
\end{verbatim}

\newpage

Note that the dataset contains a summary of the results from the four arms of the trial:

~

\begin{longtable}[]{@{}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.15}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.22}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.36}}@{}}
\toprule
\begin{minipage}[b]{\linewidth}\centering
\textbf{Arm}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Oedema}
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
\textbf{Therapeutic diet}
\end{minipage} \\
\midrule
\endhead
1 & Present & High protein \\
2 & Present & Low protein \\
3 & Absent & High protein \\
4 & Absent & Low protein \\
\bottomrule
\end{longtable}

~

with observations at 3, 6, 9, 12, 15, 18, 21, 24, 27, 30, and 33 days after admission.

We can calculate a confidence interval for the mean weight velocity (\texttt{wt}) using the data in the \texttt{sd} and \texttt{n}
variables. We will use the \texttt{transform()} function to do this:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diets }\OtherTok{\textless{}{-}} \FunctionTok{transform}\NormalTok{(diets, }\AttributeTok{lci =}\NormalTok{ wt }\SpecialCharTok{{-}}\NormalTok{ sd }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(n), }\AttributeTok{uci =}\NormalTok{ wt }\SpecialCharTok{+}\NormalTok{ sd }\SpecialCharTok{/} \FunctionTok{sqrt}\NormalTok{(n))}
\end{Highlighting}
\end{Shaded}

~

In this case we are calculating confidence intervals as plus or minus one standard error of the mean.

The \texttt{transform()} function is very useful as it can add columns directly to a data.frame or transform data already stored in a data.frame.

\newpage

Examine the \texttt{diets} data.frame:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{diets}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    day oedema diet   wt   sd   n        lci         uci
## 1    3      1   HP  1.1 11.5  37 -0.7905884  2.99058835
## 2    6      1   HP  1.0 11.0  37 -0.8083889  2.80838886
## 3    9      1   HP  1.2  8.4  37 -0.1809515  2.58095149
## 4   12      1   HP -1.0  7.4  37 -2.2165525  0.21655251
## 5   15      1   HP -0.9  3.2  37 -1.4260768 -0.37392324
## 6   18      1   HP -1.7  5.8  37 -2.6535141 -0.74648587
## 7   21      1   HP -1.7  4.8  37 -2.4891151 -0.91088486
## 8   24      1   HP -1.7  4.8  37 -2.4891151 -0.91088486
## 9   27      1   HP -1.7  5.3  37 -2.5713146 -0.82868537
## 10  30      1   HP -2.5  6.8  37 -3.6179131 -1.38208689
## 11  33      1   HP -1.3  8.4  37 -2.6809515  0.08095149
## 12   3      2   HP  5.1 15.1 291  4.2148223  5.98517768
## 13   6      2   HP  5.1 13.4 291  4.3144781  5.88552191
## 14   9      2   HP  4.5  6.5 291  4.1189633  4.88103675
## 15  12      2   HP  5.2  9.9 291  4.6196517  5.78034828
## 16  15      2   HP  4.6  8.2 291  4.1193075  5.08069251
## 17  18      2   HP  5.1 13.4 291  4.3144781  5.88552191
## 18  21      2   HP  5.0 13.4 291  4.2144781  5.78552191
## 19  24      2   HP  5.2 15.1 291  4.3148223  6.08517768
## 20  27      2   HP  5.1 11.6 291  4.4199960  5.78000404
## 21  30      2   HP  5.0  9.2 291  4.4606864  5.53931355
## 22  33      2   HP  5.2  8.2 291  4.7193075  5.68069251
## 23   3      1   LP -3.0 15.7  65 -4.9473453 -1.05265467
## 24   6      1   LP -2.5 11.9  65 -3.9760133 -1.02398666
## 25   9      1   LP -2.0 13.7  65 -3.6992759 -0.30072414
## 26  12      1   LP  2.0 11.0  65  0.6356179  3.36438208
## 27  15      1   LP  2.1 13.2  65  0.4627415  3.73725850
## 28  18      1   LP  1.7 16.2  65 -0.3093627  3.70936270
## 29  21      1   LP  4.0 11.0  65  2.6356179  5.36438208
## 30  24      1   LP  6.5 14.7  65  4.6766894  8.32331060
## 31  27      1   LP  6.4 10.2  65  5.1348457  7.66515429
## 32  30      1   LP  6.6  8.0  65  5.6077221  7.59227788
## 33  33      1   LP  6.5 11.0  65  5.1356179  7.86438208
## 34   3      2   LP  5.1 11.1  86  3.9030562  6.29694378
## 35   6      2   LP  6.0  8.2  86  5.1157713  6.88422874
## 36   9      2   LP  5.1  8.2  86  4.2157713  5.98422874
## 37  12      2   LP  6.5 11.9  86  5.2167900  7.78321000
## 38  15      2   LP  6.4  9.1  86  5.4187218  7.38127824
## 39  18      2   LP  5.9 13.8  86  4.4119077  7.38809227
## 40  21      2   LP  6.1 16.5  86  4.3207592  7.87924076
## 41  24      2   LP  4.0  9.1  86  3.0187218  4.98127824
## 42  27      2   LP  3.1 12.8  86  1.7197405  4.48025950
## 43  30      2   LP  4.0  7.3  86  3.2128208  4.78717924
## 44  33      2   LP  5.0  9.1  86  4.0187218  5.98127824
\end{verbatim}

~

Two new columns (\texttt{lci} and \texttt{uci}) have been added.

Now that we have calculated the confidence intervals we should, for convenience, split the diets data.frame
into four separate data.frames (one for each arm of the trial):

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{oed.hp }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(diets, oedema }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&}\NormalTok{ diet }\SpecialCharTok{==} \StringTok{"HP"}\NormalTok{)}
\NormalTok{oed.lp }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(diets, oedema }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&}\NormalTok{ diet }\SpecialCharTok{==} \StringTok{"LP"}\NormalTok{)}
\NormalTok{mar.hp }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(diets, oedema }\SpecialCharTok{==} \DecValTok{2} \SpecialCharTok{\&}\NormalTok{ diet }\SpecialCharTok{==} \StringTok{"HP"}\NormalTok{)}
\NormalTok{mar.lp }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(diets, oedema }\SpecialCharTok{==} \DecValTok{2} \SpecialCharTok{\&}\NormalTok{ diet }\SpecialCharTok{==} \StringTok{"LP"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

~

Check that each data.frame contains the data that you expect it to:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{oed.hp}
\NormalTok{oed.lp}
\NormalTok{mar.hp}
\NormalTok{mar.lp}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{oed.hp}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    day oedema diet   wt   sd  n        lci         uci
## 1    3      1   HP  1.1 11.5 37 -0.7905884  2.99058835
## 2    6      1   HP  1.0 11.0 37 -0.8083889  2.80838886
## 3    9      1   HP  1.2  8.4 37 -0.1809515  2.58095149
## 4   12      1   HP -1.0  7.4 37 -2.2165525  0.21655251
## 5   15      1   HP -0.9  3.2 37 -1.4260768 -0.37392324
## 6   18      1   HP -1.7  5.8 37 -2.6535141 -0.74648587
## 7   21      1   HP -1.7  4.8 37 -2.4891151 -0.91088486
## 8   24      1   HP -1.7  4.8 37 -2.4891151 -0.91088486
## 9   27      1   HP -1.7  5.3 37 -2.5713146 -0.82868537
## 10  30      1   HP -2.5  6.8 37 -3.6179131 -1.38208689
## 11  33      1   HP -1.3  8.4 37 -2.6809515  0.08095149
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{oed.lp}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    day oedema diet   wt   sd  n        lci        uci
## 23   3      1   LP -3.0 15.7 65 -4.9473453 -1.0526547
## 24   6      1   LP -2.5 11.9 65 -3.9760133 -1.0239867
## 25   9      1   LP -2.0 13.7 65 -3.6992759 -0.3007241
## 26  12      1   LP  2.0 11.0 65  0.6356179  3.3643821
## 27  15      1   LP  2.1 13.2 65  0.4627415  3.7372585
## 28  18      1   LP  1.7 16.2 65 -0.3093627  3.7093627
## 29  21      1   LP  4.0 11.0 65  2.6356179  5.3643821
## 30  24      1   LP  6.5 14.7 65  4.6766894  8.3233106
## 31  27      1   LP  6.4 10.2 65  5.1348457  7.6651543
## 32  30      1   LP  6.6  8.0 65  5.6077221  7.5922779
## 33  33      1   LP  6.5 11.0 65  5.1356179  7.8643821
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mar.hp}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    day oedema diet  wt   sd   n      lci      uci
## 12   3      2   HP 5.1 15.1 291 4.214822 5.985178
## 13   6      2   HP 5.1 13.4 291 4.314478 5.885522
## 14   9      2   HP 4.5  6.5 291 4.118963 4.881037
## 15  12      2   HP 5.2  9.9 291 4.619652 5.780348
## 16  15      2   HP 4.6  8.2 291 4.119307 5.080693
## 17  18      2   HP 5.1 13.4 291 4.314478 5.885522
## 18  21      2   HP 5.0 13.4 291 4.214478 5.785522
## 19  24      2   HP 5.2 15.1 291 4.314822 6.085178
## 20  27      2   HP 5.1 11.6 291 4.419996 5.780004
## 21  30      2   HP 5.0  9.2 291 4.460686 5.539314
## 22  33      2   HP 5.2  8.2 291 4.719307 5.680693
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mar.lp}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    day oedema diet  wt   sd  n      lci      uci
## 34   3      2   LP 5.1 11.1 86 3.903056 6.296944
## 35   6      2   LP 6.0  8.2 86 5.115771 6.884229
## 36   9      2   LP 5.1  8.2 86 4.215771 5.984229
## 37  12      2   LP 6.5 11.9 86 5.216790 7.783210
## 38  15      2   LP 6.4  9.1 86 5.418722 7.381278
## 39  18      2   LP 5.9 13.8 86 4.411908 7.388092
## 40  21      2   LP 6.1 16.5 86 4.320759 7.879241
## 41  24      2   LP 4.0  9.1 86 3.018722 4.981278
## 42  27      2   LP 3.1 12.8 86 1.719741 4.480259
## 43  30      2   LP 4.0  7.3 86 3.212821 4.787179
## 44  33      2   LP 5.0  9.1 86 4.018722 5.981278
\end{verbatim}

~

We can now plot the data for one arm of the trial:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{wt, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-439-1} \end{center}

\newpage

We can add error bars using the \texttt{arrows()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{arrows}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{lci, oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{uci, }
       \AttributeTok{code =} \DecValTok{3}\NormalTok{, }\AttributeTok{angle =} \DecValTok{90}\NormalTok{, }\AttributeTok{length =} \FloatTok{0.1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-441-1} \end{center}

~

The scale of the y axis is wrong because the \texttt{plot()} function automatically scales axes to the ranges of the x and y data it is given. We can fix this by specifying a different set of limits (from \texttt{lci} and \texttt{uci}) for the y axis using the \texttt{ylim} parameter:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{wt, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{, }
     \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{lci), }\FunctionTok{max}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{uci)))}
\FunctionTok{arrows}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{lci, oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{uci, }
       \AttributeTok{code =} \DecValTok{3}\NormalTok{, }\AttributeTok{angle =} \DecValTok{90}\NormalTok{, }\AttributeTok{length =} \FloatTok{0.1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-443-1} \end{center}

~

The plot might also be improved by adding plotting symbols:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{points}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{wt, }\AttributeTok{pch =} \DecValTok{21}\NormalTok{, }\AttributeTok{bg =} \StringTok{"white"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-445-1} \end{center}

\newpage

The axis titles (\texttt{oed.hp\$day} and \texttt{oed.hp\$wt}) are the column (variable) names.

We can specify titles and axes labels in the call to the \texttt{plot()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{wt, }\AttributeTok{type =} \StringTok{"l"}\NormalTok{,}
     \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{lci), }\FunctionTok{max}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{uci)),}
     \AttributeTok{main =} \StringTok{"HP Diet. Oedematous Cases"}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{"Days of treatment"}\NormalTok{, }\AttributeTok{ylab =} \StringTok{"Weight gain (g/kg/d)"}\NormalTok{)}

\FunctionTok{arrows}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{lci, oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{uci,}
       \AttributeTok{code =} \DecValTok{3}\NormalTok{, }\AttributeTok{angle =} \DecValTok{90}\NormalTok{, }\AttributeTok{length =} \FloatTok{0.1}\NormalTok{)}

\FunctionTok{points}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{wt, }\AttributeTok{pch =} \DecValTok{21}\NormalTok{, }\AttributeTok{bg =} \StringTok{"white"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-447-1} \end{center}

~

Now that we know how to plot error bars, we can write a function that we will be able to use whenever we need to plot data with error bars.

Before continuing we will consider what the new function should be able to do. This will help us when it comes to writing the function. Our new function should:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Take four numeric vectors (x, y, lower CI for y, and upper CI for y) and plot them.
\item
  Be able to plot the data points as unconnected points or as points joined by lines.
\item
  Calculate appropriate limits for the y-axis.
\item
  Produce a plot without axes so that more than one data series may be plotted on the same chart. 5. Provide sensible default values for axis limits and labels.
\end{enumerate}

From this list we know that we need the function to take several parameters:

~

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.17}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.35}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.43}}@{}}
\toprule
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Name}
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
\textbf{Purpose}
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
\textbf{Default value}
\end{minipage} \\
\midrule
\endhead
\texttt{x} & Data to plot & None \\
\texttt{y} & Data to plot & None \\
\texttt{y.lci} & Data to plot & None \\
\texttt{y.uci} & Data to plot & None \\
\texttt{ylim} & Limits for y axis & \texttt{c(min(y.lci),\ max(y.uci))} \\
\texttt{xlab} & Label for x axis & \texttt{deparse(substitute(x))} \\
\texttt{ylab} & Label for y axis & \texttt{deparse(substitute(y))} \\
\texttt{main} & Chart title & \texttt{paste(ylab,\ "by",\ xlab)} \\
\texttt{type} & Type of plot & \texttt{"l"} \\
\texttt{lty} & Line type & \texttt{1} \\
\texttt{col} & Line and point colour & \texttt{"black"} \\
\texttt{axes} & Draw x and y axes & \texttt{TRUE} \\
\texttt{pch} & Type of points to plot & \texttt{1} \\
\texttt{bg} & Fill colour of point & \texttt{white} \\
\bottomrule
\end{longtable}

~

The parameter names have been chosen to be the same as the parameter names to \texttt{plot()} and \texttt{points()}. This makes the function easier to use. It also makes the function easier to write.

Create a new function called \texttt{plot.ci()}:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plot.ci }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{\}}
\end{Highlighting}
\end{Shaded}

~

This creates an empty function called \texttt{plot.ci()}.

Use the \texttt{fix()} function to edit the \texttt{plot.ci()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(plot.ci)}
\end{Highlighting}
\end{Shaded}

\newpage

Edit the function to read:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(x,}
\NormalTok{         y, y.lci, y.uci,}
         \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(y.lci), }\FunctionTok{max}\NormalTok{(y.uci)),}
         \AttributeTok{xlab =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(x)),}
         \AttributeTok{ylab =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(y)),}
         \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(ylab, }\StringTok{"by"}\NormalTok{, xlab),}
         \AttributeTok{type =} \StringTok{"l"}\NormalTok{,}
         \AttributeTok{lty =} \DecValTok{1}\NormalTok{,}
         \AttributeTok{col =} \StringTok{"black"}\NormalTok{,}
         \AttributeTok{axes =} \ConstantTok{TRUE}\NormalTok{,}
         \AttributeTok{pch =} \DecValTok{21}\NormalTok{,}
         \AttributeTok{bg =} \StringTok{"white"}\NormalTok{) \{}

  \FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{type =}\NormalTok{ type, }\AttributeTok{ylim =}\NormalTok{ ylim, }\AttributeTok{xlab =}\NormalTok{ xlab, }\AttributeTok{ylab =}\NormalTok{ ylab,}
       \AttributeTok{main =}\NormalTok{ main, }\AttributeTok{lty =}\NormalTok{ lty, }\AttributeTok{col =}\NormalTok{ col, }\AttributeTok{axes =}\NormalTok{ axes)}
  
  \FunctionTok{arrows}\NormalTok{(x, y.lci, x, y.uci, }\AttributeTok{code =} \DecValTok{3}\NormalTok{, }\AttributeTok{angle =} \DecValTok{90}\NormalTok{, }\AttributeTok{length =} \FloatTok{0.1}\NormalTok{,}
         \AttributeTok{lty =}\NormalTok{ lty, }\AttributeTok{col =}\NormalTok{ col)}
  
  \FunctionTok{points}\NormalTok{(x, y, }\AttributeTok{pch =}\NormalTok{ pch, }\AttributeTok{bg =}\NormalTok{ bg, }\AttributeTok{col =}\NormalTok{ col)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, check your work, save the file, and quit the editor.

\newpage

Let's try the \texttt{plot.ci()} function with the test data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot.ci}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{wt, oed.hp}\SpecialCharTok{$}\NormalTok{lci, oed.hp}\SpecialCharTok{$}\NormalTok{uci)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-452-1} \end{center}

~

Note how the function has used default values for the axis labels, chart titles, chart limits etc.

We can override these default values if we need to:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot.ci}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{wt, oed.hp}\SpecialCharTok{$}\NormalTok{lci, oed.hp}\SpecialCharTok{$}\NormalTok{uci,}
        \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{6}\NormalTok{, }\DecValTok{10}\NormalTok{), }\AttributeTok{xlab =} \StringTok{"Day"}\NormalTok{,}
        \AttributeTok{ylab =} \StringTok{"Weight gain (g/kg/day)"}\NormalTok{,}
        \AttributeTok{main =} \StringTok{"Oedematous"}\NormalTok{, }\AttributeTok{col =} \StringTok{"red"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-454-1} \end{center}

~

Do not close the plot window.

We should also check that we can plot another data series on this chart:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{new =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{plot.ci}\NormalTok{(oed.lp}\SpecialCharTok{$}\NormalTok{day, oed.lp}\SpecialCharTok{$}\NormalTok{wt, oed.lp}\SpecialCharTok{$}\NormalTok{lci, oed.lp}\SpecialCharTok{$}\NormalTok{uci,}
        \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{pch =} \DecValTok{22}\NormalTok{, }\AttributeTok{xlab =} \StringTok{""}\NormalTok{, }\AttributeTok{ylab =} \StringTok{""}\NormalTok{, }\AttributeTok{main =} \StringTok{""}\NormalTok{,}
        \AttributeTok{col =} \StringTok{"darkgreen"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-456-1} \end{center}

~

We can also add a legend:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{legend}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{8}\NormalTok{, }\AttributeTok{legend =} \FunctionTok{c}\NormalTok{(}\StringTok{"HP"}\NormalTok{, }\StringTok{"LP"}\NormalTok{), }\AttributeTok{lty =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{),}
       \AttributeTok{pch =} \FunctionTok{c}\NormalTok{(}\DecValTok{21}\NormalTok{, }\DecValTok{22}\NormalTok{), }\AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"red"}\NormalTok{, }\StringTok{"darkgreen"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-458-1} \end{center}

~

We should also check that we can produce plots of unconnected points:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot.ci}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{wt, oed.hp}\SpecialCharTok{$}\NormalTok{lci, oed.hp}\SpecialCharTok{$}\NormalTok{uci, }\AttributeTok{type =} \StringTok{"p"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-459-1} \end{center}

~

Try plotting the data for the marasmic patients using the \texttt{plot.ci()} function.

You might like to use the \texttt{save()} function to save the \texttt{plot.ci()} function.

We can use a similar technique to add error bars to different types of plot. If we plot the weight velocities for oedematous patients receiving the high protein diet as a bar chart:

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{wt, }\AttributeTok{names.arg =}\NormalTok{ oed.hp}\SpecialCharTok{$}\NormalTok{day, }\AttributeTok{col =} \StringTok{"white"}\NormalTok{, }
        \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{lci), }\FunctionTok{max}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{uci)))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-460-1} \end{center}

~

we could add error bars using the \texttt{arrows()} function as we did with a line plot:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{arrows}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{lci, oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{uci, }
       \AttributeTok{code =} \DecValTok{3}\NormalTok{, }\AttributeTok{angle =} \DecValTok{90}\NormalTok{, }\AttributeTok{length =} \FloatTok{0.1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-462-1} \end{center}

~

but this does not produce the expected results because the centres of the bars are not placed on the chart at the positions held in \texttt{oed.hp\$day}. This is easily fixed as \texttt{barplot()} returns a numeric vector (or matrix, when \texttt{beside\ =\ TRUE}) containing the co-ordinates of the bar midpoints:

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bar.positions }\OtherTok{\textless{}{-}} \FunctionTok{barplot}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{wt, }\AttributeTok{names.arg =}\NormalTok{ oed.hp}\SpecialCharTok{$}\NormalTok{day,}
                         \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{lci), }\FunctionTok{max}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{uci)),}
                         \AttributeTok{col =} \StringTok{"white"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-463-1} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bar.positions}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       [,1]
##  [1,]  0.7
##  [2,]  1.9
##  [3,]  3.1
##  [4,]  4.3
##  [5,]  5.5
##  [6,]  6.7
##  [7,]  7.9
##  [8,]  9.1
##  [9,] 10.3
## [10,] 11.5
## [11,] 12.7
\end{verbatim}

~

We can now use the information stored in \texttt{bar.positions} to specify the positions of the error bars:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{arrows}\NormalTok{(bar.positions, oed.hp}\SpecialCharTok{$}\NormalTok{lci, bar.positions, oed.hp}\SpecialCharTok{$}\NormalTok{uci,}
       \AttributeTok{code =} \DecValTok{3}\NormalTok{, }\AttributeTok{angle =} \DecValTok{90}\NormalTok{, }\AttributeTok{length =} \FloatTok{0.1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-465-1} \end{center}

~

Armed with this information, we can write a function that we will be able to use whenever we need to plot a bar chart with error bars.

Create a new function called \texttt{barplot.ci()}:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{barplot.ci }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{\}}
\end{Highlighting}
\end{Shaded}

~

This creates an empty function called \texttt{barplot.ci()}.

Use the \texttt{fix()} function to edit the \texttt{barplot.ci()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(barplot.ci)}
\end{Highlighting}
\end{Shaded}

\newpage

Edit the function to read:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(y, bar.names, lci, uci,}
         \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(lci), }\FunctionTok{max}\NormalTok{(uci)),}
         \AttributeTok{xlab =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(bar.names)),}
         \AttributeTok{ylab =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(y)),}
         \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(ylab, }\StringTok{"by"}\NormalTok{, xlab)) \{}
     
\NormalTok{  bp }\OtherTok{\textless{}{-}} \FunctionTok{barplot}\NormalTok{(y, }\AttributeTok{names.arg =}\NormalTok{ bar.names, }\AttributeTok{ylim =}\NormalTok{ ylim, }\AttributeTok{xlab =}\NormalTok{ xlab,}
                \AttributeTok{ylab =}\NormalTok{ ylab, }\AttributeTok{main =}\NormalTok{ main, }\AttributeTok{col =} \StringTok{"white"}\NormalTok{)}
     
  \FunctionTok{arrows}\NormalTok{(bp, lci, bp, uci, }\AttributeTok{code =} \DecValTok{3}\NormalTok{, }\AttributeTok{angle =} \DecValTok{90}\NormalTok{, }\AttributeTok{length =} \FloatTok{0.1}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

~

Once you have made the changes shown above, check your work, save the file, and quit the editor.

Let's try the \texttt{barplot.ci()} function with the test data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot.ci}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{wt, oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{lci, oed.hp}\SpecialCharTok{$}\NormalTok{uci)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-470-1} \end{center}

\newpage

Try plotting the weight velocities for the marasmic patients receiving the high protein diet using the \texttt{barplot.ci()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot.ci}\NormalTok{(mar.hp}\SpecialCharTok{$}\NormalTok{wt, mar.hp}\SpecialCharTok{$}\NormalTok{day, mar.hp}\SpecialCharTok{$}\NormalTok{lci, mar.hp}\SpecialCharTok{$}\NormalTok{uci)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-471-1} \end{center}

~

The chart looks wrong. This is because we have set the wrong limits for the y axis. The bars are drawn from zero to the data point but we have specified a limit for the y axis that is not constrained to include zero. This is easy to fix. Edit the \texttt{barplot.ci()} function to read:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(y, bar.names, lci, uci,}
         \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(}\DecValTok{0}\NormalTok{, lci), }\FunctionTok{max}\NormalTok{(}\DecValTok{0}\NormalTok{, uci)),}
         \AttributeTok{xlab =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(bar.names)),}
         \AttributeTok{ylab =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(y)),}
         \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(ylab, }\StringTok{"by"}\NormalTok{, xlab)) \{}

\NormalTok{  bp }\OtherTok{\textless{}{-}} \FunctionTok{barplot}\NormalTok{(y, }\AttributeTok{names.arg =}\NormalTok{ bar.names,  }\AttributeTok{ylim =}\NormalTok{ ylim, }\AttributeTok{xlab =}\NormalTok{ xlab,}
                \AttributeTok{ylab =}\NormalTok{ ylab, }\AttributeTok{main =}\NormalTok{ main, }\AttributeTok{col =} \StringTok{"white"}\NormalTok{)}
     
  \FunctionTok{arrows}\NormalTok{(bp, lci, bp, uci, }\AttributeTok{code =} \DecValTok{3}\NormalTok{, }\AttributeTok{angle =} \DecValTok{90}\NormalTok{, }\AttributeTok{length =} \FloatTok{0.1}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

Once you have made the changes shown above, check your work, save the file, and quit the editor.

Try plotting the data for the marasmic patients using the \texttt{barplot.ci()} function:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot.ci}\NormalTok{(mar.hp}\SpecialCharTok{$}\NormalTok{wt, mar.hp}\SpecialCharTok{$}\NormalTok{day, mar.hp}\SpecialCharTok{$}\NormalTok{lci, mar.hp}\SpecialCharTok{$}\NormalTok{uci)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-474-1} \end{center}

~

Check that the function still operates as expected with the data for oedematous patients:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot.ci}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{wt, oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{lci, oed.hp}\SpecialCharTok{$}\NormalTok{uci)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-475-1} \end{center}

~

The end of one of the error bars touches the x axis. This can also be fixed by slightly widening the limits for the y axis. It might also be useful to plot the centre position of each error bar. We can use the \texttt{points()} function to do this. Edit the \texttt{barplot.ci()} function to read:

~

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(y, bar.names, lci, uci,}
         \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(}\DecValTok{0}\NormalTok{, lci), }\FunctionTok{max}\NormalTok{(}\DecValTok{0}\NormalTok{, uci)),}
         \AttributeTok{xlab =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(bar.names)),}
         \AttributeTok{ylab =} \FunctionTok{deparse}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(y)),}
         \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(ylab, }\StringTok{"by"}\NormalTok{, xlab)) \{}
     
\NormalTok{  ylim }\OtherTok{\textless{}{-}}\NormalTok{ ylim }\SpecialCharTok{*} \FloatTok{1.1}
     
\NormalTok{  bp }\OtherTok{\textless{}{-}} \FunctionTok{barplot}\NormalTok{(y, }\AttributeTok{names.arg =}\NormalTok{ bar.names, }\AttributeTok{ylim =}\NormalTok{ ylim, }\AttributeTok{xlab =}\NormalTok{ xlab,}
                \AttributeTok{ylab =}\NormalTok{ ylab, }\AttributeTok{main =}\NormalTok{ main, }\AttributeTok{col =} \StringTok{"white"}\NormalTok{)}
     
  \FunctionTok{arrows}\NormalTok{(bp, lci, bp, uci, }\AttributeTok{code =} \DecValTok{3}\NormalTok{, }\AttributeTok{angle =} \DecValTok{90}\NormalTok{, }\AttributeTok{length =} \FloatTok{0.1}\NormalTok{)}
     
  \FunctionTok{points}\NormalTok{(bp, y)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\newpage

Once you have made the changes shown above, check your work, save the file, and quit the editor.

Check that the function works as expected:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{barplot.ci}\NormalTok{(oed.hp}\SpecialCharTok{$}\NormalTok{wt, oed.hp}\SpecialCharTok{$}\NormalTok{day, oed.hp}\SpecialCharTok{$}\NormalTok{lci, oed.hp}\SpecialCharTok{$}\NormalTok{uci)}
\FunctionTok{barplot.ci}\NormalTok{(mar.hp}\SpecialCharTok{$}\NormalTok{wt, mar.hp}\SpecialCharTok{$}\NormalTok{day, mar.hp}\SpecialCharTok{$}\NormalTok{lci, mar.hp}\SpecialCharTok{$}\NormalTok{uci)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-479-1} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-480-1} \end{center}

\newpage

The \texttt{barplot.ci()} function now works as expected with both sets of data. It is important when developing your own functions, to test them with different data so as to ensure that they work correctly with a wide range if data.

You might like to use the \texttt{save()} function to save the \texttt{barplot.ci()} function.

\hypertarget{mesh-map}{%
\section{Mesh map}\label{mesh-map}}

The fact that \texttt{R} provides flexible graphical functions means that, with little extra work, you can use these functions to present your data in appropriate and interesting ways rather than having to rely on a limited set of basic chart types.

In this exercise we will use the \texttt{plot()} function to produce a simple \emph{mesh-map}.

The file \texttt{cover.dat} contains data from a coverage survey for a therapeutic feeding program (TFP) in central Malawi undertaken in March 2003. Data were collected using the \emph{centric systematic area sampling} method to define sampling locations: A number of communities located closest to the centres of thirty 10 x 10 kilometre grid squares were sampled using active (investigative) case-finding.

The columns in this dataset are as follows:

~

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.10}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.90}}@{}}
\toprule
\endhead
\textbf{x} & x position of grid square \\
\textbf{y} & y position of grid square \\
\textbf{cases} & Number of cases found in sampled communities in.program Number of cases (from above) enrolled in the TFP \\
\bottomrule
\end{longtable}

~

Retrieve the dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cs }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"cover.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\newpage

Examine the dataset:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cs}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x  y cases in.program
## 1  1  7     7          2
## 2  2  5     4          0
## 3  2  6     4          1
## 4  2  7     3          1
## 5  2  8     3          1
## 6  2  9     5          1
## 7  3  3     3          0
## 8  3  4     2          0
## 9  3  5     3          0
## 10 3  6     3          1
## 11 3  7     5          2
## 12 3  8     2          0
## 13 3  9     4          1
## 14 3 10     5          0
## 15 4  4     5          2
## 16 4  5     8          1
## 17 4  6     6          0
## 18 4  7     6          1
## 19 4  8     3          1
## 20 4  9     5          1
## 21 4 10     6          2
## 22 5  4     5          1
## 23 5  5     3          1
## 24 5  6     4          0
## 25 5  7     6          3
## 26 5  8     4          0
## 27 6  3     8          2
## 28 6  4     5          2
## 29 6  6     6          1
## 30 6  7     3          1
\end{verbatim}

\newpage

We should calculate the observed coverage for each grid square:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cs}\SpecialCharTok{$}\NormalTok{cvr }\OtherTok{\textless{}{-}}\NormalTok{ cs}\SpecialCharTok{$}\NormalTok{in.program }\SpecialCharTok{/}\NormalTok{ cs}\SpecialCharTok{$}\NormalTok{cases}
\NormalTok{cs}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x  y cases in.program       cvr
## 1  1  7     7          2 0.2857143
## 2  2  5     4          0 0.0000000
## 3  2  6     4          1 0.2500000
## 4  2  7     3          1 0.3333333
## 5  2  8     3          1 0.3333333
## 6  2  9     5          1 0.2000000
## 7  3  3     3          0 0.0000000
## 8  3  4     2          0 0.0000000
## 9  3  5     3          0 0.0000000
## 10 3  6     3          1 0.3333333
## 11 3  7     5          2 0.4000000
## 12 3  8     2          0 0.0000000
## 13 3  9     4          1 0.2500000
## 14 3 10     5          0 0.0000000
## 15 4  4     5          2 0.4000000
## 16 4  5     8          1 0.1250000
## 17 4  6     6          0 0.0000000
## 18 4  7     6          1 0.1666667
## 19 4  8     3          1 0.3333333
## 20 4  9     5          1 0.2000000
## 21 4 10     6          2 0.3333333
## 22 5  4     5          1 0.2000000
## 23 5  5     3          1 0.3333333
## 24 5  6     4          0 0.0000000
## 25 5  7     6          3 0.5000000
## 26 5  8     4          0 0.0000000
## 27 6  3     8          2 0.2500000
## 28 6  4     5          2 0.4000000
## 29 6  6     6          1 0.1666667
## 30 6  7     3          1 0.3333333
\end{verbatim}

\newpage

Note that some grid squares have zero coverage. It might be useful to use specific plotting characters (e.g.~open and filled squares) to indicate zero and non-zero coverage. We can use the \texttt{ifelse()} function to do this:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cs}\SpecialCharTok{$}\NormalTok{cvr.pch }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(cs}\SpecialCharTok{$}\NormalTok{cvr }\SpecialCharTok{==} \DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{15}\NormalTok{)}
\NormalTok{cs}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x  y cases in.program       cvr cvr.pch
## 1  1  7     7          2 0.2857143      15
## 2  2  5     4          0 0.0000000       0
## 3  2  6     4          1 0.2500000      15
## 4  2  7     3          1 0.3333333      15
## 5  2  8     3          1 0.3333333      15
## 6  2  9     5          1 0.2000000      15
## 7  3  3     3          0 0.0000000       0
## 8  3  4     2          0 0.0000000       0
## 9  3  5     3          0 0.0000000       0
## 10 3  6     3          1 0.3333333      15
## 11 3  7     5          2 0.4000000      15
## 12 3  8     2          0 0.0000000       0
## 13 3  9     4          1 0.2500000      15
## 14 3 10     5          0 0.0000000       0
## 15 4  4     5          2 0.4000000      15
## 16 4  5     8          1 0.1250000      15
## 17 4  6     6          0 0.0000000       0
## 18 4  7     6          1 0.1666667      15
## 19 4  8     3          1 0.3333333      15
## 20 4  9     5          1 0.2000000      15
## 21 4 10     6          2 0.3333333      15
## 22 5  4     5          1 0.2000000      15
## 23 5  5     3          1 0.3333333      15
## 24 5  6     4          0 0.0000000       0
## 25 5  7     6          3 0.5000000      15
## 26 5  8     4          0 0.0000000       0
## 27 6  3     8          2 0.2500000      15
## 28 6  4     5          2 0.4000000      15
## 29 6  6     6          1 0.1666667      15
## 30 6  7     3          1 0.3333333      15
\end{verbatim}

\newpage

A quick way of seeing the code associated with each plotting symbol is:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\DecValTok{0}\SpecialCharTok{:}\DecValTok{25}\NormalTok{, }\DecValTok{0}\SpecialCharTok{:}\DecValTok{25}\NormalTok{, }\AttributeTok{pch =} \DecValTok{0}\SpecialCharTok{:}\DecValTok{25}\NormalTok{, }\AttributeTok{cex =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-485-1} \end{center}

~

The size of the plotting symbol may be used to indicate the level of coverage in each quadrat but we must
ensure that the symbol used for zero-coverage is not invisibly small:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cs}\SpecialCharTok{$}\NormalTok{cvr.cex }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(cs}\SpecialCharTok{$}\NormalTok{cvr }\SpecialCharTok{==} \DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{10} \SpecialCharTok{*}\NormalTok{ cs}\SpecialCharTok{$}\NormalTok{cvr)}
\NormalTok{cs}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    x  y cases in.program       cvr cvr.pch  cvr.cex
## 1  1  7     7          2 0.2857143      15 2.857143
## 2  2  5     4          0 0.0000000       0 1.000000
## 3  2  6     4          1 0.2500000      15 2.500000
## 4  2  7     3          1 0.3333333      15 3.333333
## 5  2  8     3          1 0.3333333      15 3.333333
## 6  2  9     5          1 0.2000000      15 2.000000
## 7  3  3     3          0 0.0000000       0 1.000000
## 8  3  4     2          0 0.0000000       0 1.000000
## 9  3  5     3          0 0.0000000       0 1.000000
## 10 3  6     3          1 0.3333333      15 3.333333
## 11 3  7     5          2 0.4000000      15 4.000000
## 12 3  8     2          0 0.0000000       0 1.000000
## 13 3  9     4          1 0.2500000      15 2.500000
## 14 3 10     5          0 0.0000000       0 1.000000
## 15 4  4     5          2 0.4000000      15 4.000000
## 16 4  5     8          1 0.1250000      15 1.250000
## 17 4  6     6          0 0.0000000       0 1.000000
## 18 4  7     6          1 0.1666667      15 1.666667
## 19 4  8     3          1 0.3333333      15 3.333333
## 20 4  9     5          1 0.2000000      15 2.000000
## 21 4 10     6          2 0.3333333      15 3.333333
## 22 5  4     5          1 0.2000000      15 2.000000
## 23 5  5     3          1 0.3333333      15 3.333333
## 24 5  6     4          0 0.0000000       0 1.000000
## 25 5  7     6          3 0.5000000      15 5.000000
## 26 5  8     4          0 0.0000000       0 1.000000
## 27 6  3     8          2 0.2500000      15 2.500000
## 28 6  4     5          2 0.4000000      15 4.000000
## 29 6  6     6          1 0.1666667      15 1.666667
## 30 6  7     3          1 0.3333333      15 3.333333
\end{verbatim}

~

We can now plot the data:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{pty=}\StringTok{"s"}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(cs}\SpecialCharTok{$}\NormalTok{x, cs}\SpecialCharTok{$}\NormalTok{y, }\AttributeTok{cex =}\NormalTok{ cs}\SpecialCharTok{$}\NormalTok{cvr.cex, }\AttributeTok{pch =}\NormalTok{ cs}\SpecialCharTok{$}\NormalTok{cvr.pch)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-487-1} \end{center}

~

There are some problems with this plot:

\begin{itemize}
\item
  The axes and labels distract from the data.
\item
  The distance between grid-square centres is wider in the \emph{x} than in the \emph{y} direction.
\item
  The colour (black) of the plotting symbols is too strong.
\end{itemize}

All of these problems can be fixed by specifying values for \texttt{plot()} function parameters:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(cs}\SpecialCharTok{$}\NormalTok{x, cs}\SpecialCharTok{$}\NormalTok{y,}
     \AttributeTok{cex =}\NormalTok{ cs}\SpecialCharTok{$}\NormalTok{cvr.cex,}
     \AttributeTok{pch =}\NormalTok{ cs}\SpecialCharTok{$}\NormalTok{cvr.pch,}
     \AttributeTok{xlab =} \StringTok{""}\NormalTok{,}
     \AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
     \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
     \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{10}\NormalTok{),}
     \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{10}\NormalTok{),}
     \AttributeTok{col =} \FunctionTok{gray}\NormalTok{(}\FloatTok{0.5}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-488-1} \end{center}

~

An alternative way of plotting this data is to use shades of grey (rather than the size of the plotting symbol) to represent the level of coverage in each grid-square:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(cs}\SpecialCharTok{$}\NormalTok{x, cs}\SpecialCharTok{$}\NormalTok{y,}
     \AttributeTok{cex =} \DecValTok{5}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{""}\NormalTok{,}
     \AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
     \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
     \AttributeTok{pch =} \DecValTok{15}\NormalTok{,}
     \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{),}
     \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{),}
     \AttributeTok{col =} \FunctionTok{gray}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ cs}\SpecialCharTok{$}\NormalTok{cvr))}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-489-1} \end{center}

~

In this context it is useful to show the approximate location of therapeutic feeding centres:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(cs}\SpecialCharTok{$}\NormalTok{x, cs}\SpecialCharTok{$}\NormalTok{y,}
     \AttributeTok{cex =}\NormalTok{ cs}\SpecialCharTok{$}\NormalTok{cvr.cex,}
     \AttributeTok{pch =}\NormalTok{ cs}\SpecialCharTok{$}\NormalTok{cvr.pch,}
     \AttributeTok{xlab =} \StringTok{""}\NormalTok{,}
     \AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
     \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
     \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{10}\NormalTok{),}
     \AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{10}\NormalTok{),}
     \AttributeTok{col =} \FunctionTok{gray}\NormalTok{(}\FloatTok{0.5}\NormalTok{))}

\FunctionTok{points}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{2.5}\NormalTok{, }\FloatTok{4.5}\NormalTok{, }\FloatTok{5.5}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\FloatTok{6.5}\NormalTok{, }\FloatTok{8.25}\NormalTok{, }\DecValTok{5}\NormalTok{), }\AttributeTok{pch =} \DecValTok{19}\NormalTok{, }\AttributeTok{cex =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-490-1} \end{center}

~

The techniques introduced in this section allow you to write custom graphical functions but they can also be used to change the default behaviour of standard graphical functions.

\hypertarget{combining-plots}{%
\section{Combining plots}\label{combining-plots}}

In \protect\hyperlink{exercise1}{\textbf{\emph{Exercise 1 Getting acquainted with R}}}, we saw how the \texttt{plot()} function could be applied to a fitted object:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"fem.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{attach}\NormalTok{(fem)}
\NormalTok{fem.lm }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ AGE)}
\FunctionTok{plot}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"fem.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{attach}\NormalTok{(fem)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## The following objects are masked from fem (pos = 4):
## 
##     AGE, ANX, DEP, ID, IQ, LIFE, SEX, SLP, WT
\end{verbatim}

\begin{verbatim}
## The following objects are masked from fem (pos = 5):
## 
##     AGE, ANX, DEP, ID, IQ, LIFE, SEX, SLP, WT
\end{verbatim}

\begin{verbatim}
## The following objects are masked from fem (pos = 10):
## 
##     AGE, ANX, DEP, ID, IQ, LIFE, SEX, SLP, WT
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fem.lm }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(WT }\SpecialCharTok{\textasciitilde{}}\NormalTok{ AGE)}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-493-1} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-493-2} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-493-3} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-493-4} \end{center}

~

Each of the diagnostic plots are presented as a separate chart. We could use the \texttt{mfrow} parameter of the \texttt{par()} function to present all four diagnostic plots on a single chart:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{plot}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-494-1} \end{center}

~

It might improve the appearance of the chart if each of the diagnostic plots were square rather than rectangular:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{par}\NormalTok{(}\AttributeTok{pty =} \StringTok{"s"}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-496-1} \end{center}

~

It might improve the appearance of the chart if smaller text and symbols were used:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\FunctionTok{par}\NormalTok{(}\AttributeTok{pty =} \StringTok{"s"}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{cex =} \FloatTok{0.5}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-498-1} \end{center}

~

Graphical parameters set using the \texttt{par()} function affect all subsequent plot commands and must be reset explicitly:

~

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{pty =} \StringTok{"m"}\NormalTok{, }\AttributeTok{cex =} \DecValTok{1}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-500-1} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-500-2} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-500-3} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-500-4} \end{center}

\newpage

It is possible to save graphical parameters into an \texttt{R} object and use this object to restore original graphical parameters:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{old.par }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{()}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{pty =} \StringTok{"s"}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(fem.lm)}
\FunctionTok{par}\NormalTok{(old.par)}
\FunctionTok{plot}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-502-1} \end{center}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-503-1} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-503-2} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-503-3} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-503-4} \end{center}

\newpage

The ability to save and apply graphical parameters means that you can create a library of graphical parameter sets that can be applied with the \texttt{par()} function as required:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{default.par }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{()}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{pty =} \StringTok{"s"}\NormalTok{)}
\NormalTok{plot.lm.par }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{()}
\FunctionTok{par}\NormalTok{(default.par)}
\FunctionTok{plot}\NormalTok{(fem.lm)}
\FunctionTok{par}\NormalTok{(plot.lm.par)}
\FunctionTok{plot}\NormalTok{(fem.lm)}
\FunctionTok{par}\NormalTok{(default.par)}
\FunctionTok{plot}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-505-1} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-505-2} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-505-3} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-505-4} \end{center}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-506-1} \end{center}

\newpage

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-507-1} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-507-2} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-507-3} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-507-4} \end{center}

~

\texttt{R} produces warning messages when you save and restore graphical parameters in this way. This is because some graphical parameters are read only and cannot be changed using the \texttt{par()} function. This has no effect other than to cause \texttt{R} to issue warning messages.

If you do not like the warning messages then you can use the \texttt{par()} function with the \texttt{no.readonly} parameter set to \texttt{TRUE}:

~

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{default.par }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{no.readonly =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{pty =} \StringTok{"s"}\NormalTok{)}
\NormalTok{plot.lm.par }\OtherTok{\textless{}{-}} \FunctionTok{par}\NormalTok{(}\AttributeTok{no.readonly =} \ConstantTok{TRUE}\NormalTok{)}
\FunctionTok{par}\NormalTok{(default.par)}
\FunctionTok{plot}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-508-1} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-508-2} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-508-3} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-508-4} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(plot.lm.par)}
\FunctionTok{plot}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-508-5} \end{center}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{par}\NormalTok{(default.par)}
\FunctionTok{plot}\NormalTok{(fem.lm)}
\end{Highlighting}
\end{Shaded}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-508-6} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-508-7} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-508-8} \end{center}

\begin{center}\includegraphics{prfe_files/figure-latex/unnamed-chunk-508-9} \end{center}

~

Graphical parameter sets, like any other \texttt{R} object, may be saved and loaded using the \texttt{save()} and \texttt{load()} functions.

\hypertarget{summary-7}{%
\section{Summary}\label{summary-7}}

\begin{itemize}
\item
  \texttt{R} allows you to create functions that produce graphical output.
\item
  \texttt{R} graphical functions are flexible so that you can create functions that can produce chart types that are not available in \texttt{R} or many other statistical applications. Standard plots may also be customised using the \texttt{par()} function.
\item
  \texttt{R} allows you to specify default values for function parameters making functions calls easier by removing the requirement to specify values for every function parameter.
\end{itemize}

\hypertarget{exercise9}{%
\chapter{Computer intensive methods}\label{exercise9}}

\hypertarget{estimation}{%
\section{Estimation}\label{estimation}}

Estimation involves the calculation of a measure with some sense of precision based upon sampling variation.

Only a few estimators (e.g.~the sample mean from a normal population) have exact formulae that may be used to estimate sampling variation. Typically, estimates of variability are based upon approximations informed by expected or postulated properties of the sampled population. The development of variance formulae for some measures may require in-depth statistical and mathematical knowledge or may even be impossible to derive.

\emph{Bootstrap} methods are computer-intensive methods that can provide estimates and measures of precision (e.g.~confidence intervals) without resort to theoretical models, higher mathematics, or assumptions about the sampled population. They rely on repeated sampling, sometimes called \emph{resampling}, of the observed data.

As a simple example of how such methods work, we will start by using bootstrap methods to estimate the mean from a normal population. We will work with a very simple dataset which we will enter directly:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{7.3}\NormalTok{, }\FloatTok{10.4}\NormalTok{, }\FloatTok{14.0}\NormalTok{, }\FloatTok{12.2}\NormalTok{, }\FloatTok{8.4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

We can summarise this data quite easily:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mean}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 10.46
\end{verbatim}

The \texttt{sample()} function can be used to select a bootstrap \texttt{replicate}:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sample}\NormalTok{(x, }\FunctionTok{length}\NormalTok{(x), }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 12.2  7.3  8.4 12.2 10.4
\end{verbatim}

Enter this command several times to see some more bootstrap replicates. Remember that previous commands can be recalled and edited using the up and down arrow keys -- they do not need to be typed out in full each time. The \texttt{length()} parameter is not required for taking bootstrap replicates and can be omitted.

It is possible to apply a summary measure to a replicate:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mean}\NormalTok{(}\FunctionTok{sample}\NormalTok{(x, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 10.06
\end{verbatim}

Enter this command several times. A bootstrap estimate of the mean of \texttt{x} can be made by repeating this process many times and taking the \texttt{median} of the means for each replicate.

One way of doing this is to create a matrix where each column contains a bootstrap replicate and then use the \texttt{apply()} and \texttt{mean()} functions to get at the estimate.

First create the matrix of replicates. Here we take ten replicates:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x1 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{sample}\NormalTok{(x, }\FunctionTok{length}\NormalTok{(x) }\SpecialCharTok{*} \DecValTok{10}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{),}
             \AttributeTok{nrow =} \FunctionTok{length}\NormalTok{(x), }\AttributeTok{ncol =} \DecValTok{10}\NormalTok{)}
\NormalTok{x1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
## [1,]  7.3  8.4 14.0 10.4 10.4  8.4 12.2 10.4 10.4  14.0
## [2,]  8.4 12.2 14.0 14.0 10.4 12.2 12.2 14.0  7.3  12.2
## [3,] 14.0  8.4  7.3 14.0 10.4  8.4  8.4  8.4  8.4   7.3
## [4,]  8.4 14.0  8.4  8.4 10.4 12.2  7.3 14.0 10.4  10.4
## [5,] 10.4 14.0  8.4 14.0 10.4  8.4  7.3 14.0  7.3   8.4
\end{verbatim}

Then calculate and store the means of each replicate. We can do this using the \texttt{apply()} function to apply the \texttt{mean()} function to the columns of matrix \texttt{x1}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x2 }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(x1, }\DecValTok{2}\NormalTok{, mean)}
\NormalTok{x2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  9.70 11.40 10.42 12.16 10.40  9.92  9.48 12.16  8.76 10.46
\end{verbatim}

The bootstrap estimate of the mean is:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{median}\NormalTok{(x2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 10.41
\end{verbatim}

The bootstrap estimate may differ somewhat from the mean of \texttt{x}:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mean}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 10.46
\end{verbatim}

The situation is improved by increasing the number of replicates. Here we take 5000 replicates:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x1 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{sample}\NormalTok{(x, }\FunctionTok{length}\NormalTok{(x) }\SpecialCharTok{*} \DecValTok{5000}\NormalTok{, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{),}
             \AttributeTok{nrow =} \FunctionTok{length}\NormalTok{(x), }\AttributeTok{ncol =} \DecValTok{5000}\NormalTok{)}
\NormalTok{x2 }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(x1, }\DecValTok{2}\NormalTok{, mean)}
\FunctionTok{median}\NormalTok{(x2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 10.46
\end{verbatim}

This is a pretty useless example as estimating the mean / standard deviation, or standard error of the mean of a sample from a normal population can be done using standard formulae.

The utility of bootstrap methods is that they can be applied to summary measures that are not as well understood as the arithmetic mean. The bootstrap method also has the advantage of retaining simplicity even with complicated measures.

To illustrate this, we will work through an example of using the bootstrap to estimate the harmonic mean.

Again, we will work with a simple dataset which we will enter directly:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FloatTok{43.64}\NormalTok{, }\FloatTok{50.67}\NormalTok{, }\FloatTok{33.56}\NormalTok{, }\FloatTok{27.75}\NormalTok{, }\FloatTok{43.35}\NormalTok{, }\FloatTok{29.56}\NormalTok{, }\FloatTok{38.83}\NormalTok{, }\FloatTok{35.95}\NormalTok{, }\FloatTok{20.01}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The data represents distance (in kilometres) from a point source of environmental pollution for nine female patients with oral / pharyngeal cancer.

The harmonic mean is considered to be a sensitive measure of spatial clustering. The first step is to construct a function to calculate the harmonic mean:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{h.mean }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}\FunctionTok{length}\NormalTok{(x) }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(}\DecValTok{1} \SpecialCharTok{/}\NormalTok{ x)\}}
\end{Highlighting}
\end{Shaded}

Calling this function with the sample data:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{h.mean}\NormalTok{(d)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 33.46646
\end{verbatim}

Should return an estimated harmonic mean distance of 33.47 kilometres. This is simple. The problem is that calculating the variance of this estimate is complicated using standard methods. This problem is relatively simple to solve using bootstrap methods:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{replicates }\OtherTok{\textless{}{-}} \DecValTok{5000}
\NormalTok{n }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(d)}
\NormalTok{x1 }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{sample}\NormalTok{(d, n }\SpecialCharTok{*}\NormalTok{ replicates, }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{),}
             \AttributeTok{nrow =}\NormalTok{ n, }\AttributeTok{ncol =}\NormalTok{ replicates)}
\NormalTok{x2 }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(x1, }\DecValTok{2}\NormalTok{, h.mean)}
\FunctionTok{median}\NormalTok{(x2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 33.63505
\end{verbatim}

A 95\% confidence interval can be extracted from \texttt{x2} using the \texttt{quantile()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{quantile}\NormalTok{(x2, }\FunctionTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     2.5%    97.5% 
## 27.60724 40.27910
\end{verbatim}

A 99\% confidence interval can also be extracted from \texttt{x2} using the \texttt{quantile()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{quantile}\NormalTok{(x2, }\FunctionTok{c}\NormalTok{(}\FloatTok{0.005}\NormalTok{, }\FloatTok{0.995}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     0.5%    99.5% 
## 26.11928 42.40356
\end{verbatim}

As a final example of the bootstrap method we will use the method to obtain an estimate of an odds ratio from a two-by-two table. We will work with the \texttt{salex} dataset which we used in exercise 2 and exercise 3:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{salex }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"salex.dat"}\NormalTok{,  }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{na.strings =} \StringTok{"9"}\NormalTok{)}
\FunctionTok{table}\NormalTok{(salex}\SpecialCharTok{$}\NormalTok{EGGS, salex}\SpecialCharTok{$}\NormalTok{ILL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    
##      1  2
##   1 40  6
##   2 10 20
\end{verbatim}

We should set up our estimator function to calculate an odds ratio from a two-by-two table:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{or }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{(x[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{] }\SpecialCharTok{/}\NormalTok{ x[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{]) }\SpecialCharTok{/}\NormalTok{ (x[}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{] }\SpecialCharTok{/}\NormalTok{ x[}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{])\}}
\end{Highlighting}
\end{Shaded}

We should test this:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{or}\NormalTok{(}\FunctionTok{table}\NormalTok{(salex}\SpecialCharTok{$}\NormalTok{EGGS, salex}\SpecialCharTok{$}\NormalTok{ILL))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 13.33333
\end{verbatim}

The problem is to take a bootstrap replicate from two vectors in a data.frame. This can be achieved by using \texttt{sample()} to create a vector of row indices and then use this sample of indices to select replicates from the data.frame:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{boot }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{1000}\NormalTok{) \{}
\NormalTok{  sampled.rows }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(salex), }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  x }\OtherTok{\textless{}{-}}\NormalTok{ salex[sampled.rows, }\StringTok{"EGGS"}\NormalTok{]}
\NormalTok{  y }\OtherTok{\textless{}{-}}\NormalTok{ salex[sampled.rows, }\StringTok{"ILL"}\NormalTok{]}
\NormalTok{  boot[i] }\OtherTok{\textless{}{-}} \FunctionTok{or}\NormalTok{(}\FunctionTok{table}\NormalTok{(x, y))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

The vector \texttt{boot} now contains the odds ratios calculated from 1000 replicates. Estimates of the odds ratio and its 95\% confidence interval may be obtained using the \texttt{median()} and \texttt{quantile()} functions

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{median}\NormalTok{(boot)}
\FunctionTok{quantile}\NormalTok{(boot, }\FunctionTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 13.71429
\end{verbatim}

\begin{verbatim}
##      2.5%     97.5% 
##  4.605714 66.159375
\end{verbatim}

This approach may fail when some tables have cells that contain zero. Infinite values arise due to division by zero when calculating the odds ratio for some replicates. We can avoid this problem by selecting only those values of \texttt{boot} that are not (\texttt{!=}) infinite (\texttt{Inf}):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{boot }\OtherTok{\textless{}{-}}\NormalTok{ boot[boot }\SpecialCharTok{!=} \ConstantTok{Inf}\NormalTok{]}
\FunctionTok{median}\NormalTok{(boot)}
\FunctionTok{quantile}\NormalTok{(boot, }\FunctionTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 13.71429
\end{verbatim}

\begin{verbatim}
##      2.5%     97.5% 
##  4.604286 65.650000
\end{verbatim}

Another way to avoid this problem is to use an \texttt{adjusted\ odds\ ratio} calculated by adding 0.5 to each cell of the two-by-two table:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{boot }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{1000}\NormalTok{) \{}
\NormalTok{  sampled.rows }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(salex), }\AttributeTok{replace =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  x }\OtherTok{\textless{}{-}}\NormalTok{ salex[sampled.rows, }\StringTok{"EGGS"}\NormalTok{]}
\NormalTok{  y }\OtherTok{\textless{}{-}}\NormalTok{ salex[sampled.rows, }\StringTok{"ILL"}\NormalTok{]}
\NormalTok{  boot[i] }\OtherTok{\textless{}{-}} \FunctionTok{or}\NormalTok{(}\FunctionTok{table}\NormalTok{(x, y) }\SpecialCharTok{+} \FloatTok{0.5}\NormalTok{)}
\NormalTok{  \}}
\FunctionTok{median}\NormalTok{(boot)}
\FunctionTok{quantile}\NormalTok{(boot, }\FunctionTok{c}\NormalTok{(}\FloatTok{0.025}\NormalTok{, }\FloatTok{0.975}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 13.27866
\end{verbatim}

\begin{verbatim}
##      2.5%     97.5% 
##  4.635572 50.152157
\end{verbatim}

This procedure is preferred when working with sparse tables.

\hypertarget{hypothesis-testing}{%
\section{Hypothesis testing}\label{hypothesis-testing}}

Computer-intensive methods also offer a general approach to statistical hypothesis testing. To illustrate this we will use \emph{computer based simulation} to investigate spatial clustering around a point.

Before continuing, we will retrieve a dataset:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{waste }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"waste.dat"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The file \texttt{waste.dat} contains the location of twenty-three recent cases of childhood cancer in 5 by 5 km square surrounding an industrial waste disposal site. The columns in the dataset are:

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.15}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.43}}@{}}
\toprule
\endhead
\textbf{x} & The x location of cases \\
\textbf{y} & The y location of cases \\
\bottomrule
\end{longtable}

The \texttt{x} and \texttt{y} variables have been transformed to lie between 0 and 1 with the industrial waste disposal site centrally located (i.e.~at \texttt{x} = 0.5, \texttt{y} = 0.5).

Plot the data and the location of the industrial waste disposal site on the same chart:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(waste}\SpecialCharTok{$}\NormalTok{x, waste}\SpecialCharTok{$}\NormalTok{y, }\AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\FunctionTok{points}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\AttributeTok{pch =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-535-1.pdf}

We can calculate the distance of each point from the industrial waste disposal site using Pythagoras' Theorem:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{distance.obs }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{((waste}\SpecialCharTok{$}\NormalTok{x }\SpecialCharTok{{-}} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{\^{}} \DecValTok{2} \SpecialCharTok{+}\NormalTok{ (waste}\SpecialCharTok{$}\NormalTok{y }\SpecialCharTok{{-}} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{\^{}} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The observed mean distance or each case from the industrial waste disposal site is:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mean}\NormalTok{(distance.obs)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.3444118
\end{verbatim}

To test whether this distance is unlikely to have arisen by chance (i.e.~evidence of spatial clustering) we need to simulate the distribution of distances when no spatial pattern exists:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{r }\OtherTok{\textless{}{-}} \DecValTok{10000}
\NormalTok{x.sim }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{runif}\NormalTok{(r }\SpecialCharTok{*} \DecValTok{23}\NormalTok{), }\DecValTok{23}\NormalTok{, r)}
\NormalTok{y.sim }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{runif}\NormalTok{(r }\SpecialCharTok{*} \DecValTok{23}\NormalTok{), }\DecValTok{23}\NormalTok{, r)}
\NormalTok{distance.run }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{((x.sim }\SpecialCharTok{{-}} \FloatTok{0.5}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ (y.sim }\SpecialCharTok{{-}} \FloatTok{0.5}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{distance.sim }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(distance.run, }\DecValTok{2}\NormalTok{, mean)}
\FunctionTok{hist}\NormalTok{(distance.sim, }\AttributeTok{breaks =} \DecValTok{20}\NormalTok{)}
\FunctionTok{abline}\NormalTok{(}\AttributeTok{v =} \FunctionTok{mean}\NormalTok{(distance.obs), }\AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-538-1.pdf}

The probability (i.e.~the \emph{p-value}) of observing a mean distance smaller than the \emph{observed mean} distance under the null hypothesis can be estimated as the number of estimates of the mean distance under the null hypothesis falling below the observed mean divided by the total number of estimates of the mean distance under the null hypothesis:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(distance.obs)}
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(distance.sim }\SpecialCharTok{\textless{}}\NormalTok{ m, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\FunctionTok{sum}\NormalTok{(z) }\SpecialCharTok{/}\NormalTok{ r}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.0989
\end{verbatim}

You might like to repeat this exercise using the harmonic mean distance and the median distance.

We can check if this method is capable of detecting a simple cluster using simulated data:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{23}\NormalTok{, }\AttributeTok{mean =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{sd =} \FloatTok{0.2}\NormalTok{)}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{23}\NormalTok{, }\AttributeTok{mean =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{sd =} \FloatTok{0.2}\NormalTok{)}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\FunctionTok{points}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\AttributeTok{pch =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-540-1.pdf}

We need to recalculate the distance of each simulated case from the industrial waste disposal site:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{distance.obs }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{((x }\SpecialCharTok{{-}} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{\^{}} \DecValTok{2} \SpecialCharTok{+}\NormalTok{ (y }\SpecialCharTok{{-}} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{\^{}} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The observed mean distance of each case from the industrial waste disposal site is:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mean}\NormalTok{(distance.obs)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.2216747
\end{verbatim}

We can use the the simulated null hypothesis data to test for spatial clustering:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(distance.obs)}
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(distance.sim }\SpecialCharTok{\textless{}}\NormalTok{ m, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\FunctionTok{sum}\NormalTok{(z) }\SpecialCharTok{/}\NormalTok{ r}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0
\end{verbatim}

We should also check if the procedure can detect a plume of cases, such as might be created by a prevailing wind at a waste incineration site, in a similar way:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{23}\NormalTok{, }\FloatTok{0.25}\NormalTok{, }\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+} \FloatTok{0.5}
\NormalTok{y }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{23}\NormalTok{, }\FloatTok{0.25}\NormalTok{, }\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+} \FloatTok{0.5}
\FunctionTok{plot}\NormalTok{(x, y, }\AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\FunctionTok{points}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\AttributeTok{pch =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-544-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{distance.obs }\OtherTok{\textless{}{-}} \FunctionTok{sqrt}\NormalTok{((x }\SpecialCharTok{{-}} \FloatTok{0.5}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2} \SpecialCharTok{+}\NormalTok{ (y }\SpecialCharTok{{-}} \FloatTok{0.5}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}\NormalTok{)}
\NormalTok{m }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(distance.obs)}
\NormalTok{z }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(distance.sim }\SpecialCharTok{\textless{}}\NormalTok{ m, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\FunctionTok{sum}\NormalTok{(z) }\SpecialCharTok{/}\NormalTok{ r}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.4019
\end{verbatim}

The method is not capable of detecting plumes.

You might like to try adapting the simulation code presented here to provide a method capable of detecting plumes of cases.

\hypertarget{simulating-processes}{%
\section{Simulating processes}\label{simulating-processes}}

In the previous example we simulated the expected distribution of data under the \emph{null hypothesis}. Computer based simulations are not limited to simulating data. They can also be used to simulate processes.

In this example we will simulate the behaviour of the \emph{lot quality assurance sampling} (LQAS) survey method when sampling constraints lead to a loss of sampling independence. In this example the sampling process is simulated and applied to real-world data.

LQAS is a small-sample classification technique that is widely used in manufacturing industry to judge the quality of a batch of manufactured items. In this context, LQAS is used to identify batches that are likely to contain an unacceptably large number of defective items. In the public health context, LQAS may be used to identify communities with unacceptably low levels of service (e.g.~vaccine) coverage or worrying levels of disease prevalence.

The LQAS method produces data that is easy to analyse. Data analysis is performed as data is collected and consists solely of counting the number of \emph{defects} (e.g.~children with a specific disease) in the sample and checking whether a predetermined threshold value has been exceeded. This combination of data collection and data analysis is called a \emph{sampling plan}. LQAS sampling plans are developed by specifying:

\begin{itemize}
\item
  \textbf{A TRIAGE SYSTEM}: A classification system that defines \emph{high}, \emph{moderate}, and \emph{low} categories of the prevalence of the phenomenon of interest.
\item
  \textbf{ACCEPTABLE PROBABILITIES OF ERROR}: There are two probabilities of error. These are termed provider \emph{probability of error} (PPE) and \emph{consumer probability of error} (CPE):

  \begin{itemize}
  \item
    \textbf{Provider Probability of Error (PPE)}: The risk that the survey will indicate that prevalence is \emph{high} when it is, in fact, \emph{low}. PPE is analogous to \emph{type I} (\(\alpha\)) error in statistical hypothesis testing.
  \item
    \textbf{Consumer Probability of Error (CPE)}: The risk that the survey will indicate that prevalence is \emph{low} when it is, in fact, \emph{high}. CPE is analogous to \emph{type II} (\(\beta\)) error in statistical hypothesis testing.
  \end{itemize}
\end{itemize}

Once the upper and lower levels of the triage system and acceptable levels of error have been decided, a set of probability tables are constructed that are used to select a maximum sample size (\texttt{n}) and the number of defects or cases (\texttt{d}) that are allowed in the sample of \texttt{n} subjects before deciding that a population is a high prevalence population. The combination of maximum sample size (\texttt{n}) and number of defects (\texttt{d}) form the stopping rules of the sampling plan. Sampling stops when either the maximum sample size (\texttt{n}) is met or the allowable number of defects (\texttt{d}) is exceeded:

\begin{itemize}
\item
  If \texttt{d} is exceeded then the population is classified as high prevalence.
\item
  If \texttt{n} is met without d being exceeded then the population is classified as low prevalence.
\end{itemize}

The values of \texttt{n} and \texttt{d} used in a sampling plan depend upon the threshold values used in the triage system and the acceptable levels of error. The values of \texttt{n} and \texttt{d} used in a sampling plan are calculated using binomial probabilities. For example, the probabilities of finding 14 or fewer cases (\(d = 14\)) in a sample of 50 individuals (\(n = 50\)) from populations with prevalences of either 20\% or 40\% are:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{pbinom}\NormalTok{(}\AttributeTok{q =} \DecValTok{14}\NormalTok{, }\AttributeTok{size =} \DecValTok{50}\NormalTok{, }\AttributeTok{prob =} \FloatTok{0.2}\NormalTok{)}
\FunctionTok{pbinom}\NormalTok{(}\AttributeTok{q =} \DecValTok{14}\NormalTok{, }\AttributeTok{size =} \DecValTok{50}\NormalTok{, }\AttributeTok{prob =} \FloatTok{0.4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.9392779
\end{verbatim}

\begin{verbatim}
## [1] 0.05395503
\end{verbatim}

The sampling plan with \(n = 50\) and \(d = 14\) is, therefore, a reasonable candidate for a sampling plan intended to distinguish between populations with prevalences of less than or equal to 20\% and populations with prevalences greater than or equal to 40\%.

There is no middle ground with LQAS sampling plans. Population are always classified as either high or low prevalence. Populations with prevalences between the upper and lower standards of the triage system are classified as high or low prevalence populations. The probability of a moderate prevalence population being classified as high or low prevalence is proportional to the proximity of the prevalence in that population to the triage standards. Moderate prevalence populations close to the upper standard will tend to be classified as high prevalence populations. Moderate prevalence populations close to the lower standard will tend to be classified as low prevalence populations. This behaviour is summarised by the operating characteristic (OC) curve for the sampling plan. For example:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{plot}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.01}\NormalTok{),}
     \FunctionTok{pbinom}\NormalTok{(}\DecValTok{14}\NormalTok{, }\DecValTok{50}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.01}\NormalTok{), }\AttributeTok{lower.tail =} \ConstantTok{FALSE}\NormalTok{),}
     \AttributeTok{main =} \StringTok{"OC Curve for n = 50, d = 14"}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{"Proportion diseased"}\NormalTok{,}
     \AttributeTok{ylab =} \StringTok{"Probability"}\NormalTok{,}
     \AttributeTok{type =} \StringTok{"l"}\NormalTok{, }\AttributeTok{lty =} \DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-547-1.pdf}

The data we will use for the simulation is stored in forty-eight separate files. These files contain the returns from whole community screens for active trachoma (TF/TI) in children undertaken as part of trachoma control activities in five African countries. Each file has the file suffix .sim. The name of the file reflects the country in which the data were collected. The data files are:

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.29}}
  >{\raggedleft\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.17}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.29}}@{}}
\toprule
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{File name}
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedleft
\textbf{Files}
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
\textbf{Origin}
\end{minipage} \\
\midrule
\endhead
\textbf{egyptXX.sim} & 10 & Egypt \\
\textbf{gambiaXX.sim} & 10 & Gambia \\
\textbf{ghanaXX.sim} & 3 & Ghana \\
\textbf{tanzaniaXX.sim} & 14 & Tanzania \\
\textbf{togoXX.sim} & 11 & Togo \\
\bottomrule
\end{longtable}

All of these data files have the same structure. The variables in the data files are:

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.22}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.71}}@{}}
\toprule
\endhead
\textbf{hh} & Household identifier \\
\textbf{sex} & Sex of child (1=male, 2=female) \\
\textbf{age} & Age of child in years \\
\textbf{tfti} & Child has active (TF/TI) trachoma (0=no, 1=yes) \\
\bottomrule
\end{longtable}

Each row in these files represents a single child. For example:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"gambia09.sim"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{x[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, ]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         hh sex age tfti
## 1  4008001   1   6    1
## 2  4008001   1   3    1
## 3  4008002   1   8    1
## 4  4008002   1   6    0
## 5  4008003   1   8    0
## 6  4008003   1   1    0
## 7  4008004   1   7    0
## 8  4008004   1   4    0
## 9  4008004   1   2    0
## 10 4008004   1   2    0
\end{verbatim}

Any rapid survey method that is appropriate for general use in developing countries is restricted to sampling \texttt{households} rather than \texttt{individuals}. Sampling households in order to sample individuals violates a principal requirement for a sample to be representative of the population from which it is drawn (i.e.~that individuals are selected \texttt{independently} of each other). This lack of statistical independence amongst sampled individuals may invalidate standard approaches to selecting sampling plans leading to increased probabilities of error. This is likely to be a particular problem if cases tend to be clustered within households. Trachoma is an infectious disease that confers no lasting immunity in the host. Cases are, therefore, very likely to be clustered within households. One solution to this problem would be to sample (i.e.~at random) a single child from each of the sampled households. This is not appropriate for active trachoma as the examination procedure often causes distress to younger children. This may influence survey staff to select older children, who tend to have a lower risk of infection, for examination. Sampling is, therefore, constrained to sampling all children in selected households.

The purpose of the simulations presented here is to determine whether the LQAS method is robust to:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The loss of sampling independence introduced by sampling households at random and examining all children in selected households for active trachoma.
\end{enumerate}

And:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  The slight increase in the maximum sample size (\texttt{n}) introduced by examining all children in selected households for active trachoma.
\end{enumerate}

Each row in the datasets we will be using represents an individual child. Since we will simulate sampling households rather than individual children we need to be able to convert the datasets from one row per child to one row per household. We will write a function to do this.

Create a new function called \texttt{ind2hh()}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ind2hh }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{\}}
\end{Highlighting}
\end{Shaded}

This creates an empty function called \texttt{ind2hh()}. Use the \texttt{fix()} function to edit the \texttt{ind2hh()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(ind2hh)}
\end{Highlighting}
\end{Shaded}

Edit the function to read:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(data) \{}
\NormalTok{  n.kids }\OtherTok{\textless{}{-}}\NormalTok{ n.cases }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\NormalTok{  id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{hh)}
  \ControlFlowTok{for}\NormalTok{(household }\ControlFlowTok{in}\NormalTok{ id) \{}
\NormalTok{    temp }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(data, data}\SpecialCharTok{$}\NormalTok{hh }\SpecialCharTok{==}\NormalTok{ household)}
\NormalTok{    n.kids }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(n.kids, }\FunctionTok{nrow}\NormalTok{(temp))}
\NormalTok{    n.cases }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(n.cases, }\FunctionTok{sum}\NormalTok{(temp}\SpecialCharTok{$}\NormalTok{tfti))}
\NormalTok{  \}}
\NormalTok{  result }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(id, n.kids, n.cases))}
  \FunctionTok{return}\NormalTok{(result)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Once you have made the changes shown above, check your work, save the file, and quit the editor.

Now we have created the \texttt{ind2hh()} function we should test it for correct operation. We will create a simple test data.frame (\texttt{test.df}) for this purpose:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test.df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{),  }\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{ ,}\DecValTok{0}\NormalTok{)))}
\FunctionTok{names}\NormalTok{(test.df) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"hh"}\NormalTok{, }\StringTok{"tfti"}\NormalTok{)}
\NormalTok{test.df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   hh tfti
## 1  1    1
## 2  1    1
## 3  2    1
## 4  2    0
## 5  2    0
\end{verbatim}

The expected operation of the \texttt{ind2hh()} function given \texttt{test.df} as input is:

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.08}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 2\tabcolsep) * \real{0.15}}@{}}
\toprule
\endhead
hh & tfti \\
1 & 1 \\
1 & 1 \\
2 & 1 \\
2 & 0 \\
2 & 0 \\
\bottomrule
\end{longtable}

becomes

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.08}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.15}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.15}}@{}}
\toprule
\endhead
id & n.kids & n.case \\
1 & 2 & 2 \\
2 & 3 & 1 \\
\bottomrule
\end{longtable}

Confirm this behaviour:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test.df}
\FunctionTok{ind2hh}\NormalTok{(test.df)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   hh tfti
## 1  1    1
## 2  1    1
## 3  2    1
## 4  2    0
## 5  2    0
\end{verbatim}

\begin{verbatim}
##   id n.kids n.cases
## 1  1      2       2
## 2  2      3       1
\end{verbatim}

We can apply this function to the datasets as required. For example:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"gambia09.sim"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{x}
\NormalTok{x.hh }\OtherTok{\textless{}{-}} \FunctionTok{ind2hh}\NormalTok{(x)}
\NormalTok{x.hh}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          hh sex age tfti
## 1   4008001   1   6    1
## 2   4008001   1   3    1
## 3   4008002   1   8    1
## 4   4008002   1   6    0
## 5   4008003   1   8    0
## 6   4008003   1   1    0
## 7   4008004   1   7    0
## 8   4008004   1   4    0
## 9   4008004   1   2    0
## 10  4008004   1   2    0
## 11  4008004   1   4    0
## 12  4008005   1   1    0
## 13  4008006   1   7    0
## 14  4008006   1   5    0
## 15  4008007   1   5    0
## 16  4008007   1   9    0
## 17  4008007   1   9    0
## 18  4008008   1   9    1
## 19  4008008   1   8    0
## 20  4008008   1   1    0
## 21  4008009   1   4    1
## 22  4008009   1   2    0
## 23  4008010   1   7    1
## 24  4008010   1   7    0
## 25  4008010   1   9    0
## 26  4008010   1   2    0
## 27  4008011   1   5    0
## 28  4008011   1   8    0
## 29  4008011   1   5    0
## 30  4008012   1   9    1
## 31  4008013   1   3    1
## 32  4008013   1   7    1
## 33  4008013   1   5    1
## 34  4008013   1   2    0
## 35  4008013   1   3    0
## 36  4008013   1   7    0
## 37  4008014   1   9    1
## 38  4008014   1   1    1
## 39  4008014   1   7    1
## 40  4008015   1   5    1
## 41  4008015   1   6    1
## 42  4008015   1   1    1
## 43  4008015   1   5    1
## 44  4008015   1   7    0
## 45  4008015   1   2    0
## 46  4008015   1   9    0
## 47  4008016   1   9    1
## 48  4008016   1   7    1
## 49  4008016   1   9    1
## 50  4008016   1   4    1
## 51  4008016   1   7    1
## 52  4008016   1   5    1
## 53  4008016   1   8    1
## 54  4008017   1   5    1
## 55  4008017   1   8    0
## 56  4008018   1   5    0
## 57  4008018   1   2    0
## 58  4008019   1   4    1
## 59  4008019   1   6    0
## 60  4008020   1   1    0
## 61  4008020   1   4    1
## 62  4008020   1   2    0
## 63  4008021   1   3    0
## 64  4008021   1   7    0
## 65  4008021   1   9    1
## 66  4008021   1   2    0
## 67  4008022   1   5    0
## 68  4008022   1   8    0
## 69  4008022   1   5    0
## 70  4008023   1   6    1
## 71  4008023   1   3    1
## 72  4008024   1   2    1
## 73  4008024   1   5    1
## 74  4008024   1   2    0
## 75  4008024   1   3    0
## 76  4008024   1   8    0
## 77  4008025   1   3    0
## 78  4008025   1   8    0
## 79  4008026   1   6    1
## 80  4008026   1   8    0
## 81  4008026   1   1    0
## 82  4008026   1   7    0
## 83  4008027   1   4    0
## 84  4008027   1   7    0
## 85  4008027   1   2    0
## 86  4008027   1   2    0
## 87  4008027   1   1    0
## 88  4008028   1   4    0
## 89  4008028   1   5    0
## 90  4008028   1   7    0
## 91  4008029   1   5    0
## 92  4008029   1   3    0
## 93  4008029   1   6    0
## 94  4108001   1   6    1
## 95  4108001   1   3    1
## 96  4108002   1   8    1
## 97  4108002   1   6    0
## 98  4108003   1   8    0
## 99  4108003   1   1    0
## 100 4108004   1   7    0
## 101 4108004   1   4    0
## 102 4108004   1   2    0
## 103 4108004   1   2    0
## 104 4108004   1   4    0
## 105 4108005   1   1    0
## 106 4108006   1   7    0
## 107 4108006   1   5    0
## 108 4108007   1   5    0
## 109 4108007   1   9    0
## 110 4108007   1   9    0
## 111 4108008   1   9    1
## 112 4108008   1   8    0
## 113 4108008   1   1    0
## 114 4108009   1   4    1
## 115 4108009   1   2    0
## 116 4108010   1   7    1
## 117 4108010   1   7    0
## 118 4108010   1   9    0
## 119 4108010   1   2    0
## 120 4108011   1   5    0
## 121 4108011   1   8    0
## 122 4108011   1   5    0
## 123 4108012   1   9    1
## 124 4108013   1   3    1
## 125 4108013   1   7    1
## 126 4108013   1   5    1
## 127 4108013   1   2    0
## 128 4108013   1   3    0
## 129 4108013   1   7    0
## 130 4108014   1   9    1
## 131 4108014   1   1    1
## 132 4108014   1   7    1
## 133 4108015   1   5    1
## 134 4108015   1   6    1
## 135 4108015   1   1    1
## 136 4108015   1   5    1
## 137 4108015   1   7    0
## 138 4108015   1   2    0
## 139 4108015   1   9    0
## 140 4108016   1   9    1
## 141 4108016   1   7    1
## 142 4108016   1   9    1
## 143 4108016   1   4    1
## 144 4108016   1   7    1
## 145 4108016   1   5    1
## 146 4108016   1   8    1
## 147 4108017   1   5    1
## 148 4108017   1   8    0
## 149 4108018   1   5    0
## 150 4108018   1   2    0
## 151 4108019   1   4    1
## 152 4108019   1   6    0
## 153 4108020   1   1    0
## 154 4108020   1   4    1
## 155 4108020   1   2    0
## 156 4108021   1   3    0
## 157 4108021   1   7    0
## 158 4108021   1   9    1
## 159 4108021   1   2    0
## 160 4108022   1   5    0
## 161 4108022   1   8    0
## 162 4108022   1   5    0
## 163 4108023   1   6    1
## 164 4108023   1   3    1
## 165 4108024   1   2    1
## 166 4108024   1   5    1
## 167 4108024   1   2    0
## 168 4108024   1   3    0
## 169 4108024   1   8    0
## 170 4108025   1   3    0
## 171 4108025   1   8    0
## 172 4108026   1   6    1
## 173 4108026   1   8    0
## 174 4108026   1   1    0
## 175 4108026   1   7    0
## 176 4108027   1   4    0
## 177 4108027   1   7    0
## 178 4108027   1   2    0
## 179 4108027   1   2    0
## 180 4108027   1   1    0
## 181 4108028   1   4    0
## 182 4108028   1   5    0
## 183 4108028   1   7    0
## 184 4108029   1   5    0
## 185 4108029   1   3    0
## 186 4108029   1   6    0
## 187 4208001   1   6    1
## 188 4208001   1   3    1
## 189 4208002   1   8    1
## 190 4208002   1   6    0
## 191 4208003   1   8    0
## 192 4208003   1   1    0
## 193 4208004   1   7    0
## 194 4208004   1   4    0
## 195 4008004   1   2    0
## 196 4208004   1   2    0
## 197 4208004   1   4    0
## 198 4208005   1   1    0
## 199 4208006   1   7    0
## 200 4208006   1   5    0
## 201 4208007   1   5    0
## 202 4208007   1   9    0
## 203 4208007   1   9    0
## 204 4208008   1   9    1
## 205 4208008   1   8    0
## 206 4208008   1   1    0
## 207 4208009   1   4    1
## 208 4208009   1   2    0
## 209 4208010   1   7    1
## 210 4208010   1   7    0
## 211 4208010   1   9    0
## 212 4208010   1   2    0
## 213 4208011   1   5    0
## 214 4208011   1   8    0
## 215 4208011   1   5    0
## 216 4208012   1   9    1
## 217 4208013   1   3    1
## 218 4208013   1   7    1
## 219 4208013   1   5    1
## 220 4208013   1   2    0
## 221 4208013   1   3    0
## 222 4208013   1   7    0
## 223 4208014   1   9    1
## 224 4208014   1   1    1
## 225 4208014   1   7    1
## 226 4208015   1   5    1
## 227 4208015   1   6    1
## 228 4208015   1   1    1
## 229 4208015   1   5    1
## 230 4208015   1   7    0
## 231 4208015   1   2    0
## 232 4208015   1   9    0
## 233 4208016   1   9    1
## 234 4208016   1   7    1
## 235 4208016   1   9    1
## 236 4208016   1   4    1
## 237 4208016   1   7    1
## 238 4208016   1   5    1
## 239 4208016   1   8    1
## 240 4208017   1   5    1
## 241 4208017   1   8    0
## 242 4208018   1   5    0
## 243 4208018   1   2    0
## 244 4208019   1   4    1
## 245 4208019   1   6    0
## 246 4208020   1   1    0
## 247 4208020   1   4    1
## 248 4208020   1   2    0
## 249 4208021   1   3    0
## 250 4208021   1   7    0
## 251 4208021   1   9    1
## 252 4208021   1   2    0
## 253 4208022   1   5    0
## 254 4208022   1   8    0
## 255 4208022   1   5    0
## 256 4208023   1   6    1
## 257 4208023   1   3    1
## 258 4208024   1   2    1
## 259 4208024   1   5    1
## 260 4208024   1   2    0
## 261 4208024   1   3    0
## 262 4208024   1   8    0
## 263 4208025   1   3    0
## 264 4208025   1   8    0
## 265 4208026   1   6    1
## 266 4208026   1   8    0
## 267 4208026   1   1    0
## 268 4208026   1   7    0
## 269 4208027   1   4    0
## 270 4208027   1   7    0
## 271 4208027   1   2    0
## 272 4208027   1   2    0
## 273 4208027   1   1    0
## 274 4208028   1   4    0
## 275 4208028   1   5    0
## 276 4208028   1   7    0
## 277 4208029   1   5    0
## 278 4208029   1   3    0
## 279 4208029   1   6    0
\end{verbatim}

\begin{verbatim}
##         id n.kids n.cases
## 1  4008001      2       2
## 2  4008002      2       1
## 3  4008003      2       0
## 4  4008004      6       0
## 5  4008005      1       0
## 6  4008006      2       0
## 7  4008007      3       0
## 8  4008008      3       1
## 9  4008009      2       1
## 10 4008010      4       1
## 11 4008011      3       0
## 12 4008012      1       1
## 13 4008013      6       3
## 14 4008014      3       3
## 15 4008015      7       4
## 16 4008016      7       7
## 17 4008017      2       1
## 18 4008018      2       0
## 19 4008019      2       1
## 20 4008020      3       1
## 21 4008021      4       1
## 22 4008022      3       0
## 23 4008023      2       2
## 24 4008024      5       2
## 25 4008025      2       0
## 26 4008026      4       1
## 27 4008027      5       0
## 28 4008028      3       0
## 29 4008029      3       0
## 30 4108001      2       2
## 31 4108002      2       1
## 32 4108003      2       0
## 33 4108004      5       0
## 34 4108005      1       0
## 35 4108006      2       0
## 36 4108007      3       0
## 37 4108008      3       1
## 38 4108009      2       1
## 39 4108010      4       1
## 40 4108011      3       0
## 41 4108012      1       1
## 42 4108013      6       3
## 43 4108014      3       3
## 44 4108015      7       4
## 45 4108016      7       7
## 46 4108017      2       1
## 47 4108018      2       0
## 48 4108019      2       1
## 49 4108020      3       1
## 50 4108021      4       1
## 51 4108022      3       0
## 52 4108023      2       2
## 53 4108024      5       2
## 54 4108025      2       0
## 55 4108026      4       1
## 56 4108027      5       0
## 57 4108028      3       0
## 58 4108029      3       0
## 59 4208001      2       2
## 60 4208002      2       1
## 61 4208003      2       0
## 62 4208004      4       0
## 63 4208005      1       0
## 64 4208006      2       0
## 65 4208007      3       0
## 66 4208008      3       1
## 67 4208009      2       1
## 68 4208010      4       1
## 69 4208011      3       0
## 70 4208012      1       1
## 71 4208013      6       3
## 72 4208014      3       3
## 73 4208015      7       4
## 74 4208016      7       7
## 75 4208017      2       1
## 76 4208018      2       0
## 77 4208019      2       1
## 78 4208020      3       1
## 79 4208021      4       1
## 80 4208022      3       0
## 81 4208023      2       2
## 82 4208024      5       2
## 83 4208025      2       0
## 84 4208026      4       1
## 85 4208027      5       0
## 86 4208028      3       0
## 87 4208029      3       0
\end{verbatim}

We will now write a function that will simulate a single LQAS survey. Create a new function called \texttt{lqas.run()}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lqas.run }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{\}}
\end{Highlighting}
\end{Shaded}

This creates an empty function called \texttt{lqas.run()}.

Use the \texttt{fix()} function to edit the \texttt{lqas.run()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(lqas.run)}
\end{Highlighting}
\end{Shaded}

Edit the function to read:

Once you have made the changes shown above, check your work, save the file, and quit the editor.

We should try this function on a low, a moderate, and a high prevalence dataset. To select suitable test datasets we need to know the prevalence in each dataset:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{dir}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.sim$"}\NormalTok{)) \{}
\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(i, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(i, }\StringTok{":"}\NormalTok{, }\FunctionTok{mean}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{tfti), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## egypt01.sim : 0.5913978 
## egypt02.sim : 0.09243697 
## egypt03.sim : 0.343949 
## egypt04.sim : 0.2546584 
## egypt05.sim : 0.1354839 
## egypt06.sim : 0.6993464 
## egypt07.sim : 0.09815951 
## egypt08.sim : 0.5668449 
## egypt09.sim : 0.5251799 
## egypt10.sim : 0.4343434 
## gambia01.sim : 0.08510638 
## gambia02.sim : 0.2517483 
## gambia03.sim : 0.1730769 
## gambia04.sim : 0.1866667 
## gambia05.sim : 0.1264368 
## gambia06.sim : 0.5180952 
## gambia07.sim : 0.3876652 
## gambia08.sim : 0.310559 
## gambia09.sim : 0.3548387 
## gambia10.sim : 0.3358491 
## ghana01.sim : 0.0990099 
## ghana02.sim : 0.2162162 
## ghana03.sim : 0.2781955 
## tanzania01.sim : 0.4672897 
## tanzania02.sim : 0.4563107 
## tanzania03.sim : 0.1025641 
## tanzania04.sim : 0.1724138 
## tanzania05.sim : 0.6962963 
## tanzania06.sim : 0.3092784 
## tanzania07.sim : 0.3727273 
## tanzania08.sim : 0.4454545 
## tanzania09.sim : 0.2146893 
## tanzania10.sim : 0.5925926 
## tanzania11.sim : 0.2544379 
## tanzania12.sim : 0.5619835 
## tanzania13.sim : 0.5086207 
## tanzania14.sim : 0.4105263 
## togo01.sim : 0.254902 
## togo02.sim : 0.1692308 
## togo03.sim : 0.2147651 
## togo04.sim : 0.1265823 
## togo05.sim : 0.1098266 
## togo06.sim : 0.2677165 
## togo07.sim : 0.3244681 
## togo08.sim : 0.3125 
## togo09.sim : 0.125 
## togo10.sim : 0.04385965 
## togo11.sim : 0.08609272
\end{verbatim}

The coding scheme used for the \texttt{tfti} variable (0=no, 1=yes) allows us to use the \texttt{mean()} function to calculate prevalence in these datasets.

The pattern \texttt{"\textbackslash{}\textbackslash{}.sim\$"} is a regular expression for files ending in .sim.

If you want to use the \texttt{dir()} function to list files stored outside of the current working directory you will need to specify an appropriate value for the \texttt{path} parameter. On some systems you may also need to set the value of the \texttt{full.names} parameter to \texttt{TRUE}. For example:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{dir}\NormalTok{(}\AttributeTok{path =} \StringTok{"\textasciitilde{}/prfe"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.sim$"}\NormalTok{, }\AttributeTok{full.names =} \ConstantTok{TRUE}\NormalTok{)) \{}
\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(i, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(i, }\StringTok{":"}\NormalTok{, }\FunctionTok{mean}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{tfti), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

cycles through all files ending in \texttt{.sim} (specified by giving the value \texttt{"\textbackslash{}\textbackslash{}.sim\$"} to the \texttt{pattern} parameter) that are stored the \texttt{prfe} directory under the users home directory (specified by giving the value \texttt{"\textasciitilde{}/prfe"} to the \texttt{path} parameter) on UNIX systems. You \textbf{cannot} usefully specify a URL for the \texttt{path} parameter of the \texttt{dir()} function.

We will use \texttt{tanzania04.sim} as an example of a low prevalence dataset:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"tanzania04.sim"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{x.hh }\OtherTok{\textless{}{-}} \FunctionTok{ind2hh}\NormalTok{(x)}
\FunctionTok{lqas.run}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x.hh, }\AttributeTok{n =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \DecValTok{14}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $kids
## [1] 50
## 
## $cases
## [1] 6
## 
## $outcome
## [1] 0
\end{verbatim}

Repeat the last function call several times. Remember that previous commands can be recalled and edited using the up and down arrow keys -- they do not need to be typed out in full each time.

The function should, for most calls, return:

\begin{verbatim}
$outcome
[1] 0
\end{verbatim}

We will use \texttt{tanzania08.sim} as an example of a high prevalence dataset:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"tanzania08.sim"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{x.hh }\OtherTok{\textless{}{-}} \FunctionTok{ind2hh}\NormalTok{(x)}
\FunctionTok{lqas.run}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x.hh, }\AttributeTok{n =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \DecValTok{14}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $kids
## [1] 39
## 
## $cases
## [1] 15
## 
## $outcome
## [1] 1
\end{verbatim}

Repeat the last function call several times. The function should, for most calls, return:

\begin{verbatim}
$outcome
[1] 1
\end{verbatim}

We will use \texttt{tanzania06.sim} as an example of a moderate prevalence dataset:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"tanzania06.sim"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{x.hh }\OtherTok{\textless{}{-}} \FunctionTok{ind2hh}\NormalTok{(x)}
\FunctionTok{lqas.run}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x.hh, }\AttributeTok{n =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \DecValTok{14}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $kids
## [1] 35
## 
## $cases
## [1] 15
## 
## $outcome
## [1] 1
\end{verbatim}

Repeat the last function call several times. The function should return:

\begin{verbatim}
$outcome
[1] 0
\end{verbatim}

And:

\begin{verbatim}
$outcome
[1] 1
\end{verbatim}

In roughly equal proportion.

The simulation will require repeated sampling from the same dataset. We need to write a function to do this.

Create a new function called \texttt{lqas.simul()}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lqas.simul }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{\}}
\end{Highlighting}
\end{Shaded}

This creates an empty function called \texttt{lqas.simul()}.

Use the \texttt{fix()} function to edit the \texttt{lqas.simul()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(lqas.simul)}
\end{Highlighting}
\end{Shaded}

Edit the function to read:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(x, n, d, runs) \{}
\NormalTok{  all }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{()}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{runs) \{}
\NormalTok{    run }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{lqas.run}\NormalTok{(x, n ,d))}
\NormalTok{    all }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(all, run)}
\NormalTok{  \}}
\NormalTok{  p }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{$}\NormalTok{n.cases) }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{$}\NormalTok{n.kids)}
\NormalTok{  asn }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(all}\SpecialCharTok{$}\NormalTok{kids)}
\NormalTok{  p.high }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(all}\SpecialCharTok{$}\NormalTok{outcome)}
\NormalTok{  result }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{p =}\NormalTok{ p, }\AttributeTok{asn =}\NormalTok{ asn, }\AttributeTok{p.high =}\NormalTok{ p.high)}
  \FunctionTok{return}\NormalTok{(result)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Once you have made the changes shown above, check your work, save the file, and quit the editor.

We can test this function with the same three test datasets:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"tanzania04.sim"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{x.hh }\OtherTok{\textless{}{-}} \FunctionTok{ind2hh}\NormalTok{(x)}
\FunctionTok{lqas.simul}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x.hh, }\AttributeTok{n =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \DecValTok{14}\NormalTok{, }\AttributeTok{runs =} \DecValTok{250}\NormalTok{)}

\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"tanzania08.sim"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{x.hh }\OtherTok{\textless{}{-}} \FunctionTok{ind2hh}\NormalTok{(x)}
\FunctionTok{lqas.simul}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x.hh, }\AttributeTok{n =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \DecValTok{14}\NormalTok{, }\AttributeTok{runs =} \DecValTok{250}\NormalTok{)}

\NormalTok{x }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\StringTok{"tanzania06.sim"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{x.hh }\OtherTok{\textless{}{-}} \FunctionTok{ind2hh}\NormalTok{(x)}
\FunctionTok{lqas.simul}\NormalTok{( }\AttributeTok{x =}\NormalTok{ x.hh, }\AttributeTok{n =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \DecValTok{14}\NormalTok{, }\AttributeTok{runs =} \DecValTok{250}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $p
## [1] 0.1724138
## 
## $asn
## [1] 50.7
## 
## $p.high
## [1] 0.056
\end{verbatim}

\begin{verbatim}
## $p
## [1] 0.4454545
## 
## $asn
## [1] 34.288
## 
## $p.high
## [1] 0.98
\end{verbatim}

\begin{verbatim}
## $p
## [1] 0.3092784
## 
## $asn
## [1] 45.184
## 
## $p.high
## [1] 0.652
\end{verbatim}

The simulation consists of applying this function to each of the datasets in turn and collating the results. We will create a function to do this.

Create a new function called \texttt{main.simul()}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{main.simul }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{\}}
\end{Highlighting}
\end{Shaded}

This creates an empty function called \texttt{main.simul()}.

Use the \texttt{fix()} function to edit the \texttt{main.simul()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(main.simul)}
\end{Highlighting}
\end{Shaded}

Edit the function to read:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(n, d, runs) \{}
\NormalTok{  result }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{()}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{dir}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.sim$"}\NormalTok{)) \{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"."}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{    x }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(i, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    y }\OtherTok{\textless{}{-}} \FunctionTok{ind2hh}\NormalTok{(x)}
\NormalTok{    z }\OtherTok{\textless{}{-}} \FunctionTok{lqas.simul}\NormalTok{(y, n, d, runs)}
\NormalTok{    z}\SpecialCharTok{$}\NormalTok{file.name }\OtherTok{\textless{}{-}}\NormalTok{ i}
\NormalTok{    result }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(result, }\FunctionTok{as.data.frame}\NormalTok{(z))}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(result)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Once you have made the changes shown above, check your work, save the file, and quit the editor.

We are now ready to run the simulation:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{z1 }\OtherTok{\textless{}{-}} \FunctionTok{main.simul}\NormalTok{(}\AttributeTok{n =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \DecValTok{14}\NormalTok{, }\AttributeTok{runs =} \DecValTok{250}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ................................................
\end{verbatim}

Progress of the simulation is shown by a lengthening line of dots. Each dot represents one community screening file processed. The \texttt{\textgreater{}} prompt will be displayed when the simulation has finished running.

The returned data.frame object (\texttt{z1}) contains the results of the simulation:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{z1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             p    asn p.high      file.name
## 1  0.59139785 25.928  1.000    egypt01.sim
## 2  0.09243697 50.776  0.000    egypt02.sim
## 3  0.34394904 43.328  0.792    egypt03.sim
## 4  0.25465839 48.492  0.300    egypt04.sim
## 5  0.13548387 50.644  0.000    egypt05.sim
## 6  0.69934641 22.968  1.000    egypt06.sim
## 7  0.09815951 50.828  0.000    egypt07.sim
## 8  0.56684492 27.468  1.000    egypt08.sim
## 9  0.52517986 29.516  1.000    egypt09.sim
## 10 0.43434343 35.296  0.984    egypt10.sim
## 11 0.08510638 51.464  0.004   gambia01.sim
## 12 0.25174825 49.828  0.388   gambia02.sim
## 13 0.17307692 51.952  0.068   gambia03.sim
## 14 0.18666667 51.516  0.104   gambia04.sim
## 15 0.12643678 52.296  0.032   gambia05.sim
## 16 0.51809524 33.148  0.992   gambia06.sim
## 17 0.38766520 40.388  0.916   gambia07.sim
## 18 0.31055901 46.076  0.644   gambia08.sim
## 19 0.35483871 42.176  0.764   gambia09.sim
## 20 0.33584906 44.048  0.692   gambia10.sim
## 21 0.09900990 52.280  0.000    ghana01.sim
## 22 0.21621622 51.628  0.176    ghana02.sim
## 23 0.27819549 48.764  0.496    ghana03.sim
## 24 0.46728972 32.812  0.984 tanzania01.sim
## 25 0.45631068 33.560  0.992 tanzania02.sim
## 26 0.10256410 50.712  0.004 tanzania03.sim
## 27 0.17241379 50.652  0.020 tanzania04.sim
## 28 0.69629630 22.708  1.000 tanzania05.sim
## 29 0.30927835 45.188  0.624 tanzania06.sim
## 30 0.37272727 40.840  0.864 tanzania07.sim
## 31 0.44545455 34.372  0.992 tanzania08.sim
## 32 0.21468927 50.368  0.140 tanzania09.sim
## 33 0.59259259 26.248  1.000 tanzania10.sim
## 34 0.25443787 48.296  0.348 tanzania11.sim
## 35 0.56198347 29.028  1.000 tanzania12.sim
## 36 0.50862069 29.932  0.988 tanzania13.sim
## 37 0.41052632 37.508  0.972 tanzania14.sim
## 38 0.25490196 49.760  0.376     togo01.sim
## 39 0.16923077 55.276  0.068     togo02.sim
## 40 0.21476510 51.016  0.212     togo03.sim
## 41 0.12658228 52.096  0.012     togo04.sim
## 42 0.10982659 52.868  0.004     togo05.sim
## 43 0.26771654 48.004  0.440     togo06.sim
## 44 0.32446809 45.344  0.644     togo07.sim
## 45 0.31250000 45.352  0.680     togo08.sim
## 46 0.12500000 51.428  0.000     togo09.sim
## 47 0.04385965 52.056  0.000     togo10.sim
## 48 0.08609272 52.380  0.000     togo11.sim
\end{verbatim}

We can examine the prevalences in the test datasets:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{x11}\NormalTok{()}

\FunctionTok{hist}\NormalTok{(z1}\SpecialCharTok{$}\NormalTok{p,}
     \AttributeTok{main =} \StringTok{"Prevalence in test datasets"}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{"Proportion TF/TI"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-579-1.pdf}

If you are using a Macintosh computer then you can use \texttt{quartz()} instead of \texttt{x11()}. This will give better results.

We examine the sample size required to make classifications at different levels of prevalence as \emph{anaverage sample number} (ASN) curve:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{x11}\NormalTok{()}

\FunctionTok{plot}\NormalTok{(z1}\SpecialCharTok{$}\NormalTok{p,}
\NormalTok{     z1}\SpecialCharTok{$}\NormalTok{asn,}
     \AttributeTok{main =} \StringTok{"ASN Curve"}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{"Proportion TF/TI"}\NormalTok{,}
     \AttributeTok{ylab =} \StringTok{"Sample size required"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-581-1.pdf}

We can examine the performance of the sampling plan by plotting its \emph{operating characteristic} (OC) curve:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{x11}\NormalTok{()}

\FunctionTok{plot}\NormalTok{(z1}\SpecialCharTok{$}\NormalTok{p,}
\NormalTok{     z1}\SpecialCharTok{$}\NormalTok{p.high,}
     \AttributeTok{main =} \StringTok{"OC Curve"}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{"Proportion TF/TI"}\NormalTok{,}
     \AttributeTok{ylab =} \StringTok{"Probability"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-583-1.pdf}

Before closing the OC curve plot, we can compare the simulation results with the expected \emph{operating characteristic} (OC) curve under ideal sampling conditions:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{lines}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(z1}\SpecialCharTok{$}\NormalTok{p), }\FloatTok{0.01}\NormalTok{),}
      \FunctionTok{pbinom}\NormalTok{(}\DecValTok{14}\NormalTok{, }\DecValTok{50}\NormalTok{,}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(z1}\SpecialCharTok{$}\NormalTok{p),}\FloatTok{0.01}\NormalTok{), }\AttributeTok{lower.tail =} \ConstantTok{FALSE}\NormalTok{),}
      \AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-585-1.pdf}

The LQAS method appears to be robust to the loss of sampling variation introduced by the proposed sampling constraints. There is, however, some deviation from the expected \emph{operating characteristic} (OC) curve at lower prevalences:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{x11}\NormalTok{()}
\FunctionTok{plot}\NormalTok{(z1}\SpecialCharTok{$}\NormalTok{p, z1}\SpecialCharTok{$}\NormalTok{p.high,}
     \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.10}\NormalTok{, }\FloatTok{0.35}\NormalTok{),}
     \AttributeTok{main =} \StringTok{"OC Curve"}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{"Proportion TF/TI"}\NormalTok{,}
     \AttributeTok{ylab =} \StringTok{"Probability"}\NormalTok{)}

\FunctionTok{lines}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\FloatTok{0.10}\NormalTok{, }\FloatTok{0.35}\NormalTok{, }\FloatTok{0.01}\NormalTok{),}
      \FunctionTok{pbinom}\NormalTok{(}\DecValTok{14}\NormalTok{, }\DecValTok{50}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\FloatTok{0.10}\NormalTok{, }\FloatTok{0.35}\NormalTok{, }\FloatTok{0.01}\NormalTok{), }\AttributeTok{lower.tail =} \ConstantTok{FALSE}\NormalTok{),}
      \AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-587-1.pdf}

This deviation from the expected \emph{operating characteristic} (OC) curve is likely to be due to a few very large households in which many of the children have active trachoma. You can check this by examining the \texttt{p.high} (i.e.~the probability of a classification as high prevalence) column in \texttt{z1}, and household size and trachoma status in the individual data files that return higher than expected values for \texttt{p.high}. The \texttt{ind2hh()} function is likely to prove useful in this context.

The observed deviation from the expected \emph{operating characteristic} (OC) curve is small but it is important, in the resource-constrained context of trachoma-endemic countries, to minimise the false positive rate in order to ensure that resources are devoted to communities that need them most.

We might be able to improve the performance of the survey method in this regard by restricting the sample so that only younger children are examined. This will have the effect of reducing the number of children examined in each household. It also has the benefit of making the surveys simpler and quicker since younger children will tend to be closer to home than older children.

The range of ages in the datasets can be found using:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{dir}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.sim$"}\NormalTok{)) \{}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(i, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(i, }\StringTok{":"}\NormalTok{, }\FunctionTok{range}\NormalTok{(x}\SpecialCharTok{$}\NormalTok{age), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## egypt01.sim : 1 10 
## egypt02.sim : 2 8 
## egypt03.sim : 2 10 
## egypt04.sim : 1 10 
## egypt05.sim : 2 6 
## egypt06.sim : 2 10 
## egypt07.sim : 2 6 
## egypt08.sim : 2 10 
## egypt09.sim : 2 10 
## egypt10.sim : 2 10 
## gambia01.sim : 1 9 
## gambia02.sim : 1 9 
## gambia03.sim : 1 9 
## gambia04.sim : 1 9 
## gambia05.sim : 1 9 
## gambia06.sim : 1 9 
## gambia07.sim : 1 9 
## gambia08.sim : 1 9 
## gambia09.sim : 1 9 
## gambia10.sim : 1 9 
## ghana01.sim : 1 10 
## ghana02.sim : 1 10 
## ghana03.sim : 1 10 
## tanzania01.sim : 1 10 
## tanzania02.sim : 1 10 
## tanzania03.sim : 1 10 
## tanzania04.sim : 1 10 
## tanzania05.sim : 1 10 
## tanzania06.sim : 1 10 
## tanzania07.sim : 1 10 
## tanzania08.sim : 1 10 
## tanzania09.sim : 1 10 
## tanzania10.sim : 1 10 
## tanzania11.sim : 1 10 
## tanzania12.sim : 1 10 
## tanzania13.sim : 1 10 
## tanzania14.sim : 1 10 
## togo01.sim : 1 10 
## togo02.sim : 1 10 
## togo03.sim : 1 10 
## togo04.sim : 1 10 
## togo05.sim : 1 10 
## togo06.sim : 1 10 
## togo07.sim : 1 10 
## togo08.sim : 1 10 
## togo09.sim : 1 10 
## togo10.sim : 1 10 
## togo11.sim : 1 10
\end{verbatim}

We will investigate the effect of restricting the sample to children aged between two and five years. Use the fix() function to edit the \texttt{main.simul()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(main.simul)}
\end{Highlighting}
\end{Shaded}

Edit the function to read:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(n, d, runs) \{}
\NormalTok{  result }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{()}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{dir}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.sim$"}\NormalTok{)) \{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"."}\NormalTok{, }\AttributeTok{sep =} \StringTok{""}\NormalTok{)}
\NormalTok{    x }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(i, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    x }\OtherTok{\textless{}{-}} \FunctionTok{subset}\NormalTok{(x, age }\SpecialCharTok{\textgreater{}=} \DecValTok{2} \SpecialCharTok{\&}\NormalTok{ age }\SpecialCharTok{\textless{}=} \DecValTok{5}\NormalTok{)}
\NormalTok{    y }\OtherTok{\textless{}{-}} \FunctionTok{ind2hh}\NormalTok{(x)}
\NormalTok{    z }\OtherTok{\textless{}{-}} \FunctionTok{lqas.simul}\NormalTok{(y, n, d, runs) z}\SpecialCharTok{$}\NormalTok{file.name }\OtherTok{\textless{}{-}}\NormalTok{ i}
\NormalTok{    result }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(result, }\FunctionTok{as.data.frame}\NormalTok{(z))}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(result)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Once you have made the changes shown above, check your work, save the file, and quit the editor.

We are now ready to run the simulation again:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{z2 }\OtherTok{\textless{}{-}} \FunctionTok{main.simul}\NormalTok{(}\AttributeTok{n =} \DecValTok{50}\NormalTok{, }\AttributeTok{d =} \DecValTok{14}\NormalTok{, }\AttributeTok{runs =} \DecValTok{250}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## ................................................
\end{verbatim}

The data.frame object \texttt{z2} contains the results of the simulation:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{z2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             p    asn p.high      file.name
## 1  0.59139785 25.944  1.000    egypt01.sim
## 2  0.09243697 50.784  0.000    egypt02.sim
## 3  0.34394904 43.088  0.804    egypt03.sim
## 4  0.25465839 49.312  0.276    egypt04.sim
## 5  0.13548387 50.744  0.004    egypt05.sim
## 6  0.69934641 22.808  1.000    egypt06.sim
## 7  0.09815951 50.852  0.000    egypt07.sim
## 8  0.56684492 26.824  1.000    egypt08.sim
## 9  0.52517986 29.088  0.996    egypt09.sim
## 10 0.43434343 35.672  0.988    egypt10.sim
## 11 0.08510638 51.680  0.000   gambia01.sim
## 12 0.25174825 49.432  0.376   gambia02.sim
## 13 0.17307692 52.348  0.040   gambia03.sim
## 14 0.18666667 51.768  0.060   gambia04.sim
## 15 0.12643678 52.152  0.016   gambia05.sim
## 16 0.51809524 32.740  1.000   gambia06.sim
## 17 0.38766520 42.052  0.940   gambia07.sim
## 18 0.31055901 45.836  0.620   gambia08.sim
## 19 0.35483871 41.532  0.792   gambia09.sim
## 20 0.33584906 44.960  0.656   gambia10.sim
## 21 0.09900990 51.984  0.000    ghana01.sim
## 22 0.21621622 51.652  0.200    ghana02.sim
## 23 0.27819549 48.408  0.480    ghana03.sim
## 24 0.46728972 32.912  0.988 tanzania01.sim
## 25 0.45631068 33.332  0.996 tanzania02.sim
## 26 0.10256410 50.816  0.004 tanzania03.sim
## 27 0.17241379 50.648  0.036 tanzania04.sim
## 28 0.69629630 22.640  1.000 tanzania05.sim
## 29 0.30927835 45.512  0.628 tanzania06.sim
## 30 0.37272727 40.268  0.908 tanzania07.sim
## 31 0.44545455 34.712  0.980 tanzania08.sim
## 32 0.21468927 50.460  0.148 tanzania09.sim
## 33 0.59259259 26.164  1.000 tanzania10.sim
## 34 0.25443787 49.004  0.304 tanzania11.sim
## 35 0.56198347 29.224  1.000 tanzania12.sim
## 36 0.50862069 31.100  1.000 tanzania13.sim
## 37 0.41052632 37.432  0.968 tanzania14.sim
## 38 0.25490196 47.764  0.476     togo01.sim
## 39 0.16923077 55.668  0.080     togo02.sim
## 40 0.21476510 50.308  0.232     togo03.sim
## 41 0.12658228 52.020  0.012     togo04.sim
## 42 0.10982659 52.904  0.000     togo05.sim
## 43 0.26771654 48.052  0.412     togo06.sim
## 44 0.32446809 45.136  0.644     togo07.sim
## 45 0.31250000 45.492  0.668     togo08.sim
## 46 0.12500000 51.300  0.000     togo09.sim
## 47 0.04385965 52.088  0.000     togo10.sim
## 48 0.08609272 52.260  0.000     togo11.sim
\end{verbatim}

We can examine the performance of the sampling plan on the age-restricted datasets by plotting its \emph{operating characteristic} (OC) curve and comparing the simulation results with the expected \emph{operating characteristic} (OC) curve under ideal sampling conditions:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{x11}\NormalTok{()}

\FunctionTok{plot}\NormalTok{(z2}\SpecialCharTok{$}\NormalTok{p, z2}\SpecialCharTok{$}\NormalTok{p.high,}
     \AttributeTok{main =} \StringTok{"OC Curve"}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{"Proportion TF/TI"}\NormalTok{,}
     \AttributeTok{ylab =} \StringTok{"Probability "}\NormalTok{)}

\FunctionTok{lines}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(z2}\SpecialCharTok{$}\NormalTok{p), }\FloatTok{0.01}\NormalTok{),}
      \FunctionTok{pbinom}\NormalTok{(}\DecValTok{14}\NormalTok{, }\DecValTok{50}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(z2}\SpecialCharTok{$}\NormalTok{p), }\FloatTok{0.01}\NormalTok{), }\AttributeTok{lower.tail =} \ConstantTok{FALSE}\NormalTok{),}
      \AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-594-1.pdf}

Remember that if you are using a Macintosh computer then you can use \texttt{quartz()} instead of \texttt{x11()}. This will give better results.

We should also take a closer look at the range of prevalences where the deviation from the expected \emph{operating characteristic} (OC) curve was largest and most problematic in the previous simulation:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{x11}\NormalTok{()}

\FunctionTok{plot}\NormalTok{(z2}\SpecialCharTok{$}\NormalTok{p, z2}\SpecialCharTok{$}\NormalTok{p.high,}
     \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.10}\NormalTok{, }\FloatTok{0.35}\NormalTok{),}
     \AttributeTok{main =} \StringTok{"OC Curve"}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{"Proportion TF/TI"}\NormalTok{,}
     \AttributeTok{ylab =} \StringTok{"Probability"}\NormalTok{)}

\FunctionTok{lines}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\FloatTok{0.10}\NormalTok{, }\FloatTok{0.35}\NormalTok{, }\FloatTok{0.01}\NormalTok{),}
      \FunctionTok{pbinom}\NormalTok{(}\DecValTok{14}\NormalTok{, }\DecValTok{50}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\FloatTok{0.10}\NormalTok{, }\FloatTok{0.35}\NormalTok{, }\FloatTok{0.01}\NormalTok{), }\AttributeTok{lower.tail =} \ConstantTok{FALSE}\NormalTok{),}
      \AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-596-1.pdf}

We can compare the behaviour of the sampling plan in the unrestricted and age-restricted datasets:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{x11}\NormalTok{()}

\FunctionTok{plot}\NormalTok{(z1}\SpecialCharTok{$}\NormalTok{p, z1}\SpecialCharTok{$}\NormalTok{p.high,}
     \AttributeTok{main =} \StringTok{""}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{""}\NormalTok{,}
     \AttributeTok{ylab =} \StringTok{""}\NormalTok{,}
     \AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{,}
     \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.8}\NormalTok{))}

\FunctionTok{par}\NormalTok{(}\AttributeTok{new =} \ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{plot}\NormalTok{(z2}\SpecialCharTok{$}\NormalTok{p, z2}\SpecialCharTok{$}\NormalTok{p.high,}
     \AttributeTok{main =} \StringTok{"OC Curve"}\NormalTok{,}
     \AttributeTok{xlab =} \StringTok{"Proportion TF/TI"}\NormalTok{,}
     \AttributeTok{ylab =} \StringTok{"Probability"}\NormalTok{,}
     \AttributeTok{xlim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.8}\NormalTok{),}
     \AttributeTok{pch =} \DecValTok{3}\NormalTok{)}
   
\FunctionTok{lines}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.01}\NormalTok{),}
      \FunctionTok{pbinom}\NormalTok{(}\DecValTok{14}\NormalTok{, }\DecValTok{50}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.01}\NormalTok{), }\AttributeTok{lower.tail =} \ConstantTok{FALSE}\NormalTok{),}
      \AttributeTok{lty =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Restricting the sample to children aged between two and five years (inclusive) appears to have improved the behaviour of the survey method by lowering the false positive rate to close to expected behaviour under ideal sampling condition. Process simulation has allowed us to improve the performance of the survey method without expensive and lengthy field-work. In practice, the method would now be validated in the field probably by repeated sampling of communities in which prevalence is known from house-to-house screening.

\hypertarget{cellular-automata-machines}{%
\section{Cellular automata machines}\label{cellular-automata-machines}}

\emph{Cellular automata machines} are simple computing devices that are commonly used to simulate social, biological, and physical processes. Despite their simplicity, cellular automata machines are general purpose computing devices. This means that they may be used for any \emph{computable} problem.

The way that problems are specified to cellular automata machines make them simple to program for some types of problem and difficult to program for other types of problem. In this exercise we will explore the use of cellular automata machines to create a simple model of epidemic spread.

Cellular automata machines model a universe in which space is represented by a uniform grid, time advances in steps, and the laws of the universe are represented by a set of rules which compute the future state of each cell of the grid from its current state and from the current state of its neighbouring cells.

Typically, a cellular automata machine has the following features:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  It consists of a large number of identical cells arranged in a regular grid. The grid is a two-dimensional projection of a torus (a ring-doughnut shaped surface) and has no edges.
\item
  Each cell can be in one of a limited number of states.
\item
  Time advances through the simulation in steps. At each time-step, the state of a cell may change.
\item
  The state of a cell after each time-step is determined by a set of rules that define how the future state of a cell depends on the current state of the cell and the current state of its immediate neighbours. This set of rules is used to update the state of every cell in the grid at each time-step. Since the rules refer only to the state of an individual cell and its immediate neighbours, cellular automata machines are best suited to modelling situations where local interactions give rise to global phenomena.
\end{enumerate}

In this exercise we will simulate a cellular automata machine using \texttt{R} and then use the simulated machine to simulate epidemic spread. We will use three functions to simulate the cellular automata machine (CAM):

\begin{itemize}
\item
  \textbf{cam.run():} This function will display the initial state of the CAM, examine each cell in the CAM grid, apply the CAM rule-set to each cell, update the CAM grid, and display the state of the CAM at each time-step.
\item
  \textbf{cam.state.display():} This function will display the state of the CAM at each time-step. It will be implemented using the \texttt{image()} function to plot the contents of matrices held in the \texttt{cam.state} list object (see below). This function will be developed as we refine the epidemic model.
\item
  \textbf{cam.rule():} This function will contain the rule-set. It will be implemented using \texttt{ifelse()} functions to codify rules. This function will also be developed as we refine the epidemic model.
\end{itemize}

The current and future states of the CAM will be held in two \emph{global} list objects:

\begin{itemize}
\item
  \textbf{cam.state:} This object will contain the current state of the CAM and must contain a matrix object
  called grid.
\item
  \textbf{cam.state.new:} This object will contain the the state of the CAM at the next time-step as defined
  by the the rule-set.
\end{itemize}

Other \emph{global} objects will be defined as required.

Create a new function called \texttt{cam.run():}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cam.run }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{\}}
\end{Highlighting}
\end{Shaded}

This creates an empty function called \texttt{cam.run()}.

Use the \texttt{fix()} function to edit the \texttt{cam.run()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(cam.run)}
\end{Highlighting}
\end{Shaded}

Edit the function to read:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(steps) \{}
\NormalTok{  cam.state.new }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ cam.state}
  \FunctionTok{cam.state.display}\NormalTok{(}\AttributeTok{t =} \DecValTok{0}\NormalTok{)}
\NormalTok{  mx }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{grid)}
\NormalTok{  my }\OtherTok{\textless{}{-}} \FunctionTok{ncol}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{grid)}
  \ControlFlowTok{for}\NormalTok{(t }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{steps) \{}
    \ControlFlowTok{for}\NormalTok{(y }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{my) \{}
      \ControlFlowTok{for}\NormalTok{(x }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{mx) \{}
\NormalTok{        V }\OtherTok{\textless{}{-}}\NormalTok{ cam.state}\SpecialCharTok{$}\NormalTok{grid[x, y]}
\NormalTok{        N }\OtherTok{\textless{}{-}}\NormalTok{ cam.state}\SpecialCharTok{$}\NormalTok{grid[x, }\FunctionTok{ifelse}\NormalTok{(y }\SpecialCharTok{==} \DecValTok{1}\NormalTok{, my, y }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)]}
\NormalTok{        S }\OtherTok{\textless{}{-}}\NormalTok{ cam.state}\SpecialCharTok{$}\NormalTok{grid[x, }\FunctionTok{ifelse}\NormalTok{(y }\SpecialCharTok{==}\NormalTok{ my, }\DecValTok{1}\NormalTok{, y }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)]}
\NormalTok{        E }\OtherTok{\textless{}{-}}\NormalTok{ cam.state}\SpecialCharTok{$}\NormalTok{grid[}\FunctionTok{ifelse}\NormalTok{(x }\SpecialCharTok{==}\NormalTok{ mx, }\DecValTok{1}\NormalTok{, x }\SpecialCharTok{+} \DecValTok{1}\NormalTok{), y]}
\NormalTok{        W }\OtherTok{\textless{}{-}}\NormalTok{ cam.state}\SpecialCharTok{$}\NormalTok{grid[}\FunctionTok{ifelse}\NormalTok{(x }\SpecialCharTok{==} \DecValTok{1}\NormalTok{, mx, x }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{), y]}
        \FunctionTok{cam.rule}\NormalTok{(V, N, S, E, W, x, y, t)}
\NormalTok{        \}}
\NormalTok{      \}}
\NormalTok{      cam.state }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ cam.state.new}
      \FunctionTok{cam.state.display}\NormalTok{(t)}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Once you have made the changes shown above, check your work, save the file, and quit the

Note that when we assign anything to the state of the CAM (held in \texttt{cam.state} and \texttt{cam.state.new}) we use the \texttt{\textless{}\textless{}-} (instead of the usual \texttt{\textless{}-}) assignment operator. This operator allows assignment to objects outside of the function in the global environment.

Objects that are stored in the \emph{global} environment are available to all functions.

Create a new function called \texttt{cam.state.display()}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cam.state.display }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{\}}
\end{Highlighting}
\end{Shaded}

This creates an empty function called \texttt{cam.state.display()}.

Use the \texttt{fix()} function to edit the \texttt{cam.state.display()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(cam.state.display)}
\end{Highlighting}
\end{Shaded}

Edit the function to read:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(t) \{}
  \ControlFlowTok{if}\NormalTok{(t }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
    \FunctionTok{x11}\NormalTok{(); }\FunctionTok{par}\NormalTok{(}\AttributeTok{pty =} \StringTok{"s"}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{image}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{grid, }\AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Infected at :"}\NormalTok{, t),}
        \AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"wheat"}\NormalTok{, }\StringTok{"navy"}\NormalTok{), }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Remember that if you are using a Macintosh computer then you can use \texttt{quartz()} instead of \texttt{x11()}. This will give better results.

Once you have made the changes shown above, check your work, save the file, and quit the editor.

The \texttt{cam.rule()} function contains the rules of the CAM universe.

We will start with a very simple \emph{infection} rule:

\begin{itemize}
\item
  Each cell can be either \emph{infected} or \emph{not-infected}.
\item
  If a cell is already \emph{infected} it will remain \emph{infected}.
\item
  If a cell is \emph{not-infected} then it will change its state to \emph{infected} based on the state of its neighbours: If a neighbouring cell is \emph{infected} it will infect the cell with a fixed probability or \emph{transmission} pressure.
\end{itemize}

Create a new function called \texttt{cam.rule()}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cam.rule }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{\}}
\end{Highlighting}
\end{Shaded}

This creates an empty function called \texttt{cam.rule()}. Use the \texttt{fix()} function to edit the \texttt{cam.rule()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(cam.rule)}
\end{Highlighting}
\end{Shaded}

Edit the function to read:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(V, N, S, E, W, x, y, t) \{}
\NormalTok{  tp }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(N, S, E, W) }\SpecialCharTok{*} \FunctionTok{rbinom}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, TP)}
\NormalTok{  cam.state.new}\SpecialCharTok{$}\NormalTok{grid[x, y] }\OtherTok{\textless{}\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(V }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{|} \FunctionTok{sum}\NormalTok{(tp) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Once you have made the changes shown above, check your work, save the file, and quit the editor. The basic CAM machine is now complete.

We need to specify a value for the transmission pressure (\texttt{TP}):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{TP }\OtherTok{\textless{}{-}} \FloatTok{0.2}
\end{Highlighting}
\end{Shaded}

And define the initial state of the CAM:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cases }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{cases[}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{cam.state }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{grid =}\NormalTok{ cases)}
\end{Highlighting}
\end{Shaded}

We can now run the simulation:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cam.run}\NormalTok{(}\AttributeTok{steps =} \DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The number of infected cells is:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sum}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{grid)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

We can use this model to investigate the effect of different transmission pressures by systematically altering the transmission pressure specified in \texttt{TP}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cases }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{cases[}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{cam.state.initial }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{grid =}\NormalTok{ cases)}
\NormalTok{pressure }\OtherTok{\textless{}{-}} \FunctionTok{vector}\NormalTok{(}\AttributeTok{mode =} \StringTok{"numeric"}\NormalTok{)}
\NormalTok{infected }\OtherTok{\textless{}{-}} \FunctionTok{vector}\NormalTok{(}\AttributeTok{mode =} \StringTok{"numeric"}\NormalTok{)}
   
\ControlFlowTok{for}\NormalTok{(TP }\ControlFlowTok{in} \FunctionTok{seq}\NormalTok{(}\FloatTok{0.05}\NormalTok{, }\FloatTok{0.25}\NormalTok{, }\FloatTok{0.05}\NormalTok{)) \{}
\NormalTok{  cam.state }\OtherTok{\textless{}{-}}\NormalTok{ cam.state.initial}
  \FunctionTok{cam.run}\NormalTok{(}\AttributeTok{steps =} \DecValTok{20}\NormalTok{)}
  \FunctionTok{graphics.off}\NormalTok{()}
\NormalTok{  pressure }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(pressure, TP)}
\NormalTok{  infected }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(infected, }\FunctionTok{sum}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{grid))}
\NormalTok{  \}}

\FunctionTok{plot}\NormalTok{(pressure, infected)}
\end{Highlighting}
\end{Shaded}

In practice we would run the simulation many times for each transmission pressure and plot (e.g.) the median number of infected cells found at the end of each run of the model.

We can extend the model to include host immunity by specifying a new layer of cells (i.e.~for host immunity) and modifying the CAM rule-set appropriately.

Use the \texttt{fix()} function to edit the \texttt{cam.rule()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(cam.rule)}
\end{Highlighting}
\end{Shaded}

Edit the function to read:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(V, N, S, E, W, x, y, t) \{}
\NormalTok{  tp }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(N, S, E, W) }\SpecialCharTok{*} \FunctionTok{rbinom}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, TP)}
\NormalTok{  cam.state.new}\SpecialCharTok{$}\NormalTok{grid[x, y] }\OtherTok{\textless{}\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(V }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{|}\NormalTok{ (}\FunctionTok{sum}\NormalTok{(tp) }\SpecialCharTok{\textgreater{}} \DecValTok{0} \SpecialCharTok{\&}\NormalTok{ cam.state}\SpecialCharTok{$}\NormalTok{immune[x, y] }\SpecialCharTok{!=} \DecValTok{1}\NormalTok{), }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Once you have made the changes shown above, check your work, save the file, and quit the editor.

We need to specify values for the transmission pressure (\texttt{TP}) and the proportion of the population that is immune (\texttt{IM}):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{TP }\OtherTok{\textless{}{-}} \FloatTok{0.2}
\NormalTok{IM }\OtherTok{\textless{}{-}} \FloatTok{0.4}
\end{Highlighting}
\end{Shaded}

And define the initial state of the CAM:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cases }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{cases[}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{immune }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{rbinom}\NormalTok{(}\DecValTok{361}\NormalTok{, }\DecValTok{1}\NormalTok{, IM), }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{immune[}\DecValTok{10}\NormalTok{,}\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{cam.state }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{grid =}\NormalTok{ cases, }\AttributeTok{immune =}\NormalTok{ immune)}
\end{Highlighting}
\end{Shaded}

We can display the distribution of immune cells using the \texttt{image()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{image}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{immune, }\AttributeTok{main =} \StringTok{"Immune"}\NormalTok{,}
      \AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"wheat"}\NormalTok{, }\StringTok{"navy"}\NormalTok{), }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-620-1.pdf}

We can now run the simulation:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cam.run}\NormalTok{(}\AttributeTok{steps =} \DecValTok{30}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The number of infected cells is:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sum}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{grid)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

A better summary is the proportion of susceptible (i.e.~non-immune) cells that become infected during a run:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sum}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{grid) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{361} \SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{immune))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.005
\end{verbatim}

We can use this model to investigate the effect of different proportions of the population that are immune by systematically altering the value assigned to \texttt{IM}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{immune.p }\OtherTok{\textless{}{-}} \FunctionTok{vector}\NormalTok{(}\AttributeTok{mode =} \StringTok{"numeric"}\NormalTok{)}
\NormalTok{infected.p }\OtherTok{\textless{}{-}} \FunctionTok{vector}\NormalTok{(}\AttributeTok{mode =} \StringTok{"numeric"}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{(IM }\ControlFlowTok{in} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{0.8}\NormalTok{, }\FloatTok{0.05}\NormalTok{)) \{}
\NormalTok{  cases }\OtherTok{\textless{}{-}}  \FunctionTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{  cases[}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{  immune }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{rbinom}\NormalTok{(}\DecValTok{361}\NormalTok{, }\DecValTok{1}\NormalTok{, IM), }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{  immune[}\DecValTok{10}\NormalTok{,}\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{  cam.state }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{grid =}\NormalTok{ cases, }\AttributeTok{immune =}\NormalTok{ immune)}
  \FunctionTok{cam.run}\NormalTok{(}\AttributeTok{steps =} \DecValTok{30}\NormalTok{)}
  \FunctionTok{graphics.off}\NormalTok{()}
\NormalTok{  immune.p }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(immune.p, }\FunctionTok{sum}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{immune) }\SpecialCharTok{/} \DecValTok{361}\NormalTok{)}
\NormalTok{  infected.p }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(infected.p,}
                  \FunctionTok{sum}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{grid) }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{361} \SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{immune)))}
\NormalTok{\}}

\FunctionTok{plot}\NormalTok{(immune.p, infected.p)}
\end{Highlighting}
\end{Shaded}

In practice we would run the simulation many times for each value of \texttt{IM} and plot (e.g.) the median proportion of susceptible (i.e.~non-immune) cells that become infected.

A simple modification to this model would be to record the time-step at which individual cells become infected.
We can do this by adding a new layer of cells (i.e.~to record the time-step at which a cell becomes infected) and modifying the CAM rule-set appropriately.

Use the \texttt{fix()} function to edit the \texttt{cam.rule()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(cam.rule)}
\end{Highlighting}
\end{Shaded}

Edit the function to read:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(V, N, S, E, W, x, y, t) \{}
\NormalTok{  tp }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(N, S, E, W) }\SpecialCharTok{*} \FunctionTok{rbinom}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, TP)}
\NormalTok{  cam.state.new}\SpecialCharTok{$}\NormalTok{grid[x, y] }\OtherTok{\textless{}\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(V }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{|}\NormalTok{ (}\FunctionTok{sum}\NormalTok{(tp) }\SpecialCharTok{\textgreater{}} \DecValTok{0} \SpecialCharTok{\&}\NormalTok{ cam.state}\SpecialCharTok{$}\NormalTok{immune[x, y] }\SpecialCharTok{!=} \DecValTok{1}\NormalTok{), }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{(V }\SpecialCharTok{!=} \DecValTok{1} \SpecialCharTok{\&}\NormalTok{ cam.state.new}\SpecialCharTok{$}\NormalTok{grid[x, y] }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
\NormalTok{    cam.state.new}\SpecialCharTok{$}\NormalTok{ti[x, y] }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ t}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Once you have made the changes shown above, check your work, save the file, and quit the editor.

We need to specify values for the transmission pressure (\texttt{TP}) and the proportion of the population that is immune (\texttt{IM}):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{TP }\OtherTok{\textless{}{-}} \FloatTok{0.2}
\NormalTok{IM }\OtherTok{\textless{}{-}} \FloatTok{0.4}
\end{Highlighting}
\end{Shaded}

And define the initial state of the CAM:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cases }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{cases[}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{immune }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{rbinom}\NormalTok{(}\DecValTok{361}\NormalTok{, }\DecValTok{1}\NormalTok{, IM), }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{immune[}\DecValTok{10}\NormalTok{,}\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{ti }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{ti[}\DecValTok{10}\NormalTok{,}\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{cam.state }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{grid =}\NormalTok{ cases, }\AttributeTok{immune =}\NormalTok{ immune, }\AttributeTok{ti =}\NormalTok{ ti)}
\end{Highlighting}
\end{Shaded}

We can now run the simulation:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cam.run}\NormalTok{(}\AttributeTok{steps =} \DecValTok{120}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Recording the time-step at which individual cells become infected allows us to plot an epidemic curve from the model:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{x11}\NormalTok{()}
\FunctionTok{hist}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{ti)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-632-1.pdf}

Remember, if you are using a Macintosh computer then you can use \texttt{quartz()} instead of \texttt{x11()}. This will give better results.

The \texttt{image()} function can provide an alternative view of the same data:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{image}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{ti, }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{prfe_files/figure-latex/unnamed-chunk-633-1.pdf}

The colour of each cell reflects the time-step of infection (i.e.~the darker cells were infected before the lighter cells).

The CAM models that we have developed are general models of an infectious phenomenon. They could, for example, be models of the spread of an item of gossip, a forest fire, or an ink-spot. They are, however, poorly specified models for the epidemic spread of an infectious disease. In particular, they assume that a cell is infectious to other cells immediately after infection, that an infected cell never loses its ability to infect other cells, recovery never takes place, and immunity is never acquired. These deficits in the models may be addressed by appropriate modification of the CAM rule-set.

A simple and useful model of epidemic spread is the \emph{SIR} model. The letters in \emph{SIR} refer to the three states that influence epidemic spread that an individual can exist in. The three states are \textbf{S}usceptible, \textbf{I}nfectious, and \textbf{R}ecovered.

We will now modify our CAM model to follow the \emph{SIR} model using the following parameters:

\begin{itemize}
\item
  \textbf{Susceptible}: A cell may be immune or non-immune. A cell may be immune prior to the epidemic or
  acquire immunity fourteen time-steps after infection. Once a cell is immune it remains immune.
\item
  \textbf{Infectious}: An infected cell is infectious from eight to fourteen time-steps after being infected.
\item
  \textbf{Recovered}: A cell is clinically sick from ten to twenty time-steps after being infected. If one time-step is taken to equal one day, these parameters provide a coarse simulation of the course of a measles infection.
\end{itemize}

Use the \texttt{fix()} function to edit the \texttt{cam.rule()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(cam.rule)}
\end{Highlighting}
\end{Shaded}

Edit the function to read:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(V, N, S, E, W, x, y, t) \{}
\NormalTok{  tsi }\OtherTok{\textless{}{-}}\NormalTok{ t }\SpecialCharTok{{-}}\NormalTok{ cam.state}\SpecialCharTok{$}\NormalTok{ti[x, y]}
\NormalTok{  cam.state.new}\SpecialCharTok{$}\NormalTok{grid[x, y] }\OtherTok{\textless{}\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(tsi }\SpecialCharTok{\%in\%}\NormalTok{ INFECTIOUS, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{  cam.state.new}\SpecialCharTok{$}\NormalTok{cf[x, y] }\OtherTok{\textless{}\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(tsi }\SpecialCharTok{\%in\%}\NormalTok{ CLINICAL, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{  cam.state.new}\SpecialCharTok{$}\NormalTok{immune[x, y] }\OtherTok{\textless{}\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(tsi) }\SpecialCharTok{\&}\NormalTok{  tsi }\SpecialCharTok{\textgreater{}}\NormalTok{ IMMUNITY, }\DecValTok{1}\NormalTok{, cam.state}\SpecialCharTok{$}\NormalTok{immune[x,y])}
     
  \ControlFlowTok{if}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{infected[x, y] }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
\NormalTok{    cam.state.new}\SpecialCharTok{$}\NormalTok{infected[x, y] }\OtherTok{\textless{}\textless{}{-}} \DecValTok{1}
\NormalTok{    cam.state.new}\SpecialCharTok{$}\NormalTok{ti[x, y] }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ cam.state}\SpecialCharTok{$}\NormalTok{ti[x, y]}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    tp }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(N, S, E, W) }\SpecialCharTok{*} \FunctionTok{rbinom}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, TP)}
    
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{sum}\NormalTok{(tp) }\SpecialCharTok{\textgreater{}} \DecValTok{0} \SpecialCharTok{\&}\NormalTok{ cam.state}\SpecialCharTok{$}\NormalTok{immune[x, y] }\SpecialCharTok{!=} \DecValTok{1}\NormalTok{) \{}
\NormalTok{      cam.state.new}\SpecialCharTok{$}\NormalTok{infected[x, y] }\OtherTok{\textless{}\textless{}{-}} \DecValTok{1}
\NormalTok{      cam.state.new}\SpecialCharTok{$}\NormalTok{ti[x, y] }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ t}
\NormalTok{    \}}
\NormalTok{  \} }
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Once you have made the changes shown above, check your work, save the file, and quit the editor.

It will also be useful to have a more detailed report of the state of the CAM at each time-step.

Use the \texttt{fix()} function to edit the \texttt{cam.state.display()} function:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{fix}\NormalTok{(cam.state.display)}
\end{Highlighting}
\end{Shaded}

Edit the function to read:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{function}\NormalTok{(t) \{}
  \ControlFlowTok{if}\NormalTok{(t }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
    \FunctionTok{x11}\NormalTok{(}\AttributeTok{width =} \DecValTok{9}\NormalTok{, }\AttributeTok{height =} \DecValTok{9}\NormalTok{)}
    \FunctionTok{par}\NormalTok{(}\AttributeTok{mfrow =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
    \FunctionTok{par}\NormalTok{(}\AttributeTok{pty =} \StringTok{"s"}\NormalTok{)}
\NormalTok{  \}}
     
  \FunctionTok{image}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{grid,}
        \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Infectious at :"}\NormalTok{, t),}
        \AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"wheat"}\NormalTok{, }\StringTok{"navy"}\NormalTok{), }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
     
  \FunctionTok{image}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{cf,}
        \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Clinical at :"}\NormalTok{, t),}
        \AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"wheat"}\NormalTok{, }\StringTok{"navy"}\NormalTok{), }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
     
  \FunctionTok{image}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{ti,}
        \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Infected at :"}\NormalTok{, t), }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
     
  \FunctionTok{image}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{immune,}
        \AttributeTok{main =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Immune at :"}\NormalTok{, t),}
        \AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"wheat"}\NormalTok{, }\StringTok{"navy"}\NormalTok{), }\AttributeTok{axes =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

Remember, if you are using a Macintosh computer then you can use \texttt{quartz()} instead of \texttt{x11()}. This will give better results.

Once you have made the changes shown above, check your work, save the file, and quit the editor.

We need to specify values for the transmission pressure (\texttt{TP}) and the proportion of the population that is
immune (\texttt{IM}):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{TP }\OtherTok{\textless{}{-}} \FloatTok{0.2}
\NormalTok{IM }\OtherTok{\textless{}{-}} \FloatTok{0.2}
\end{Highlighting}
\end{Shaded}

And the \emph{SIR} parameters:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{CLINICAL }\OtherTok{\textless{}{-}} \DecValTok{10}\SpecialCharTok{:}\DecValTok{20}
\NormalTok{INFECTIOUS }\OtherTok{\textless{}{-}} \DecValTok{8}\SpecialCharTok{:}\DecValTok{14}
\NormalTok{IMMUNITY }\OtherTok{\textless{}{-}} \DecValTok{14}
\end{Highlighting}
\end{Shaded}

And define the initial state of the CAM:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{infected }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{infected[}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{ti }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{ti[}\DecValTok{10}\NormalTok{,}\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{infectious }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{immune }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{rbinom}\NormalTok{(}\DecValTok{361}\NormalTok{, }\DecValTok{1}\NormalTok{, IM), }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{immune[}\DecValTok{10}\NormalTok{,}\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{cf }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{cam.state }\OtherTok{\textless{}{-}}  \FunctionTok{list}\NormalTok{(}\AttributeTok{grid =}\NormalTok{ infectious, }\AttributeTok{infected =}\NormalTok{ infected, }\AttributeTok{ti =}\NormalTok{ ti,}
                   \AttributeTok{immune =}\NormalTok{ immune, }\AttributeTok{cf =}\NormalTok{ cf)}
\end{Highlighting}
\end{Shaded}

We should also record the number of susceptible cells for later use:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{susceptibles }\OtherTok{\textless{}{-}} \DecValTok{361} \SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{immune)}
\end{Highlighting}
\end{Shaded}

We can now run the simulation:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cam.run}\NormalTok{(}\AttributeTok{steps =} \DecValTok{200}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

We can now calculate the proportion of susceptible (i.e.~non-immune) cells that become infected:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sum}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{infected) }\SpecialCharTok{/}\NormalTok{ susceptibles}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.003558719
\end{verbatim}

We can use this model to test the effect of an intervention such as isolating an infected cell for a short period after clinical features first appear. We can do this, imperfectly because it does not allow us to specify compliance, by shortening the infectious period to include only the non-symptomatic time-steps and one time- step after clinical features have appeared:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{INFECTIOUS }\OtherTok{\textless{}{-}} \DecValTok{8}\SpecialCharTok{:}\DecValTok{11}
\end{Highlighting}
\end{Shaded}

resetting the initial state of the CAM:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{infected }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{infected[}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{ti }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\ConstantTok{NA}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{ti[}\DecValTok{10}\NormalTok{,}\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{infectious }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{immune }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{rbinom}\NormalTok{(}\DecValTok{361}\NormalTok{, }\DecValTok{1}\NormalTok{, IM), }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{immune[}\DecValTok{10}\NormalTok{,}\DecValTok{10}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{cf }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\DecValTok{0}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{19}\NormalTok{, }\AttributeTok{ncol =} \DecValTok{19}\NormalTok{)}
\NormalTok{cam.state }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{grid =}\NormalTok{ infectious, }\AttributeTok{infected =}\NormalTok{ infected, }\AttributeTok{ti =}\NormalTok{ ti,}
                  \AttributeTok{immune =}\NormalTok{ immune, }\AttributeTok{cf =}\NormalTok{ cf)}
\end{Highlighting}
\end{Shaded}

Recording the number of susceptible cells:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{susceptibles }\OtherTok{\textless{}{-}} \DecValTok{361} \SpecialCharTok{{-}} \FunctionTok{sum}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{immune)}
\end{Highlighting}
\end{Shaded}

Running the simulation:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cam.run}\NormalTok{(}\AttributeTok{steps =} \DecValTok{200}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

And recalculating the proportion of susceptible (i.e.~non-immune) cells that become infected:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sum}\NormalTok{(cam.state}\SpecialCharTok{$}\NormalTok{infected) }\SpecialCharTok{/}\NormalTok{ susceptibles}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.003571429
\end{verbatim}

We have developed a simple but realistic model of epidemic spread using a cellular automata machine. Such a model could be used to investigate the relative effect of model parameters (e.g.~initial proportion immune, initial number of infective cells, transmission pressure, etc.) on epidemic spread by changing a single parameter at a time and running the simulation. Since the model is \emph{stochastic}, the effect of each parameter change would be simulated many times and suitable summaries calculated.

The model could be improved by, for example:

\begin{itemize}
\item
  Allowing for an \emph{open population} with births (or immigration) and deaths (or emigration). This could be implemented by allowing immune cells to become susceptible after a specified number of time-steps. The ratio of births to deaths could then be modelled as the ratio of the length of the infectious period to the length of the immune period.
\item
  Specifying a non-uniform distribution of transmission pressure during the infectious period.
\item
  Allowing for individual variation in susceptibility.
\item
  Allowing for individual variation in the duration of the infectious period.
\item
  Simulating a non-uniform population density by allowing cells to be empty. Note that an immune cell is the same as an empty cell in the current model.
\item
  Simulating a clustered distribution of immunity in the initial state of the CAM.
\item
  Allowing a small proportion of infections to be infectious without exhibiting clinical features.
\item
  Specifying rules that are applied at different time-points such as introducing isolation only after a certain number of clinical cases have appeared (i.e.~after an epidemic has been detected).
\item
  Allowing the coverage of interventions (e.g.~the coverage of a vaccination campaign or compliance with isolation instructions) that are introduced after an epidemic has been detected to be specified.
\item
  Simulating a more complex social structure. This could be implemented by allowing cells to belong to one of a finite set of castes with different initial conditions (e.g.~immunity) and having rules that specify the level of interaction (i.e.~the transmission pressure) between members of separate castes and the levels of intervention coverage achievable in the separate castes.
\item
  Extending the neighbourhood definition by using the corner (i.e.~north-east, south-east, south-west, and north-west) cells as neighbours for consideration in the CAM rule-set.
\end{itemize}

We can now quit \texttt{R}:

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{q}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

For this exercise there is no need to save the workspace image so click the \textbf{No} button (GUI) or enter \texttt{n} when prompted to save the workspace image (terminal).

\hypertarget{summary-8}{%
\section{Summary}\label{summary-8}}

\begin{itemize}
\item
  Computer intensive methods provide an alternative to classical statistical techniques for both estimation and statistical hypothesis testing. They have the advantage of being simple to implement and they remain simple even with complex estimators.
\item
  Computer based simulation can simulate both data and processes. Process simulations maybe arbitrarily complex. Process simulation is a useful development tool that can save considerable time and expense when developing systems and methods.
\item
  Process simulation can also be used to model complex social phenomena such as epidemic spread. Such simulations allow (e.g.) the the relative efficacy of interventions to be evaluated.
\item
  \texttt{R} provides functions that allow you to implement computer intensive methods such as the bootstrap and computer based simulation.
\end{itemize}

\hypertarget{what-now}{%
\chapter*{What now?}\label{what-now}}
\addcontentsline{toc}{chapter}{What now?}

Now that you have had a taste of using \texttt{R} you will be able to decide whether it meets your requirements for a data-analysis system.

The file \texttt{R-intro.pdf} which is installed with the \texttt{R} system contains the document \emph{`An Introduction to \texttt{R}'}. This document provides a solid introduction to \texttt{R}.

The file \texttt{refman.pdf} which is also installed with the \texttt{R} system contains the document \emph{`The \texttt{R} reference index'}. This document provides a complete function-by-function reference to the \texttt{R} base system and several standard function libraries (packages).

Other documents are available from the \texttt{R} Website: \url{http://www.r-project.org/}

  \bibliography{book.bib}

\end{document}
